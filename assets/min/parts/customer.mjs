import{SPLITER}from"../parts/tools.mjs";import{AutoInput}from"../parts/autocomplete.mjs";import{table_data,table_init,fetch_table}from"../parts/table.mjs";import*as service from"../parts/service.mjs";import{close_modal,modal_init}from"./modal.mjs";import{notifier}from"../parts/notifier.mjs";var customer_data={input:document.querySelector("#supplier-input"),button:document.querySelector("#supplier-serach"),auto_url:"/customer_auto",cate:document.querySelector("#customer-suplier"),info:document.querySelector("#supplier-info")};export var out_data={};export function customer_init(data){Object.assign(customer_data,data),new AutoInput(customer_data.input,customer_data.cate,customer_data.auto_url,(()=>{})).init(),modal_init(),customer_data.button.addEventListener("click",(function(){if(!document.querySelector("#customer-show")){let width=.8*document.querySelector("body").clientWidth,height=.8*document.querySelector("body").clientHeight,customer_height=height-270,html=`<div id="customer-show">\n                    <div class="table-top">\n                        <div class="autocomplete customer-search">\n                            <input type="text" class="form-control search-input" id="search-input" placeholder="${customer_data.cate.textContent}搜索">\n                            <button class="btn btn-info btn-sm" id="serach-button">搜索</button>\n                        </div>\n                    </div>\n\n                    <div class="table-container table-customer">\n                        <table>\n                            <thead>\n                                <tr></tr>\n                            </thead>\n                            <tbody>\n                            </tbody>\n                        </table>\n                        <div class="table-ctrl">\n                            <div class="tools-button"></div>\n                            <div class="table-button">\n                                <button class="page-button btn" id="first" title="首页"><img src="/assets/img/backward.png"\n                                        width="12px"></button>\n                                <button class="page-button btn" id="pre" title="前一页"><img src="/assets/img/backward2.png"\n                                        width="12px"></button>\n                                <p class="seperator"></p>\n                                <span>第</span><input type="text" class="form-control" id="page-input" value="1">\n                                <span>页，共</span><span id="pages"></span><span>页</span>\n                                <p class="seperator"></p>\n                                <button class="page-button btn" id="aft" title="后一页"><img src="/assets/img/forward2.png"\n                                        width="12px"></button>\n                                <button class="page-button btn" id="last" title="尾页"><img src="/assets/img/forward.png"\n                                        width="12px"></button>\n                            </div>\n\n                            <div class="table-info">\n                                共 <span id="total-records"></span> 条记录\n                            </div>\n\n                        </div>\n                    </div>\n                </div>`;document.querySelector(".modal-body").innerHTML=html,fetch("/fetch_inout_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(customer_data.cate.textContent)}).then((response=>response.json())).then((content=>{out_data.customer_table_fields=content;let table=document.querySelector(".table-customer"),da=service.build_table_header(table,[{name:"序号",width:3}],content,"","customers");table.querySelector("thead tr").innerHTML=da.th_row;let init_data={container:".table-customer",url:"/fetch_inout_customer",header_names:da.header_names,post_data:{id:"",name:"",sort:"名称 ASC",rec:Math.floor(customer_height/30),cate:customer_data.cate.textContent},edit:!1,row_fn:customer_table_row,blank_row_fn:customer_blank_row};table_init(init_data),fetch_table((()=>{row_dbclick(table)}))})),document.querySelector("#serach-button").onclick=function(){search_table()},document.querySelector(".modal-title").textContent=`选择${customer_data.cate.textContent}`,document.querySelector(".modal-dialog").style.cssText=`max-width: ${width}px; height: ${height}px;`,document.querySelector(".modal-content").style.cssText="height: 100%;"}document.querySelector(".modal").style.display="block"})),document.querySelector("#modal-sumit-button").addEventListener("click",(function(e){let cate=document.querySelector(".modal-title").textContent;if("选择客户"==cate||"选择供应商"==cate){let selected_row=document.querySelector("table .focus");selected_row?chose_exit(selected_row):notifier.show("请先选择再提交","danger")}}),!1)}function customer_table_row(tr){let rec=tr.split(SPLITER),row=`<tr><td style="text-align: center;">${rec[1]}</td><td hidden>${rec[0]}</td>`;return service.build_row_from_string(rec,row,out_data.customer_table_fields)}function customer_blank_row(){return service.build_blank_from_fields("<tr><td></td><td hidden></td>",out_data.customer_table_fields)}function row_dbclick(table){let rows=table.querySelectorAll("body tr");for(let row of rows)row.addEventListener("dblclick",(function(){chose_exit(this)}))}function search_table(){let table=document.querySelector(".table-customer"),search=document.querySelector("#search-input").value;Object.assign(table_data.post_data,{name:search,page:1}),fetch_table((()=>{row_dbclick(table)}))}function chose_exit(selected_row){let id=selected_row.children[1].textContent;if(id){let name=selected_row.children[2].textContent,supplier=document.querySelector("#supplier-input");supplier.value=name,supplier.setAttribute("data",id),close_modal()}else notifier.show("请先选择记录","danger")}