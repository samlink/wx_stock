import{notifier}from"../parts/notifier.mjs";import{regReal,getHeight}from"../parts/tools.mjs";document.querySelector("#function-set .nav-icon").classList.add("show-chosed"),document.querySelector("#function-set .menu-text").classList.add("show-chosed");let global={drag_id:"",drag_tr:"",edit:0,edit2:0},sumit_button=document.querySelector("#sumit-button"),sumit_button2=document.querySelector("#sumit-button2");sumit_button.disabled=!0,sumit_button2.disabled=!0;var table_name={};function row_fn(tr){let s1="",s2="";"普通输入"==tr.ctr_type?s1="selected":"下拉列表"==tr.ctr_type&&(s2="selected");let select="布尔"!=tr.data_type?`<select class='select-sm'><option value="普通输入" ${s1}>普通输入</option>\n                <option value="下拉列表" ${s2}>下拉列表</option></select></td>`:"<select class='select-sm'><option value=\"二值选一\" selected>二值选一</option></select></td>",read_only="普通输入"==tr.ctr_type?"disabled":"",checked=tr.is_show?"checked":"",disabled=tr.all_edit?"":"disabled",style=tr.all_edit?"":"style='background: lightgrey;border: none;'";return`<tr draggable="true"><td class='hide'>${tr.id}</td><td width=6%>${tr.num}</td><td class='hide'>${tr.field_name}</td>\n            <td width=10%>${tr.data_type}</td><td width=15%><input class='form-control input-sm' type="text" value=${tr.show_name}></td>\n            <td width=8%><input class='form-control input-sm' type="text" value=${tr.show_width}></td>\n            <td width=15%>${select}</td>\n            <td width=20%><input class='form-control input-sm' type="text" ${read_only} value=${tr.option_value}></td>\n            <td width=10%><input class='form-control input-sm' type="text" ${read_only} value=${tr.default_value}></td>\n            <td width=8%><label class="check-radio"><input type="checkbox" ${checked} ${disabled}>\n            <span class="checkmark" ${style}></span></td></tr>`}function blank_row_fn(){return"<tr><td width=6%></td><td class='hide'></td><td width=10%></td><td width=15%></td><td width=8%></td><td width=15%></td><td width=20%></td><td width=10%></td><td width=8%></td></tr>"}function fetch_data(data){fetch(`/${code}/fetch_fields`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{if(-1!=content){let rows="",count=0;for(let tr of content[0])rows+=row_fn(tr),count++;for(let i=0;i<2;i++)rows+=blank_row_fn();let table_body=document.querySelector(".table-product tbody");table_body.innerHTML=rows,document.querySelector("#total-records").textContent=content[1],row_drag(table_body,sumit_button);let all_input=document.querySelectorAll(".table-product tbody input");for(let input of all_input)input.addEventListener("input",(()=>{sumit_button.disabled=!1,global.edit=1}));let all_select=document.querySelectorAll(".table-product tbody select");for(let select of all_select)select.addEventListener("change",(function(){document.querySelector("#sumit-button").disabled=!1,global.edit=1,"普通输入"!=this.value?(this.parentNode.nextElementSibling.querySelector("input").disabled=!1,this.parentNode.nextElementSibling.querySelector("input").focus()):this.parentNode.nextElementSibling.querySelector("input").disabled=!0}))}else alert("无此操作权限")}))}function fetch_data2(data){fetch(`/${code}/fetch_fields2`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{if(-1!=content){let rows="",count=0;for(let tr of content[0])rows+=row_fn2(tr),count++;for(let i=0;i<2;i++)rows+=blank_row_fn2();let table_body=document.querySelector(".table-inout tbody");table_body.innerHTML=rows,document.querySelector("#total-records2").textContent=content[1],row_drag(table_body,sumit_button2);let all_input=document.querySelectorAll(".table-inout tbody input");for(let input of all_input)input.addEventListener("input",(()=>{sumit_button2.disabled=!1,global.edit2=1}))}else alert("无此操作权限")}))}function row_fn2(tr){let checked=tr.inout_show?"checked":"",disabled=tr.all_edit?"":"disabled",style=tr.all_edit?"":"style='background: lightgrey;border: none;'";return`<tr draggable="true"><td class='hide'>${tr.id}</td>\n            <td width=20%>${tr.num}</td><td>${tr.show_name}</td>\n            <td width=20%><label class="check-radio"><input type="checkbox" ${checked} ${disabled}>\n            <span class="checkmark" ${style}></span></td></tr>`}function blank_row_fn2(){return"<tr><td width=20%></td><td></td><td width=20%></td></tr>"}function row_drag(table_body,sumit_button,bz){for(let tr of table_body.children)tr.addEventListener("dragstart",(function(e){e.stopPropagation(),global.drag_tr=e.target})),tr.addEventListener("dragover",(function(e){e.preventDefault(),e.stopPropagation(),this.style.cssText="color: red; background-color: lightyellow; font-weight: 600;"})),tr.addEventListener("dragleave",(function(e){e.preventDefault(),e.stopPropagation(),this.style.cssText=""})),tr.addEventListener("drop",(function(e){e.preventDefault(),e.stopPropagation(),this.style.cssText="",table_body.insertBefore(global.drag_tr,this),sumit_button.disabled=!1,1==bz?global.edit=1:global.edit2=1}))}document.querySelector("#table-choose").addEventListener("change",(function(){table_name.name=this.value,document.querySelector("#choose-info").classList.add("hide"),fetch_data(table_name),fetch_data2(table_name)})),sumit_button.addEventListener("click",(()=>{let data=[],order=1,table_body=document.querySelector(".table-product tbody");for(let tr of table_body.children)if(""!=tr.querySelector("td:nth-child(1)").textContent){if(!regReal.test(Number(tr.querySelector("td:nth-child(6) input").value)))return notifier.show("宽度输入有错误","danger"),!1;let select=tr.querySelector("select");if("普通输入"!=select.value&&""==select.parentNode.nextElementSibling.querySelector("input").value)return notifier.show("可选值还未输入","danger"),!1}for(let tr of table_body.children)if(""!=tr.querySelector("td:nth-child(1)").textContent){let tr_data={id:Number(tr.querySelector("td:nth-child(1)").textContent),show_name:tr.querySelector("td:nth-child(5) input").value,show_width:Number(tr.querySelector("td:nth-child(6) input").value),ctr_type:tr.querySelector("td:nth-child(7) select").value,option_value:tr.querySelector("td:nth-child(8) input").value,default_value:tr.querySelector("td:nth-child(9) input").value,is_show:tr.querySelector("td:nth-child(10) input").checked,show_order:order};order++,data.push(tr_data)}fetch(`/${code}/update_tableset`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{1==content?(global.edit=0,fetch_data2(table_name),document.querySelector("#sumit-button").disabled=!0,notifier.show("字段修改成功","success")):notifier.show("权限不够，操作失败","danger")}))})),sumit_button2.addEventListener("click",(()=>{let data=[],order=1,table_body=document.querySelector(".table-inout tbody");for(let tr of table_body.children)if(""!=tr.querySelector("td:nth-child(1)").textContent){let tr_data={id:Number(tr.querySelector("td:nth-child(1)").textContent),inout_show:tr.querySelector("td:nth-child(4) input").checked,inout_order:order};order++,data.push(tr_data)}fetch(`/${code}/update_tableset2`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{1==content?(global.edit2=0,document.querySelector("#sumit-button2").disabled=!0,notifier.show("字段修改成功","success")):notifier.show("权限不够，操作失败","danger")}))})),window.onbeforeunload=function(e){1!=global.edit&&1!=global.edit2||((e=window.event||e).returnValue="编辑未保存提醒")};