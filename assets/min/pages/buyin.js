import{table_data,table_init,fetch_table}from"../parts/table.mjs";import{fetch_tree,tree_init,tree_search}from"../parts/tree.mjs";import{notifier}from"../parts/notifier.mjs";import{alert_confirm}from"../parts/alert.mjs";import{auto_table,AutoInput}from"../parts/autocomplete.mjs";import*as service from"../parts/service.mjs";import{SPLITER,regInt,regReal,regDate,moneyUppercase}from"../parts/tools.mjs";let customer_table_fields,document_table_fields,edited;document.querySelector("#goods-in .nav-icon").classList.add("show-chosed"),document.querySelector("#goods-in .menu-text").classList.add("show-chosed");let document_name,num_position=document.querySelector("#num_position").textContent.split(","),customer_supplier=document.querySelector("#customer-suplier"),document_bz=document.querySelector("#document-bz").textContent.trim(),dh_div=document.querySelector("#dh");if("商品销售"==document_bz)document_name="销售单据";else if("商品采购"==document_bz)document_name="采购单据";else{let customer=document.querySelector("#customer-div");customer.style.display="none",customer.querySelector("input").setAttribute("data",0),document.querySelector("#sum-money").style.display="none",document.querySelector("#supplier-info").style.cssText="color: black",document.querySelector("#supplier-info").textContent="库存增加，数量为正；库存减少，数量为负",document_name="库存调整"}function dh_data(dh){let cate;return cate="商品销售"==document_bz?"销售单据":"商品采购"==document_bz?"采购单据":"库存调整",{cate:cate,dh:dh}}function document_top_handle(html,has_date){document.querySelector(".has-auto").insertAdjacentHTML("afterend",html);let date=document.querySelector("#日期");has_date||(date.value=(new Date).Format("yyyy-MM-dd")),laydate.render({elem:date,showBottom:!1}),"库存调整"==document_bz&&(document.querySelector("#customer-div + div").style.marginLeft="0");let fields_show=document.querySelector(".fields-show"),has_auto=document.querySelector(".has-auto"),next_auto=document.querySelector(".has-auto+div");fields_show.addEventListener("scroll",(function(){0!=fields_show.scrollTop?(has_auto.style.cssText="position: relative; left: 5px;",next_auto.style.cssText="margin-left: -3px;"):(has_auto.style.cssText="",next_auto.style.cssText="")}))}fetch(`/${code}/fetch_inout_fields`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(document_name)}).then((response=>response.json())).then((content=>{if(-1!=content){document_table_fields=content;let dh=dh_div.textContent;if("新单据"!=dh){let data=dh_data(dh);fetch(`/${code}/fetch_document`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((data=>{document_top_handle(service.build_inout_form(document_table_fields,data),!0);let values=data.split(SPLITER),len=values.length;document.querySelector("#inout-cate").value=values[len-1],fetch_print_models(values[len-1]);let rem=document.querySelector("#remember-button");"true"==values[len-2]?(rem.textContent="已记账",rem.classList.add("remembered")):(rem.textContent="未记账",rem.classList.remove("remembered"));let customer=document.querySelector("#supplier-input");customer.value=values[len-3],customer.setAttribute("data",values[len-4]),"库存调整"!=document_bz&&supplier_auto_show(),setTimeout((()=>{sum_money(),sum_records()}),200)}))}else{document_top_handle(service.build_inout_form(content),!1),document.querySelector("#remember-button").textContent="未记账"}}}));let show_names,all_width,ware_option,ware_value,direct_check,product_table_fields,table_lines,blank_row,sale_cut,auto_comp=new AutoInput(document.querySelector("#supplier-input"),customer_supplier,`/${code}/customer_auto`,(()=>{supplier_auto_show()}));auto_comp.init(),document.querySelector("#supplier-serach").addEventListener("click",(function(){if(!document.querySelector("#customer-show")){let width=.8*document.querySelector("body").clientWidth,height=.8*document.querySelector("body").clientHeight,customer_height=height-270,html=`<div id="customer-show">\n                    <div class="table-top">\n                        <div class="autocomplete customer-search">\n                            <input type="text" class="form-control search-input" id="search-input" placeholder="${customer_supplier.textContent}搜索">\n                            <button class="btn btn-info btn-sm" id="serach-button">搜索</button>\n                        </div>\n                    </div>\n\n                    <div class="table-container table-customer">\n                        <table>\n                            <thead>\n                                <tr></tr>\n                            </thead>\n                            <tbody>\n                            </tbody>\n                        </table>\n                        <div class="table-ctrl">\n                            <div class="tools-button"></div>\n                            <div class="table-button">\n                                <button class="page-button btn" id="first" title="首页"><img src="/${code}/assets/img/backward.png"\n                                        width="12px"></button>\n                                <button class="page-button btn" id="pre" title="前一页"><img src="/${code}/assets/img/backward2.png"\n                                        width="12px"></button>\n                                <p class="seperator"></p>\n                                <span>第</span><input type="text" class="form-control" id="page-input" value="1">\n                                <span>页，共</span><span id="pages"></span><span>页</span>\n                                <p class="seperator"></p>\n                                <button class="page-button btn" id="aft" title="后一页"><img src="/${code}/assets/img/forward2.png"\n                                        width="12px"></button>\n                                <button class="page-button btn" id="last" title="尾页"><img src="/${code}/assets/img/forward.png"\n                                        width="12px"></button>\n                            </div>\n\n                            <div class="table-info">\n                                共 <span id="total-records"></span> 条记录\n                            </div>\n\n                        </div>\n                    </div>\n                </div>`;document.querySelector(".modal-body").innerHTML=html,fetch(`/${code}/fetch_inout_fields`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(customer_supplier.textContent)}).then((response=>response.json())).then((content=>{customer_table_fields=content;let table=document.querySelector(".table-customer"),data=service.build_table_header(table,[{name:"序号",width:3}],customer_table_fields);table.querySelector("thead tr").innerHTML=data.th_row;let init_data={container:".table-customer",url:`/${code}/fetch_inout_customer`,header_names:data.header_names,post_data:{id:"",name:"",sort:"名称 ASC",rec:Math.floor(customer_height/30),cate:customer_supplier.textContent},edit:!1,row_fn:customer_table_row,blank_row_fn:customer_blank_row};table_init(init_data),fetch_table((()=>{row_dbclick(table)}))})),new AutoInput(document.querySelector("#search-input"),customer_supplier,`/${code}/customer_auto`,(()=>{search_table()})).init(),document.querySelector("#serach-button").onclick=function(){search_table()},document.querySelector(".modal-title").textContent=`选择${customer_supplier.textContent}`,document.querySelector(".modal-dialog").style.cssText=`max-width: ${width}px; height: ${height}px;`,document.querySelector(".modal-content").style.cssText="height: 100%;"}document.querySelector(".modal").style.display="block"})),fetch(`/${code}/fetch_inout_fields`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify("商品规格")}).then((response=>response.json())).then((content=>{product_table_fields=content;table_lines=Math.floor((document.querySelector("body").clientHeight-390)/33),all_width=0,show_names=[{name:"名称",width:140}];for(let item of content)all_width+=item.show_width,show_names.push({name:item.show_name,width:18*item.show_width});let table_container=document.querySelector(".table-items"),table_width=document.querySelector(".content").clientWidth-document.querySelector(".table-history").clientWidth-15;table_container.style.width=table_width,all_width="客户"==customer_supplier.textContent?18*all_width+40+140+60+60+80+100+100+40:18*all_width+40+140+60+60+80+100+100;let hide="商品销售"==document_bz?"":"hidden",hide2="库存调整"!=document_bz?"":"hidden",th_row=`<tr><th width=${4e3/all_width}%>序号</th>\n                <th width=${4e3/all_width}% ${hide}>直销</th>\n                <th width=${14e3/all_width}%>名称</th>`;blank_row=`<tr><td width=${4e3/all_width}%></td>\n                <td width=${4e3/all_width}% ${hide}></td>\n                <td width=${14e3/all_width}%></td>`;for(let th of content)th_row+=`<th width=${18*th.show_width*100/all_width}%>${th.show_name}</th>`,blank_row+=`<td width=${18*th.show_width*100/all_width}%></td>`;th_row+=`<th width=${6e3/all_width}% ${hide2}>单价</th><th width=${6e3/all_width}%>数量</th>\n                <th width=${8e3/all_width}% ${hide2}>金额</th><th width=${1e4/all_width}%>仓库</th>\n                <th width=${1e4/all_width}%>备注</th></tr>`,table_container.querySelector("thead").innerHTML=th_row,blank_row+=`<td width=${6e3/all_width}% ${hide2}></td><td width=${6e3/all_width}%></td>\n                    <td width=${8e3/all_width}% ${hide2}></td><td width=${1e4/all_width}%></td>\n                    <td width=${1e4/all_width}%></td></tr>`;let tbody=table_container.querySelector("tbody"),dh=dh_div.textContent;if("新单据"==dh){let input_row=build_input_row(show_names,all_width);tbody.appendChild(input_row);let rows="";for(let i=0;i<table_lines-1;i++)rows+=blank_row;tbody.querySelector(".has-input").insertAdjacentHTML("afterend",rows)}else{let data=dh_data(dh);fetch(`/${code}/fetch_document_items`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((data=>{let num=1;for(let item of data){let input_row=build_input_row(show_names,all_width,num);tbody.appendChild(input_row);let product=item.split(SPLITER),len=product.length,n=4;for(let i=0;i<show_names.length-1;i++)input_row.querySelector(`td:nth-child(${n})`).textContent=product[i],n++;input_row.querySelector("td:nth-child(2) input").checked="true"==product[len-8],input_row.querySelector("td:nth-child(3) input").value=product[len-6],input_row.querySelector("td:nth-child(3) input").setAttribute("data",`${product[len-7]}${SPLITER}`),input_row.querySelector("td:nth-last-child(1) input").value=product[len-1],input_row.querySelector("td:nth-last-child(3)").textContent=Math.abs(product[len-4]*product[len-5]).toFixed(Number(num_position[1])),input_row.querySelector("td:nth-last-child(4) input").value="库存调整"!=document_bz?Math.abs(product[len-4]):product[len-4],input_row.querySelector("td:nth-last-child(5) input").value=product[len-5],ware_option?build_ware_position(ware_option,input_row,Number(product[len-3])):build_ware_house(input_row,Number(product[len-3])),num++}let input_row=build_input_row(show_names,all_width,num);tbody.appendChild(input_row),setTimeout((function(){build_ware_position(ware_option,input_row)}),200);let rows="";for(let i=0;i<table_lines-data.length-1;i++)rows+=blank_row;tbody.querySelector("tr:nth-last-child(1)").insertAdjacentHTML("afterend",rows)}))}tbody.style.height=33*table_lines+"px","库存调整"==document_bz&&(document.querySelector(".table-history thead th:nth-child(2)").style.display="none"),init_history(),table_container.querySelector("tbody").addEventListener("scroll",(function(){remove_absolute()}))})),document.querySelector("#row-insert").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");if(edit){let table_body=document.querySelector(".table-items tbody"),input_row=build_input_row(show_names,all_width);remove_absolute(),remove_inputting(),table_body.insertBefore(input_row,edit),rebuild_index(),sum_records(),input_row.querySelector("td:nth-child(3)").click()}else notifier.show("请先选择行","danger")})),document.querySelector("#row-del").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");edit?alert_confirm("确认删除行吗？",{confirmCallBack:()=>{if(edit.parentNode.removeChild(edit),document.querySelector(".has-input"))remove_absolute(),remove_inputting(),rebuild_index();else{let new_row=build_input_row(show_names,all_width),first_child=document.querySelector(".table-items tbody tr");first_child?document.querySelector(".table-items tbody").insertBefore(new_row,first_child):document.querySelector(".table-items tbody").appendChild(new_row)}sum_records(),sum_money()}}):notifier.show("请先选择行","danger")})),document.querySelector("#row-up").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");edit?edit.previousElementSibling&&(edit.parentNode.insertBefore(edit,edit.previousElementSibling),remove_absolute(),rebuild_index()):notifier.show("请先选择行","danger")})),document.querySelector("#row-down").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");edit?edit.nextElementSibling&&""!=edit.nextElementSibling.querySelector("td:nth-child(1)").textContent&&(edit.parentNode.insertBefore(edit.nextElementSibling,edit),remove_absolute(),rebuild_index()):notifier.show("请先选择行","danger")})),document.querySelector("#save-button").addEventListener("click",(function(){if(!error_check())return!1;let customer_id=document.querySelector("#supplier-input").getAttribute("data"),all_values=document.querySelectorAll(".document-value"),cate=document.querySelector("#inout-cate").value,dh=dh_div.textContent,user_name=document.querySelector("#user-name").textContent,save_str=`${cate}${SPLITER}${dh}${SPLITER}${customer_id}${SPLITER}${user_name}${SPLITER}`,n=0;for(let f of document_table_fields){if("文本"==f.data_type)save_str+=`${all_values[n].value}${SPLITER}`;else if("整数"==f.data_type||"实数"==f.data_type){save_str+=`${all_values[n].value?all_values[n].value:0}${SPLITER}`}else save_str+=`${all_values[n].checked?"是":"否"}${SPLITER}`;n++}let table_data=[],all_rows=document.querySelectorAll(".table-items .has-input");for(let row of all_rows)if(""!=row.querySelector("td:nth-child(3) input").value){let cate=document.querySelector("#inout-cate").value,mount=row.querySelector(".mount").value;"商品销售"!=cate&&"退货出库"!=cate||(mount*=-1);let row_data=`${row.querySelector("td:nth-child(2) input").checked}${SPLITER}${row.querySelector("td:nth-child(3) input").getAttribute("data").split(SPLITER)[0]}${SPLITER}`;row_data+=`${row.querySelector(".price").value}${SPLITER}${mount}${SPLITER}`,row_data+=`${row.querySelector("select").value}${SPLITER}${row.querySelector("td:nth-last-child(1) input").value}${SPLITER}`,table_data.push(row_data)}let data={rights:document_bz,document:save_str,remember:document.querySelector("#remember-button").textContent,items:table_data};fetch(`/${code}/save_document`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{-1!=content?(dh_div.textContent=content,notifier.show("单据保存成功","success"),edited=!1):notifier.show("权限不够，操作失败","danger")}))})),document.querySelector("#print-button").addEventListener("click",(function(){if(!error_check())return!1;let id=document.querySelector("#print-choose").value;fetch(`/${code}/fetch_provider_model`,{method:"post",headers:{"Content-Type":"application/json"},body:Number(id)}).then((response=>response.json())).then((content=>{var configElementTypeProvider=function(options){return{addElementTypes:function(context){context.allElementTypes=[],context.testModule=[],context.addPrintElementTypes("testModule",[new hiprint.PrintElementTypeGroup("常规",JSON.parse(content[0])),new hiprint.PrintElementTypeGroup("自定义",[{tid:"configModule.customText",title:"自定义文本",customText:"自定义文本",custom:!0,type:"text"},{tid:"configModule.image",title:"图片",data:`/${code}/assets/img/logo.png`,type:"image"},{tid:"configModule.tableCustom",title:"表格",type:"tableCustom",field:"table",options:{width:500}}]),new hiprint.PrintElementTypeGroup("辅助",[{tid:"configModule.hline",title:"横线",type:"hline"},{tid:"configModule.vline",title:"竖线",type:"vline"},{tid:"configModule.rect",title:"矩形",type:"rect"},{tid:"configModule.oval",title:"椭圆",type:"oval"}])])}}};hiprint.init({providers:[new configElementTypeProvider]});let hiprintTemplate=new hiprint.PrintTemplate({template:JSON.parse(content[1])});var printData={"供应商":document.querySelector("#supplier-input").value,"客户":document.querySelector("#supplier-input").value,"日期时间":(new Date).Format("yyyy-MM-dd hh:mm"),dh:dh_div.textContent,maker:document.querySelector("#user-name").textContent,barCode:dh_div.textContent};let show_fields=document.querySelectorAll(".document-value"),n=0;for(let field of document_table_fields)"布尔"==field.data_type?printData[field.show_name]=show_fields[n].checked?"是":"否":printData[field.show_name]=show_fields[n].value,n++;let table_data=[],all_rows=document.querySelectorAll(".table-items .has-input"),count=0,sum=0;for(let row of all_rows)if(""!=row.querySelector("td:nth-child(3) input").value){let row_data={};row_data["序号"]=row.querySelector("td:nth-child(1)").textContent,row_data["名称"]=row.querySelector("td:nth-child(3) input").value;let n=4;for(let f of product_table_fields)row_data[f.show_name]=row.querySelector(`td:nth-child(${n})`).textContent,n++;row_data["单价"]=row.querySelector(`td:nth-child(${n}) input`).value,row_data["数量"]=row.querySelector(`td:nth-child(${++n}) input`).value,row_data["金额"]=row.querySelector(`td:nth-child(${++n})`).textContent;let ware_select=row.querySelector(`td:nth-child(${++n}) select`);row_data["仓库"]=ware_select.options[ware_select.selectedIndex].textContent,row_data["备注"]=row.querySelector(`td:nth-child(${++n}) input`).value,table_data.push(row_data),count+=Number(row_data["数量"]),sum+=Number(row_data["金额"])}let row_data={"序号":"合计"};row_data["数量"]=count,row_data["金额"]=sum.toFixed(Number(num_position[1])),table_data.push(row_data),printData.chinese=moneyUppercase(Number(row_data["金额"])),printData.table=table_data,hiprintTemplate.print(printData)}))}));let inout_cate=document.querySelector("#inout-cate");function init_history(){let row2="库存调整"!=document_bz?"<tr><td></td><td></td><td></td></tr>":"<tr><td></td><td></td></tr>",rows2="";for(let i=0;i<table_lines;i++)rows2+=row2;document.querySelector(".table-history tbody").innerHTML=rows2}function init_page(){edited&&clear_page("清空页面所有数据吗？","清空","保留")}function clear_page(info,text1,text2){alert_confirm(info,{confirmText:text1,cancelText:text2,confirmCallBack:()=>{if("库存调整"!=document_bz){let customer_input=document.querySelector("#supplier-input");customer_input.removeAttribute("data"),customer_input.value=""}let all_inputs=document.querySelectorAll(".document-value"),n=0;for(let name of document_table_fields){if("普通输入"==name.ctr_type)all_inputs[n].value="";else if("二值选一"==name.ctr_type){let checked=name.option_value.split("_")[0]==name.default_value;all_inputs[n].checked=checked}else{let options=name.option_value.split("_");for(let value of options)if(value==name.default_value){all_inputs[n].value=value;break}}n++}document.querySelector("#日期").value=(new Date).Format("yyyy-MM-dd"),dh_div.textContent="新单据",document.querySelector("#supplier-info").textContent="",document.querySelector("#history-info").textContent="",document.querySelector("#total-records").textContent="",document.querySelector("#sum-money").textContent="金额合计：元",document.querySelector("#remember-button").textContent="未记账",document.querySelector("#remember-button").classList.remove("remembered"),direct_check=!1,ware_value="";let input_row=build_input_row(show_names,all_width),tbody=document.querySelector(".table-items tbody");tbody.innerHTML="",tbody.appendChild(input_row);let rows="";for(let i=0;i<table_lines-1;i++)rows+=blank_row;tbody.querySelector(".has-input").insertAdjacentHTML("afterend",rows),init_history(),edited=!1}})}function fetch_print_models(value){let print_id;print_id="采购入库"==value?3:"退货出库"==value?4:"商品销售"==value?1:"销售退货"==value?2:5,fetch(`/${code}/fetch_models`,{method:"post",headers:{"Content-Type":"application/json"},body:print_id}).then((response=>response.json())).then((content=>{let model_options="";for(let data of content)model_options+=`<option value="${data.id}">打印 - ${data.name}</option>`;document.querySelector("#print-choose").innerHTML=model_options}))}function error_check(){if(null==document.querySelector("#supplier-input").getAttribute("data"))return notifier.show("客户或供应商不在库中","danger"),!1;if(!regDate.test(document.querySelector("#日期").value))return notifier.show("日期输入错误","danger"),!1;let all_values=document.querySelectorAll(".document-value");for(let i=0;i<document_table_fields.length;i++)if("整数"==document_table_fields[i].data_type){if(all_values[i].value&&!regInt.test(all_values[i].value))return notifier.show(`${document_table_fields[i].show_name}输入错误`,"danger"),!1}else if("实数"==document_table_fields[i].data_type&&all_values[i].value&&!regReal.test(all_values[i].value))return notifier.show(`${document_table_fields[i].show_name}输入错误`,"danger"),!1;let all_rows=document.querySelectorAll(".table-items .has-input"),lines=0;for(let row of all_rows)if(""!=row.querySelector("td:nth-child(3) input").value&&(lines=1,!regReal.test(row.querySelector(".price").value)||!regReal.test(row.querySelector(".mount").value)))return notifier.show("单价或数量输入错误","danger"),!1;return 0!=lines||(notifier.show("表格不能为空","danger"),!1)}function calc_money(input_row){if("库存调整"!=document_bz){let price=input_row.querySelector(".price").value,mount=input_row.querySelector(".mount").value,money="";price&&regReal.test(price)&&mount&&regReal.test(mount)&&(money=(price*mount).toFixed(Number(num_position[1]))),input_row.querySelector(".money").textContent=money}}function sum_money(){if("库存调整"!=document_bz){let all_input=document.querySelectorAll(".has-input"),sum=0;for(let i=0;i<all_input.length;i++){let price=all_input[i].querySelector(".price").value,mount=all_input[i].querySelector(".mount").value;""!=all_input[i].querySelector("td:nth-child(3) .auto-input").value&&price&&regReal.test(price)&&mount&&regReal.test(mount)&&(sum+=price*mount)}document.querySelector("#sum-money").innerHTML=`金额合计：${sum.toFixed(Number(num_position[1]))} 元`,document.querySelector("#应结金额").value=sum.toFixed(Number(num_position[1]))}}function sum_records(){let all_input=document.querySelectorAll(".has-input"),num=0;for(let i=0;i<all_input.length;i++)""!=all_input[i].querySelector("td:nth-child(3) .auto-input").value&&num++;document.querySelector("#total-records").innerHTML=num}function rebuild_index(){let all_input=document.querySelectorAll(".has-input");for(let i=0;i<all_input.length;i++)all_input[i].querySelector("td:nth-child(1)").textContent=i+1,all_input[i].querySelector("td:nth-child(3) .autocomplete").style.zIndex=900-i}function remove_absolute(){let all_auto=document.querySelectorAll(".table-items .autocomplete");for(let auto of all_auto)auto.classList.remove("auto-edit"),auto.style.left="",auto.style.top=""}function remove_inputting(){let all_has_input=document.querySelectorAll(".has-input");for(let input of all_has_input)input.classList.remove("inputting")}function getLeft(element,parent){for(var left=element.offsetLeft,current=element.offsetParent;null!==current;)left+=current.offsetLeft,current=current.offsetParent;return left-parent.scrollLeft}function getTop(element,parent){for(var actualTop=element.offsetTop,current=element.offsetParent;null!==current;)actualTop+=current.offsetTop,current=current.offsetParent;return actualTop-parent.scrollTop}function build_input_row(show_names,all_width,num){num||(num=1);let input_row=document.createElement("tr");input_row.classList.add("has-input");let hide2="库存调整"!=document_bz?"":"hidden",hide_value="库存调整"!=document_bz?"":0,row=`<td width=${4e3/all_width}%>${num}</td>\n                <td width=${4e3/all_width}% ${"商品销售"==document_bz?"":"hidden"} class="editable">\n                    <label class="check-radio">\n                        <input class="has-value direct-check" type="checkbox" ${direct_check?"checked":""}>\n                            <span class="checkmark td-check"></span>\n                    </label>\n                </td>\n                <td width=${14e3/all_width}% class="editable">\n                    <div class="form-input autocomplete" style="z-index: 900;">\n                        <input class="form-control input-sm has-value auto-input" type="text" />\n                        <button class="btn btn-info btn-sm product-search-button"> ... </button>\n                    </div>\n                </td>`;for(let i=1;i<show_names.length;i++)row+=`<td width=${100*show_names[i].width/all_width}%></td>`;row+=`\n        <td width=${6e3/all_width}% class="editable" ${hide2}>\n            <div class="form-input">\n                <input class="form-control input-sm has-value price" value='${hide_value}' type="text" />\n            </div>\n        </td><td width=${6e3/all_width}%} class="editable">\n            <div class="form-input">\n                <input class="form-control input-sm has-value mount" type="text" />\n            </div>\n        </td><td class="money" width=${8e3/all_width}% ${hide2}></td>\n        <td width=${1e4/all_width}% class="editable"></td>\n        <td width=${1e4/all_width}% class="editable">\n            <div class="form-input">\n                <input class="form-control input-sm has-value" type="text" />\n            </div>\n        </td>`,input_row.innerHTML=row;let auto_input=input_row.querySelector(".auto-input"),auto_td=input_row.querySelector("td:nth-child(3)"),auto_th=document.querySelector(".table-items th:nth-child(3)");auto_input.style.width=auto_th.clientWidth-36+"px",auto_td.addEventListener("click",(function(){element_position(this,7.4,1),auto_input.focus()})),input_row.addEventListener("click",(function(){remove_inputting(),this.classList.add("inputting")}));let[...show_th]=show_names;return show_th.push({name:"库存",width:60}),auto_table(auto_input,"",`/${code}/buyin_auto`,show_th,(()=>{fill_gg(auto_input,input_row)})),"库存调整"!=document_bz&&(input_row.querySelector(".price").addEventListener("blur",(function(){calc_money(input_row),sum_money()})),input_row.querySelector(".mount").addEventListener("blur",(function(){calc_money(input_row),sum_money()}))),input_row.querySelector(".product-search-button").addEventListener("click",(function(){if(!this.parentNode.parentNode.parentNode.classList.contains("inputting"))return!1;if(!document.querySelector(".product-content")){let width=.8*document.querySelector("body").clientWidth,height=.8*document.querySelector("body").clientHeight,tbody_height=height-270,html=`\n                    <div class="product-content">\n                        <div class="tree-show">\n                            <div class="autocomplete table-top">\n                                <input type="text" class="form-control search-input" id="auto_input" placeholder="商品搜索">\n                                <button id="auto_search" class="btn btn-info btn-sm"><img src="/${code}/assets/img/zoom.png"\n                                        width="20px"></button>\n                            </div>\n                            <div class="tree-title">商品分类　<a href="javascript:;" title="刷新"><i class="fa fa-refresh fa-lg"></i></a></div>\n                            <div class="tree-container">\n                                <ul id="tree">\n                                </ul>\n                            </div>\n                        </div>\n                        <div id="product-show">\n                            <div class="table-top">\n                                <div class="autocomplete product-search">\n                                    <input type="text" class="form-control search-input" id="search-input" placeholder="规格搜索">\n                                    <button class="btn btn-info btn-sm" id="serach-button">搜索</button>\n                                    <span id="product-name"></span><span id="product-id"></span>\n                                </div>\n                                <div class="table-tools">\n                                </div>\n                            </div>\n                \n                            <div class="table-container table-product">\n                                <table>\n                                    <thead>\n                                        <tr>\n                                            <th></th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                    </tbody>\n                                </table>\n                                <div class="table-ctrl">\n                                    <div class="tools-button"></div>\n                                    <div class="table-button">\n                                        <button class="page-button btn" id="first" title="首页"><img src="/${code}/assets/img/backward.png"\n                                                width="12px"></button>\n                                        <button class="page-button btn" id="pre" title="前一页"><img src="/${code}/assets/img/backward2.png"\n                                                width="12px"></button>\n                                        <p class="seperator"></p>\n                                        <span>第</span><input type="text" class="form-control" id="page-input" value="1">\n                                        <span>页，共</span><span id="pages"></span><span>页</span>\n                                        <p class="seperator"></p>\n                                        <button class="page-button btn" id="aft" title="后一页"><img src="/${code}/assets/img/forward2.png"\n                                                width="12px"></button>\n                                        <button class="page-button btn" id="last" title="尾页"><img src="/${code}/assets/img/forward.png"\n                                                width="12px"></button>\n                                    </div>\n                \n                                    <div class="table-info">\n                                        共 <span id="total-records"></span> 条记录\n                                    </div>\n                \n                                </div>\n                            </div>\n                        </div>\n                        <div class="hide"><span id="context-menu"></span><span id="zhezhao"></span>\n                            <span id="context-add"></span><span id="context-edit"></span><span id="context-del"></span>\n                        </div>\n                    </div>`;document.querySelector(".modal-body").innerHTML=html,document.querySelector(".tree-container").style.height=height-240+"px",tree_init({node_num:"",leaf_click:(id,name)=>{document.querySelector("#product-name").textContent=name,document.querySelector("#product-id").textContent=id;let post_data={id:id,name:"",page:1};Object.assign(table_data.post_data,post_data);let table=document.querySelector(".table-product");fetch_table((()=>{row_dbclick(table)}))}}),fetch_tree();let input=document.querySelector("#auto_input");new AutoInput(input,"",`/${code}/tree_auto`,(()=>{tree_search(input.value)})).init(),document.querySelector("#auto_search").addEventListener("click",(()=>{tree_search(input.value)})),document.querySelector(".tree-title").addEventListener("click",(()=>{fetch_tree()}));let row_num=Math.floor(tbody_height/30);service.build_product_table(row_num,row_dbclick),document.querySelector(".modal-title").textContent="选择商品",document.querySelector(".modal-dialog").style.cssText=`max-width: ${width}px; height: ${height}px;`,document.querySelector(".modal-content").style.cssText="height: 100%;"}document.querySelector(".modal").style.display="block"})),ware_option?build_ware_position(ware_option,input_row):build_ware_house(input_row),input_row}function fill_gg(auto_input,input_row){let field_values=auto_input.getAttribute("data").split(SPLITER),n=4;for(let i=2;i<field_values.length-2;i++){let val=field_values[i];"二值选一"==product_table_fields[i-2].ctr_type&&(val="true"==val?product_table_fields[i-2].option_value.split("_")[0]:product_table_fields[i-2].option_value.split("_")[1]),document.querySelector(`.inputting td:nth-child(${n})`).textContent=val,n++}let price_input=document.querySelector(`.inputting td:nth-child(${n}) input`),price=field_values[field_values.length-1];"商品销售"==document_bz&&regReal.test(sale_cut)&&regReal.test(price)?(price_input.value=(price*sale_cut).toFixed(Number(num_position[0])),price_input.select()):"库存调整"!=document_bz?price_input.focus():document.querySelector(".inputting .mount").focus(),ware_value&&(input_row.querySelector("select").value=ware_value),add_line(show_names,all_width),edited=!0}function build_ware_house(input_row,value){fetch(`/${code}/fetch_house`).then((response=>response.json())).then((content=>{ware_option="";for(let house of content)ware_option+=`<option value="${house.id}">${house.name}</option>`;build_ware_position(ware_option,input_row,value)}))}function build_ware_position(ware_option,input_row,value){let ware_house_select=document.createElement("select");ware_house_select.classList.add("select-sm"),ware_house_select.classList.add("has-value"),ware_house_select.innerHTML=ware_option,value&&(ware_house_select.value=value),ware_house_select.addEventListener("change",(function(){ware_value=this.value})),input_row.querySelector("td:nth-last-child(2)").innerHTML="",input_row.querySelector("td:nth-last-child(2)").appendChild(ware_house_select)}function element_position(element,add_x,add_y){if(element.querySelector(".autocomplete").classList.contains("auto-edit"))return!1;let tbody=document.querySelector(".table-items tbody"),x=getLeft(element,tbody),y=getTop(element,tbody),auto_div=element.querySelector(".autocomplete");auto_div.style.left=x+add_x+"px",auto_div.style.top=y+add_y+"px",element.querySelector(".autocomplete").classList.add("auto-edit")}function add_line(show_names,all_width){let field_values=document.querySelector(".inputting .auto-input").getAttribute("data").split(SPLITER),customer_id=document.querySelector("#supplier-input").getAttribute("data"),data={cate:document_bz,customer_id:customer_id?Number(customer_id):-1,product_id:Number(field_values[0])};fetch(`/${code}/fetch_history`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{if(-1!=content){let num=document.querySelector(".inputting td:nth-child(1)").textContent,name=document.querySelector(".inputting td:nth-child(3) input").value;document.querySelector("#history-info").textContent=`${num} - ${name}`;let tr="";if("库存调整"!=document_bz)for(let row of content)tr+=`<tr><td>${row.date}</td><td>${row.price}</td><td>${row.count}</td></tr>`;else for(let row of content)tr+=`<tr><td>${row.date}</td><td>${row.count}</td></tr>`;let row2="库存调整"!=document_bz?"<tr><td></td><td></td><td></td></tr>":"<tr><td></td><td></td></tr>",len=table_lines-content.length;for(let i=0;i<len;i++)tr+=row2;document.querySelector(".table-history tbody").innerHTML=tr}else notifier.show("权限不够","danger")})),direct_check=document.querySelector(".inputting .direct-check").checked;let new_row=build_input_row(show_names,all_width),next=document.querySelector(".inputting + tr");next&&""==next.querySelector("td:nth-child(1)").textContent?next.parentNode.replaceChild(new_row,next):next||document.querySelector(".table-items tbody").appendChild(new_row),rebuild_index(),sum_records()}function supplier_auto_show(){let data={rights:"客户"==customer_supplier.textContent?"商品销售":"商品采购",cate:customer_supplier.textContent,id:Number(document.querySelector("#supplier-input").getAttribute("data"))};fetch(`/${code}/fetch_supplier`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{let supplier=content[1].split(SPLITER),join_sup="";for(let i=0;i<content[0].length;i++)join_sup+=`${content[0][i].show_name}：${supplier[i]}； `;let info=document.querySelector("#supplier-info");-1!=content[2].indexOf("差")?info.style.cssText="color: red; background-color: wheat;":info.style.cssText="",info.textContent=join_sup,sale_cut=content[3]}))}function customer_table_row(tr){let rec=tr.split(SPLITER),row=`<tr><td style="text-align: center;">${rec[1]}</td><td hidden>${rec[0]}</td>`;return service.build_row_from_string(rec,row,customer_table_fields)}function customer_blank_row(){return service.build_blank_from_fields("<tr><td></td><td hidden></td>",customer_table_fields)}function row_dbclick(table){let rows=table.querySelectorAll("body tr");for(let row of rows)row.addEventListener("dblclick",(function(){chose_exit(this)}))}function search_table(){let table=document.querySelector(".table-customer"),search=document.querySelector("#search-input").value;Object.assign(table_data.post_data,{name:search,page:1}),fetch_table((()=>{row_dbclick(table)}))}function close_modal(){document.querySelector(".modal").style.display="none",document.querySelector(".modal-content").style.cssText="",document.querySelector("#modal-info").innerHTML=""}function chose_exit(selected_row){let id=selected_row.children[1].textContent;if(id)if("选择商品"!=document.querySelector(".modal-title").textContent){let name=selected_row.children[2].textContent,supplier=document.querySelector("#supplier-input");supplier.value=name,supplier.setAttribute("data",id),supplier_auto_show(),close_modal()}else fetch(`/${code}/fetch_one_product`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(Number(id))}).then((response=>response.json())).then((content=>{let name=document.querySelector("#product-name").textContent,data=` ${id}${SPLITER}${name}${SPLITER}${content}`,input=document.querySelector(".inputting .auto-input");input.value=name,input.setAttribute("data",data),fill_gg(input,document.querySelector(".inputting")),close_modal()}));else notifier.show("请先选择记录","danger")}fetch_print_models(inout_cate.value),inout_cate.addEventListener("change",(function(){init_page(),fetch_print_models(this.value)})),document.querySelector("#document-new-button").addEventListener("click",(function(){clear_page("将清空页面所有数据，确认继续吗？","确认","取消")})),document.querySelector("#remember-button").addEventListener("click",(function(){if("已记账"==this.textContent)return!1;if("新单据"==dh_div.textContent||edited)return notifier.show("请先保存单据","danger"),!1;let that=this;alert_confirm("单据记账后，编辑需要权限，确认记账吗？",{confirmText:"确认",cancelText:"取消",confirmCallBack:()=>{fetch(`/${code}/make_formal`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh_div.textContent)}).then((response=>response.json())).then((content=>{-1!=content?(that.textContent="已记账",that.classList.add("remembered"),notifier.show("记账完成","success")):notifier.show("权限不够","danger")}))}})})),document.querySelector("#modal-close-button").addEventListener("click",(function(){close_modal()})),document.querySelector(".top-close").addEventListener("click",(function(){close_modal()})),document.querySelector("#modal-sumit-button").addEventListener("click",(function(){let selected_row=document.querySelector("table .focus");selected_row?chose_exit(selected_row):notifier.show("请先选择再提交","danger")})),window.onbeforeunload=function(e){edited&&((e=window.event||e).returnValue="编辑未保存提醒")};