import{notifier}from"./notifier.mjs";import{alert_confirm}from"./alert.mjs";import{auto_table,AutoInput}from"./autocomplete.mjs";import*as service from"./service.mjs";import{SPLITER,getLeft,getTop,goto_tabindex,enterToTab}from"./tools.mjs";import{close_modal,modal_init}from"./modal.mjs";let all_width;var input_data={container:document.querySelector(".table-items"),width:document.querySelector(".content").clientWidth-document.querySelector(".table-history").clientWidth-15,show_names:"",document:"入库单据"};export var input_table_outdata={};document.querySelector("#row-insert").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");if(edit){let table_body=document.querySelector(".table-items tbody"),input_row=build_input_row(input_data.show_names,all_width);remove_inputting(),table_body.insertBefore(input_row,edit),rebuild_index(),sum_records(),keep_up(),input_row.querySelector("td:nth-child(2)").click()}else notifier.show("请先选择行","danger")})),document.querySelector("#row-del").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");edit?alert_confirm("确认删除行吗？",{confirmCallBack:()=>{edit.parentNode.removeChild(edit),sum_records(),rebuild_index(),keep_up(),"function"==typeof input_data.change_func&&input_data.change_func()}}):notifier.show("请先选择行","danger")})),document.querySelector("#row-up").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");edit?edit.previousElementSibling&&(edit.parentNode.insertBefore(edit,edit.previousElementSibling),rebuild_index()):notifier.show("请先选择行","danger")})),document.querySelector("#row-down").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");edit?edit.nextElementSibling&&""!=edit.nextElementSibling.querySelector("td:nth-child(1)").textContent&&(edit.parentNode.insertBefore(edit.nextElementSibling,edit),rebuild_index()):notifier.show("请先选择行","danger")}));export function build_blank_table(data){Object.assign(input_data,data);build_blank_th();let tbody=input_data.container.querySelector("tbody"),rows="";for(let i=0;i<input_data.lines;i++)rows+=input_data.blank_row;tbody.innerHTML=rows,tbody.style.height=33*input_data.lines+"px"}export function build_out_table(data){Object.assign(input_data,data);let tbody=input_data.container.querySelector("tbody"),trs=tbody.querySelectorAll("tr");for(let tr of trs)tr.classList.contains("has-input")||tr.parentNode.removeChild(tr);let num=tbody.querySelectorAll(".has-input").length+1,n=input_data.num?input_data.num:1;for(let i=0;i<n;i++){"function"==typeof input_data.show_names_fn&&input_data.show_names_fn(i);let input_row=build_input_row(input_data.show_names,all_width,num);tbody.appendChild(input_row),num+=1}append_blanks(tbody,num)}export function appand_edit_row(){let tbody=input_data.container.querySelector("tbody"),trs=tbody.querySelectorAll("tr");for(let tr of trs)tr.classList.contains("has-input")||tr.parentNode.removeChild(tr);for(let i in input_data.show_names)input_data.show_names[i].value=input_data.show_names[i].default?input_data.show_names[i].default:"";let num=tbody.querySelectorAll(".has-input").length+1,input_row=build_input_row(input_data.show_names,all_width,num);tbody.appendChild(input_row),num+=1,append_blanks(tbody,num)}function build_blank_th(){input_data.container.style.width=input_data.width,all_width=0,input_data.show_names.forEach((obj=>{all_width+=obj.width}));let th="<tr>",blank="<tr>";input_data.show_names.forEach((obj=>{let hidden=obj.css?obj.css:"";th+=`<th width=${100*obj.width/all_width} ${hidden}>${obj.name}</th>`,blank+=`<td width=${100*obj.width/all_width} ${hidden}></td>`})),th+="</tr>",blank+="</tr>",input_data.container.querySelector("thead").innerHTML=th,input_data.blank_row=blank}export function build_items_table(data){Object.assign(input_data,data);build_blank_th();let tbody=input_data.container.querySelector("tbody"),num=1;for(let row of input_data.rows){let row_data=row.split(SPLITER);for(let i=1;i<input_data.show_names.length;i++)input_data.show_names[i].value=row_data[i-1];let input_row=build_input_row(input_data.show_names,all_width,num);tbody.appendChild(input_row),num+=1}tbody.style.height=33*input_data.lines+"px",append_blanks(tbody,num),"function"==typeof input_data.change_func&&input_data.change_func()}function append_blanks(tbody,num){for(let i in input_data.show_names)void 0===input_data.show_names[i].value&&(input_data.show_names[i].value="");keep_up();let rows="";for(let i=0;i<input_data.lines-num+1;i++)rows+=input_data.blank_row;tbody.querySelector("tr:nth-last-child(1)").insertAdjacentHTML("afterend",rows),setTimeout((()=>{sum_records()}),100)}function build_edit_string(show_names,all_width){let control="",m_id=show_names[show_names.length-1].value,idx=1;for(let obj of show_names){let hidden=obj.css?obj.css:"";if("普通输入"==obj.type&&obj.editable)control+=`<td width=${100*obj.width/all_width} class="editable" ${hidden}>\n            <input class="form-control input-sm has-value ${obj.class}" type="text" idx="${idx++}" value=${obj.value?obj.value:""}></td>`;else if("普通输入"!=obj.type||obj.editable)if("二值选一"==obj.type&&obj.editable){let checked;checked=obj.value?obj.value:"",control+=`<td width=${100*obj.width/all_width} class="editable" ${hidden}><label class="check-radio">\n                                <input class="has-value ${obj.class}" type="checkbox" ${checked}>\n                                <span class="checkmark"></span>\n                            </label>\n                        </td>`}else if("二值选一"!=obj.type||obj.editable)if("下拉列表"==obj.type&&obj.editable){control+=`<td width=${100*obj.width/all_width} class="editable" ${hidden}><select class='select-sm has-value'>`;let options=obj.default.split("_");for(let value of options){control+=`<option value="${value}" ${value==obj.value?"select":""}>${value}</option>`}control+="</select></td>"}else if("下拉列表"!=obj.type||obj.editable){if("autocomplete"==obj.type&&obj.editable){let button=obj.no_button?"":"<button class='btn btn-info btn-sm product-search-button'> ... </button>";control+=`\n            <td width=${100*obj.width/all_width} class="editable" >\n                <div class="form-input autocomplete" style="z-index: 900; position: inherit">\n                    <input class="form-control input-sm has-value auto-input ${obj.class}" type="text" \n                        value="${obj.value}" idx="${idx++}" data="${m_id}">                        \n                    ${button}\n                </div>\n            </td>`}}else control+=`<td width=${100*obj.width/all_width}>${obj.value?obj.value:""} ${hidden}</td>`;else control+=`<td width=${100*obj.width/all_width}>${obj.value?obj.value:""} ${hidden}</td>`;else control+=`<td width=${100*obj.width/all_width} class='${obj.class}' ${hidden}>${obj.value?obj.value:""} </td>`}return control}function leftright_key_move(event,row,input){var e=event||window.event;if("ArrowLeft"==e.code){if(0==input.selectionStart){let tabindex=input.getAttribute("idx");goto_tabindex(row,--tabindex)}}else if("ArrowRight"==e.code&&input.selectionEnd==input.value.length){let tabindex=input.getAttribute("idx");goto_tabindex(row,++tabindex)}}function updown_key_move(event,row,input,all_inputs){var e=event||window.event;if("ArrowUp"==e.code){let n=row.querySelector("td:nth-child(1)").textContent;if("1"!=n){let tr=all_inputs[n-2],tabindex=input.getAttribute("idx");goto_tabindex(tr,tabindex),remove_inputting(),tr.classList.add("inputting")}}else if("ArrowDown"==e.code){let n=row.querySelector("td:nth-child(1)").textContent;if(n!=all_inputs.length){let tr=all_inputs[n],tabindex=input.getAttribute("idx");goto_tabindex(tr,tabindex),remove_inputting(),tr.classList.add("inputting")}}}function enter_key_move(event,row,input,next_tr,max_idx){var e=event||window.event;if("Enter"==e.code||"NumpadEnter"==e.code){enterToTab(row,input,max_idx)>max_idx&&(next_tr.classList.contains("has-input")?goto_tabindex(next_tr,1):goto_tabindex(row,1))}}function auto_input_handle(input_row,auto_data){for(let auto of auto_data){let th=document.querySelector(`.table-items th:nth-child(${auto.n})`),td=input_row.querySelector(`td:nth-child(${auto.n})`),data={auto_th:th,auto_td:td,auto_input:td.querySelector(".auto-input")};if(Object.assign(auto,data),auto.auto_td.addEventListener("click",(function(){element_position(this,7.4,1)})),auto.auto_input.addEventListener("focus",(function(){remove_inputting(),this.parentNode.parentNode.parentNode.classList.add("inputting")})),auto.type&&"table"!=auto.type){new AutoInput(auto.auto_input,auto.cate,auto.auto_url,"",auto.width).init()}else auto_table(auto.auto_input,auto.cate,auto.auto_url,auto.show_th,auto.cb,auto.cf)}}function build_input_row(show_names,all_width,num){num||(num=1);let input_row=document.createElement("tr");input_row.classList.add("has-input"),input_row.innerHTML=build_edit_string(show_names,all_width),input_data.auto_data&&auto_input_handle(input_row,input_data.auto_data),input_row.addEventListener("click",(function(){remove_inputting(),this.classList.add("inputting")})),input_row.querySelector("td:nth-child(1)").textContent=num,input_row.querySelector(".product-search-button")&&input_row.querySelector(".product-search-button").addEventListener("click",(function(){if(!this.parentNode.parentNode.parentNode.classList.contains("inputting"))return!1;service.sales_products("选择商品")})),"function"==typeof input_data.calc_func&&input_data.calc_func(input_row),"function"==typeof input_data.calc_func2&&input_data.calc_func2(input_row);let max_n=input_row.querySelectorAll("input").length;return input_row.querySelectorAll("input").forEach((input=>input.onkeydown=e=>{document.querySelectorAll(".table-items .has-input");let next_tr=document.querySelector(".table-items .inputting+tr");enter_key_move(e,input_row,input,next_tr,max_n),leftright_key_move(e,input_row,input)})),input_row}function sum_records(){let all_input=document.querySelectorAll(".has-input"),num=0;for(let i=0;i<all_input.length;i++)""==all_input[i].querySelector("td:nth-child(3)").textContent.trim()&&""==all_input[i].querySelector("td:nth-child(2) input").value.trim()||num++;document.querySelector("#total-records").innerHTML=num}function rebuild_index(){let all_input=document.querySelectorAll(".has-input");for(let i=0;i<all_input.length;i++)all_input[i].querySelector("td:nth-child(1)").textContent=i+1}function keep_up(){document.querySelectorAll(".table-items tbody tr").length>input_data.lines?document.querySelector(".table-items thead").style.width="calc(100% - 1.07em)":document.querySelector(".table-items thead").style.width="100%"}function remove_inputting(){let all_has_input=document.querySelectorAll(".has-input");for(let input of all_has_input)input.classList.remove("inputting")}function remove_absolute(){let all_auto=document.querySelectorAll(".table-items .autocomplete");for(let auto of all_auto)auto.classList.remove("auto-edit"),auto.style.left="",auto.style.top=""}function element_position(element,add_x,add_y){if(element.querySelector(".autocomplete").classList.contains("auto-edit"))return!1;let tbody=document.querySelector(".table-items tbody"),x=getLeft(element,tbody),y=getTop(element,tbody),auto_div=element.querySelector(".autocomplete");auto_div.style.left=x+add_x+"px",auto_div.style.top=y+add_y+"px",element.querySelector(".autocomplete").classList.add("auto-edit")}document.querySelector("#modal-sumit-button").addEventListener("click",(function(e){if("选择商品"==document.querySelector(".modal-title").textContent){e.stopImmediatePropagation();let selected_row=document.querySelector("table .focus");selected_row?service.chose_exit(selected_row,input_data.auto_data[0].cb):notifier.show("请先选择再提交","danger")}}),!1),modal_init();