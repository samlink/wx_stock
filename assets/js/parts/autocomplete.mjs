import{SPLITER,getLeft,getTop}from"../parts/tools.mjs";export class AutoInput{constructor(input,cate,url,cb,width){this.input=input,this.cate=cate,this.url=url,this.cb=cb,this.space=400,this.width=width}init(){var currentFocus,input=this.input,cb=this.cb,width=this.width;function addActive(x){if(!x)return!1;!function(x){for(var i=0;i<x.length;i++)x[i].classList.remove("autocomplete-active")}(x),currentFocus>=x.length&&(currentFocus=0),currentFocus<0&&(currentFocus=x.length-1),x[currentFocus].classList.add("autocomplete-active")}function closeAllLists(elmnt){var x=document.querySelector(".autocomplete-items");x&&elmnt!=x&&elmnt!=input&&x.parentNode.removeChild(x)}input.addEventListener("input",(()=>{var a,b,i,get_url,val=input.value,space=this.space;if(closeAllLists(),!val)return!1;currentFocus=-1,get_url=""==this.cate?`${this.url}?s=${val}`:"string"==typeof this.cate?`${this.url}?s=${val}&cate=${this.cate}`:`${this.url}?s=${val}&cate=${this.cate.textContent}`,fetch(get_url).then((response=>response.json())).then((function(arr){if(-1!=arr&&arr.length>0){(a=document.createElement("DIV")).setAttribute("id","autocomplete-list"),a.setAttribute("class","autocomplete-items"),input.parentNode.appendChild(a);let top=getTop(input,document.querySelector("body"))+30,left=getLeft(input,document.querySelector("body")),au_width=width||input.clientWidth;for(a.style.cssText=`position:fixed; top: ${top}px; left: ${left}px; width: ${au_width}px;`,i=0;i<arr.length;i++)(b=document.createElement("DIV")).innerHTML=arr[i].label,b.innerHTML+="<input type='hidden' id='"+arr[i].id+"' value='"+arr[i].label+"'>",b.addEventListener("click",(function(e){e.stopPropagation(),input.value=this.querySelector("input").value,input.setAttribute("data",this.querySelector("input").getAttribute("id")),closeAllLists(),cb&&"function"==typeof cb&&cb()})),a.appendChild(b),b.style.width=.93*au_width+"px";a.clientHeight>space&&(a.style.top=-(a.clientHeight-space+30)+"px",a.style.left="120px",a.style.borderTop="1px solid #9acffa")}}))})),input.addEventListener("keydown",(function(e){var x=document.querySelectorAll("#autocomplete-list div");x.length>0&&("ArrowDown"==e.key?(currentFocus++,addActive(x)):"ArrowUp"==e.key?(currentFocus--,addActive(x)):"Enter"==e.key?(e.preventDefault(),currentFocus>-1?x[currentFocus].click():x[0].click()):"Escape"==e.key?closeAllLists():"Tab"==e.key&&(e.preventDefault(),currentFocus>-1?x[currentFocus].click():x[0].click()))})),document.addEventListener("click",(function(e){closeAllLists(e.target)}))}}export function auto_table(input,cate,url,thead,cb,cf){var currentFocus;function addActive(x){if(!x)return!1;!function(x){for(var i=0;i<x.length;i++)x[i].classList.remove("autocomplete-active")}(x),currentFocus>=x.length&&(currentFocus=0),currentFocus<0&&(currentFocus=x.length-1),x[currentFocus].classList.add("autocomplete-active")}function closeAllLists(elmnt){var x=document.querySelector(".autocomplete-items");x&&elmnt!=x&&elmnt!=input&&x.parentNode.removeChild(x)}input.addEventListener("input",(function(e){var a,i,val=this.value;if(closeAllLists(),!val)return!1;let get_url;if(currentFocus=-1,""!=cate){let c="string"==typeof cate?cate:cate.textContent;get_url=`${url}?s=${val}&cate=${c}`}else get_url=`${url}?s=${val}`;"function"==typeof cf&&(get_url+=`&ss=${cf()}`),fetch(get_url).then((response=>response.json())).then((function(arr){if(-1!=arr&&arr.length>0){(a=document.createElement("DIV")).setAttribute("id","autocomplete-list"),a.setAttribute("class","autocomplete-items table-auto"),a.innerHTML="<table><thead><tr></tr></thead><tbody></tbody></table>",input.parentNode.appendChild(a);let ths="";for(let i=0;i<thead.length;i++)ths+=`<th width=${thead[i].width}>${thead[i].name}</th>`;document.querySelector(".table-auto thead tr").innerHTML=ths;let tbody=document.querySelector(".table-auto tbody");for(i=0;i<arr.length;i++){let items=arr[i].label.split(SPLITER),tr=document.createElement("tr");tr.setAttribute("data",`${arr[i].id}${SPLITER}${arr[i].label}`);let row="";for(let i=0;i<items.length;i++)row+=`<td width=${thead[i].width}>${items[i]}</td>`;tr.innerHTML=row,tr.addEventListener("click",(function(e){e.stopPropagation(),input.value=this.querySelector("td:nth-child(1)").textContent,input.setAttribute("data",this.getAttribute("data")),closeAllLists(),cb&&"function"==typeof cb&&cb()})),tbody.appendChild(tr)}}}))})),input.addEventListener("keydown",(function(e){var x=document.querySelectorAll("#autocomplete-list tbody tr");x.length>0&&("ArrowDown"==e.key?(currentFocus++,addActive(x)):"ArrowUp"==e.key?(currentFocus--,addActive(x)):"Enter"==e.key?(e.preventDefault(),currentFocus>-1?x[currentFocus].click():x[0].click()):"Escape"==e.key?closeAllLists():"Tab"==e.key&&(e.preventDefault(),currentFocus>-1?x[currentFocus].click():x[0].click()))})),document.addEventListener("click",(function(e){closeAllLists(e.target)}))}