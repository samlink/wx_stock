import{table_data,table_init,fetch_table}from"../parts/table.mjs";import{notifier}from"../parts/notifier.mjs";import{alert_confirm}from"../parts/alert.mjs";import{getHeight}from"../parts/tools.mjs";let get_height=getHeight()-178,row_num=Math.floor(get_height/30);var data={container:".table-users",header_names:{"序号":"confirm","用户名":"name","职务":"duty","手机号":"phone","区域":"area","工作权限":"rights","是否确认":"confirm"},url:"/pull_users",post_data:{id:"",name:"",sort:"confirm ASC, duty DESC",rec:row_num,cate:""},edit:!1,row_fn:function(tr){let con="已确认",color="green";return 0==tr.confirm&&(con="未确认",color="red"),`<tr><td>${tr.num}</td><td>${tr.name}</td>\n                <td>${tr.duty}</td><td>${tr.phone}</td><td>${tr.area}</td>\n                <td title='${tr.rights}'>${tr.rights}</td><td><span class='confirm-info ${color}'>${con}</span></td></tr>`},blank_row_fn:function(){return"<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>"},row_click:function(tr){document.querySelector(".rights-top").textContent=`工作权限 - ${tr.children[1].textContent}：`;let rights_arr=tr.children[5].textContent.split("，"),rights_checks=document.querySelectorAll(".rights-show table input[type=checkbox");for(let check of rights_checks)check.checked=!1,check.parentNode.removeAttribute("style");for(let right of rights_arr)for(let check of rights_checks)if(right==check.value){check.checked=!0,check.parentNode.setAttribute("style","font-weight: 600;color:#36ad82");break}}};table_init(data),fetch_table((()=>{let right_show=document.querySelector(".rights-show"),table_height=document.querySelector(".table-users").clientHeight;right_show.style.height=table_height})),document.querySelector("#serach-button").addEventListener("click",(function(){if(!table_data.edit){let search=document.querySelector("#search-input").value;Object.assign(table_data.post_data,{name:search}),fetch_table()}}));var rights={goods_buy:["材料采购","采购查询"],goods_sale:["商品销售","销售查询","跨区查库存","财务开票"],goods_manage:["库存状态","采购入库","销售出库","调整库存","入库查询","出库查询","调库查询"],customers:["客户管理","供应商管理"],statics:["入库明细","出库明细","业务往来"],setup:["用户设置","库存设置","单据审核","反审单据","批量导入","导出数据"]};let rows="";for(let i=0;i<row_num;i++){let goods_buy=rights.goods_buy.hasOwnProperty(i)?rights.goods_buy[i]:"",goods_sale=rights.goods_sale.hasOwnProperty(i)?rights.goods_sale[i]:"",goods_manage=rights.goods_manage.hasOwnProperty(i)?rights.goods_manage[i]:"",customers=rights.customers.hasOwnProperty(i)?rights.customers[i]:"",statics=rights.statics.hasOwnProperty(i)?rights.statics[i]:"",setup=rights.setup.hasOwnProperty(i)?rights.setup[i]:"";rows+=`<tr><td>${""!=goods_buy?`<label class="check-radio"><input type="checkbox" class="um_goods_buy" value="${goods_buy}">\n                            <span class="checkmark"></span>${goods_buy}</label>`:""}</td><td>${""!=goods_sale?`<label class="check-radio"><input type="checkbox" class="um_goods_sale" value="${goods_sale}">\n                            <span class="checkmark"></span>${goods_sale}</label>`:""}</td><td>${""!=goods_manage?`<label class="check-radio"><input type="checkbox" class="um_goods_manage" value="${goods_manage}">\n                            <span class="checkmark"></span>${goods_manage}</label>`:""}</td><td>${""!=customers?`<label class="check-radio"><input type="checkbox" class="um_customers" value="${customers}">\n                            <span class="checkmark"></span>${customers}</label>`:""}</td>\n            <td>${""!=statics?`<label class="check-radio"><input type="checkbox" class="um_statics" value="${statics}">\n                            <span class="checkmark"></span>${statics}</label>`:""}</td><td>${""!=setup?`<label class="check-radio"><input type="checkbox" class="um_setup" value="${setup}">\n                            <span class="checkmark"></span>${setup}</label>`:""}</td></tr>`}document.querySelector(".rights-show table tbody").innerHTML=rows,Object.keys(rights).forEach((function(key){document.querySelector("#um_"+key).addEventListener("click",(function(){let cate=document.querySelector("#um_"+key),all=document.querySelectorAll(".um_"+key);for(let item of all)item.checked=!!cate.checked}))}));let all_checks=document.querySelectorAll(".rights-show table input[type=checkbox]");for(let check of all_checks)check.disabled=!0;let confirm_save,select_save,marks=document.querySelectorAll(".rights-show .checkmark");for(let mark of marks)mark.setAttribute("style","background: lightgrey; border: none;");document.querySelector("#edit-button").addEventListener("click",(function(){let focus=document.querySelector(".table-users .focus");if(focus){document.querySelector("#edit-button").classList.add("hide"),document.querySelector("#del-button").classList.add("hide"),document.querySelector("#sumit-button").classList.remove("hide"),document.querySelector("#cancel-button").classList.remove("hide");for(let mark of marks)mark.removeAttribute("style");for(let check of all_checks)check.disabled=!1;table_data.edit=!0,confirm_save=focus.children[6].textContent,select_save=focus.children[2].textContent;let select="<select class='select-sm'>",options="admin"==document.querySelector("#user-name").textContent.split("　")[1]?["总经理","主管","销售","库管","质检","财务"]:["主管","销售","库管","质检","财务"];for(let value of options){select+=`<option value="${value}" ${value==select_save?"selected":""}>${value}</option>`}select+="</select>",focus.children[2].innerHTML=select;let confirm="未确认"==confirm_save?"":"checked";focus.children[6].innerHTML=`<label class="check-radio"><input type="checkbox" ${confirm}>\n                                                <span class="checkmark"></span></label>`,focus.children[6].setAttribute("style","padding-top: 0;")}else notifier.show("请先选择用户","danger")})),document.querySelector("#cancel-button").addEventListener("click",(function(){let focus=document.querySelector(".table-users .focus");document.querySelector("#edit-button").classList.remove("hide"),document.querySelector("#del-button").classList.remove("hide"),document.querySelector("#sumit-button").classList.add("hide"),document.querySelector("#cancel-button").classList.add("hide");for(let mark of marks)mark.setAttribute("style","background: lightgrey; border: none;");for(let check of all_checks)check.disabled=!0;table_data.edit=!1,focus.children[2].innerHTML=select_save;let confirm="未确认"==confirm_save?'<span class="confirm-info red">未确认</span>':'<span class="confirm-info green">已确认</span>';focus.children[6].innerHTML=confirm,focus.children[6].removeAttribute("style"),focus.click()})),document.querySelector("#sumit-button").addEventListener("click",(function(){let focus=document.querySelector(".table-users .focus");select_save=focus.querySelector("select").value;let confirm=focus.children[6].querySelector("input").checked,rights_checks=document.querySelectorAll(".rights-show tbody input[type=checkbox"),rights="";for(let check of rights_checks)1==check.checked&&(rights+=check.value+"，");let data={name:focus.children[1].textContent,duty:select_save,confirm:confirm,rights:rights};fetch("/edit_user",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{1==content?(confirm_save=confirm?"已确认":"未确认",focus.children[5].innerHTML=rights,focus.children[5].setAttribute("title",rights),document.querySelector("#cancel-button").click(),notifier.show("用户修改成功","success")):notifier.show("权限不够，操作失败","danger")}))})),document.querySelector("#del-button").addEventListener("click",(function(){let focus=document.querySelector(".table-users .focus");if(focus){let name=focus.children[1].textContent;"总经理"==focus.children[2].textContent?notifier.show("无法删除超级用户","danger"):name==document.querySelector("#user-name").textContent?notifier.show("无法删除用户自己","danger"):alert_confirm("确认删除用户 "+name+" 吗？",{confirmCallBack:()=>{let data={name:name};fetch("/del_user",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{1==content?(fetch_table(table_data.post_data),notifier.show("用户删除完成","success")):notifier.show("权限不够，操作失败","danger")}))}})}else notifier.show("请选择用户","danger")}));