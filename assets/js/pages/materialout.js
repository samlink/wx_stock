import{notifier}from"../parts/notifier.mjs";import{alert_confirm}from"../parts/alert.mjs";import{AutoInput}from"../parts/autocomplete.mjs";import*as service from"../parts/service.mjs";import{SPLITER,regInt,regReal,regDate,moneyUppercase,checkFileType,append_cells,append_blanks,set_key_move}from"../parts/tools.mjs";import{build_blank_table,build_items_table,build_out_table,input_table_outdata}from"../parts/edit_table.mjs";import{close_modal,modal_init}from"../parts/modal.mjs";let document_table_fields,table_lines,show_names,edited,document_name,document_bz=document.querySelector("#document-bz").textContent.trim(),dh_div=document.querySelector("#dh");function set_readonly(){let all_edit=document.querySelectorAll(".fields-show input");for(let edit of all_edit)"备注"!=edit.id&&(edit.disabled=!0);setTimeout((()=>{document.querySelectorAll(".table-items tbody input").forEach((input=>{input.disabled=!0}))}),100),document.querySelector("#pic-button").setAttribute("disabled",!0),service.edit_button_disabled()}function document_top_handle(html,has_date){document.querySelector(".fields-show").innerHTML=html;document.querySelector(".has-auto"),document.querySelector(".has-auto+div");let auto_doc=document.querySelector("#文本字段6");auto_doc.parentNode.classList.add("autocomplete"),new AutoInput(auto_doc,"商品销售","/materialout_auto",(()=>{build_items(auto_doc.getAttribute("data"))})).init();let date=document.querySelector("#日期");has_date||(date.value=(new Date).Format("yyyy-MM-dd")),laydate.render({elem:date,showBottom:!1});let all_input=document.querySelectorAll(".fields-show input"),form=document.querySelector(".fields-show");set_key_move(all_input,form,5),service.set_sumit_shen(),document.querySelector("#sumit-shen").addEventListener("click",(function(){let shen_data={button:this,dh:dh_div.textContent,document_name:document_name,edited:edited||input_table_outdata.edited};service.sumit_shen(shen_data)}))}-1!=document_bz.indexOf("入库")?document_name="入库单据":-1!=document_bz.indexOf("出库")&&(document_name="出库单据"),fetch("/fetch_inout_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(document_name)}).then((response=>response.json())).then((content=>{if(-1!=content)if(document_table_fields=content,"新单据"!=dh_div.textContent)fetch("/fetch_document_ck",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:document_name,dh:dh_div.textContent})}).then((response=>response.json())).then((data=>{document_top_handle(service.build_inout_form(document_table_fields,data),!0),build_items(document.querySelector("#文本字段6").value);let da=data.split(SPLITER),pic=da[da.length-3].replace("pic_","min_");pic.startsWith("/upload")&&document.querySelector("#upload-pic").setAttribute("src",`${pic}?${Math.random()}`);let set_data={content:data,readonly_fun:set_readonly,focus_fun:()=>{setTimeout((()=>{document.querySelector("#文本字段6").focus()}),200)}};service.set_shens_owner(set_data)}));else{document_top_handle(service.build_inout_form(content),!1),document.querySelector("#remember-button").textContent="审核",setTimeout((()=>{document.querySelector("#文本字段6").focus()}),200)}})),service.get_materials_docs("/materialsale_docs","商品销售",build_items);let show_th=[{name:"物料号",width:60},{name:"名称",width:60},{name:"材质",width:80},{name:"规格",width:80},{name:"状态",width:100},{name:"炉号",width:100},{name:"库存长度",width:80}],auto_data=[{n:10,cate:"",auto_url:"/material_auto_out",show_th:show_th,cb:fill_gg,cf:()=>document.querySelector(".table-items .inputting .m_id").textContent}];function build_items(dh){fetch("/get_docs_out",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh)}).then((response=>response.json())).then((content=>{let info=content.split(SPLITER);document.querySelector("#文本字段5").value=info[0],document.querySelector("#文本字段4").value=info[1],document.querySelector("#文本字段4").setAttribute("data",info[2])})),fetch("/get_items_out",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh)}).then((response=>response.json())).then((content=>{let tr="";content.forEach((obj=>{let material=obj.split(`${SPLITER}`);tr+=`<tr><td hidden>${material[0]}</td><td>${material[1]}</td><td hidden>${material[2]}</td></tr>`})),document.querySelector(".table-history tbody").innerHTML=tr;let lines=document.querySelectorAll(".table-history tbody tr");for(let l of lines)l.addEventListener("dblclick",(()=>{if("已审核"==document.querySelector("#remember-button").textContent||1==document.querySelector("#save-button").disabled)return!1;let value=l.querySelector("td:nth-child(2)").textContent.split("　");show_names[1].value=value[0],show_names[2].value=value[1],show_names[3].value=value[2],show_names[4].value=value[3],show_names[6].value=value[4],show_names[7].value=value[5],show_names[8].value=value[4]*value[5],show_names[9].value="",show_names[13].value=l.querySelector("td:nth-child(1)").textContent,show_names[14].value=l.querySelector("td:nth-child(3)").textContent;let data={show_names:show_names,lines:table_lines,dh:dh_div.textContent,auto_data:auto_data,document:document_name};build_out_table(data),edited=1}))}))}function fill_gg(){let field_values=document.querySelector(".inputting .auto-input").getAttribute("data").split(SPLITER);document.querySelector(".inputting .炉号").textContent=field_values[6];document.querySelector(".inputting .重量").focus()}if(show_names=[{name:"序号",width:10,class:"序号",type:"普通输入",editable:!1,is_save:!0},{name:"名称",width:40,class:"名称",type:"普通输入",editable:!1,is_save:!1},{name:"材质",width:60,class:"材质",type:"普通输入",editable:!1,is_save:!1},{name:"规格",width:60,class:"规格",type:"普通输入",editable:!1,is_save:!1},{name:"状态",width:80,class:"状态",type:"普通输入",editable:!1,is_save:!1},{name:"炉号",width:100,class:"炉号",type:"普通输入",editable:!1,is_save:!1},{name:"长度",width:30,class:"长度",type:"普通输入",editable:!1,is_save:!0},{name:"数量",width:30,class:"数量",type:"普通输入",editable:!0,is_save:!0},{name:"总长度",width:30,class:"总长度",type:"普通输入",editable:!1,is_save:!1},{name:"物料号",width:60,class:"物料号",type:"autocomplete",editable:!0,is_save:!0,no_button:!0},{name:"重量",width:30,class:"重量",type:"普通输入",editable:!0,is_save:!0},{name:"理论重量",width:30,class:"理论重量",type:"普通输入",editable:!1,is_save:!0},{name:"备注",width:100,class:"备注",type:"普通输入",editable:!0,is_save:!0,css:'style="border-right:none"'},{name:"",width:0,class:"m_id",type:"普通输入",editable:!1,is_save:!1,css:'style="width:0%; border-left:none; border-right:none; color:white"'},{name:"",width:0,class:"s_id",type:"普通输入",editable:!1,is_save:!0,css:'style="width:0%; border-left:none; color:white"'}],table_lines=Math.floor((document.querySelector("body").clientHeight-395)/33),"新单据"==dh_div.textContent){build_blank_table({show_names:show_names,lines:table_lines,dh:dh_div.textContent,document:document_name,calc_func:get_weight})}else fetch("/fetch_document_items_ck",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:document_name,dh:dh_div.textContent})}).then((response=>response.json())).then((content=>{let data={show_names:show_names,rows:content,lines:table_lines,auto_data:auto_data,dh:dh_div.textContent,document:document_name,calc_func:get_weight};build_items_table(data)}));function get_weight(input_row){input_row.querySelector(".数量").addEventListener("blur",(function(){let mount=input_row.querySelector(".数量").value;regInt.test(mount)?(input_row.querySelector(".总长度").textContent=mount*input_row.querySelector(".长度").textContent,weight(input_row)):input_row.querySelector(".总长度").textContent=0})),input_row.querySelector(".auto-input").addEventListener("blur",(function(){weight(input_row)}))}function weight(input_row){let data={long:input_row.querySelector(".总长度").textContent.trim(),num:1,name:input_row.querySelector(".名称").textContent.trim(),cz:input_row.querySelector(".材质").textContent.trim(),gg:input_row.querySelector(".规格").textContent.trim()};regInt.test(data.long)&&regInt.test(data.num)?input_row.querySelector(".理论重量").textContent=service.calc_weight(data):input_row.querySelector(".理论重量").textContent=0}let fileBtn=document.getElementById("pic_upload");function error_check(){let all_rows=document.querySelectorAll(".table-items .has-input");if(!service.header_error_check(document_table_fields,all_rows))return!1;for(let row of all_rows)if(""!=row.querySelector("td:nth-child(1)").textContent){if(""==row.querySelector(".auto-input").value.trim())return notifier.show("物料号不能为空","danger"),!1;if(row.querySelector(".重量").value&&!regReal.test(row.querySelector(".重量").value))return notifier.show("重量输入错误","danger"),!1;row.querySelector(".重量").value||(row.querySelector(".重量").value=0)}return!0}document.querySelector("#pic-button").addEventListener("click",(function(e){if("新单据"==dh_div.textContent)return notifier.show("请先保存单据","danger"),!1;e.preventDefault(),fileBtn.click()})),fileBtn.addEventListener("change",(()=>{document.querySelector("#pic-button").disabled="true";const fd=new FormData;fd.append("file",fileBtn.files[0]),fetch("/pic_in",{method:"POST",body:fd}).then((res=>res.json())).then((content=>{fetch("/pic_in_save",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(`${dh_div.textContent}${SPLITER}${content.substr(1,content.length-1)}`)}).then((response=>response.json())).then((content=>{-1==content?notifier.show("权限不够","danger"):-2==content?notifier.show("图片保存出错","danger"):(document.querySelector("#upload-pic").src=`${content}?${Math.random()}`,document.querySelector("#pic-button").disabled="",notifier.show("图片成功保存","success"))}))}))})),document.querySelector("#upload-pic").addEventListener("click",(()=>{let pic_html=`<div class = "form-input show-pic">\n                                <img width = "1190px" src = "${document.querySelector("#upload-pic").src.split("?")[0].replace("min_","pic_")+`?${Math.random()}`}" alt = "出库签字图">\n                            </div>`;document.querySelector(".modal-body").innerHTML=pic_html,document.querySelector(".modal-title").textContent="出库签字图",document.querySelector(".modal-dialog").style.cssText="max-width: 1230px;",document.querySelector(".modal").style.display="block",document.querySelector("#modal-sumit-button").style.display="none"})),modal_init(),document.querySelector("#save-button").addEventListener("click",(function(){if(!error_check())return!1;let all_values=document.querySelectorAll(".document-value"),custid=document.querySelector("#文本字段4").getAttribute("data"),save_str=`${document_bz}${SPLITER}${dh_div.textContent}${SPLITER}${custid}${SPLITER}`,n=0;for(let f of document_table_fields){if("文本"==f.data_type){save_str+=`${-1==f.show_name.indexOf("单号")?all_values[n].value:all_values[n].value.split("　")[0]}${SPLITER}`}else if("整数"==f.data_type||"实数"==f.data_type){save_str+=`${all_values[n].value?all_values[n].value:0}${SPLITER}`}else save_str+=`${all_values[n].checked?"是":"否"}${SPLITER}`;n++}let table_data=[],all_rows=document.querySelectorAll(".table-items .has-input");for(let row of all_rows)if(""!=row.querySelector("td:nth-child(1)").textContent){let len=show_names.length,save_str="";for(let i=0;i<len;i++)if(show_names[i].is_save)if("普通输入"==show_names[i].type||"autocomplete"==show_names[i].type||"下拉列表"==show_names[i].type){let value=row.querySelector(`.${show_names[i].class}`).value;value||(value=row.querySelector(`.${show_names[i].class}`).textContent),save_str+=`${value.trim()}${SPLITER}`}else{save_str+=`${(row.querySelector(`.${show_names[i].class}`).checked?"是":"否").trim()}${SPLITER}`}table_data.push(save_str)}let data={rights:document_bz,document:save_str,remember:document.querySelector("#remember-button").textContent,items:table_data};fetch("/save_material_ck",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{-1!=content?(dh_div.textContent=content,notifier.show("单据保存成功","success"),edited=!1,input_table_outdata.edited=!1):notifier.show("权限不够，操作失败","danger")}))})),document.querySelector("#print-button").addEventListener("click",(function(){document.querySelector("#print .print-title").textContent="五星(天津)石油装备有限公司-下料过磅单",document.querySelector("#p-block1").innerHTML=`<p>客户：${document.querySelector("#文本字段4").value}</p>`,document.querySelector("#p-block2").innerHTML=`<p>日期：${document.querySelector("#日期").value}</p>`,document.querySelector("#p-block3").innerHTML=`<p>合同号：${document.querySelector("#文本字段5").value}</p>`,document.querySelector("#p-block4").innerHTML=`<p> 单号：${document.querySelector("#dh").textContent}</p>`;document.querySelector(".print-table thead").innerHTML='<tr>\n        <th class = "center" width = "3%">序号</th>\n        <th class="center" width="7%">名称</th>\n        <th class="center" width="8%">材质</th>\n        <th class="center" width="6%">规格</th>\n        <th class="center" width="10%">状态</th>\n        <th class="center" width="7%">下料长度</th>\n        <th class="center" width="3%">支数</th>\n        <th class="center" width="7%">总长度</th>\n        <th class="center" width="10%">料号</th>        \n        <th class="center" width="8%">重量</th>\n        <th class="center" width="8%">剩余长度</th>\n        <th class="center" width="8%">备注</th>\n    </tr>';let sum=0,sum_long=0,all_rows=document.querySelectorAll(".table-items .has-input"),trs="";for(let row of all_rows){trs+="<tr>";for(let i=1;i<14;i++){if(11==i||12==i){trs+="<td></td>";continue}if(6==i)continue;let t=row.querySelector(`td:nth-child(${i}) input`),td=t?t.value:row.querySelector(`td:nth-child(${i})`).textContent;console.log(td),trs+=`<td>${td}</td>`}trs+="</tr>",sum+=Number(row.querySelector("td:nth-child(8) input").value),sum_long+=Number(row.querySelector("td:nth-child(9)").textContent)}let len=5-all_rows.length;trs+=append_blanks(len,12),trs+=`<tr class="sum-cell"><td class="center" colspan="2">合计</td>${append_cells(4)}\n            <td>${sum}</td><td>${sum_long}</td>${append_cells(4)}</tr>`,document.querySelector(".print-table tbody").innerHTML=trs,document.querySelector("#p-block5").innerHTML="<p>制单（仓库）：</p>",document.querySelector("#p-block6").innerHTML="<p>审核（销售）：</p>",document.querySelector("#p-block7").innerHTML="<p>下料员：</p>",document.querySelector("#p-block8").innerHTML="<p>过磅员：</p>",document.querySelector("#print .print-note").innerHTML="<p>注：此单一式三联，第一联（白）仓库，第二联（红）销售，第三联（黄）财务</p>",document.querySelector("#print").hidden=!1,Print("#print",{}),document.querySelector("#print").hidden=!0})),document.querySelector("#remember-button").addEventListener("click",(function(){let formal_data={button:this,dh:dh_div.textContent,document_name:document_name,edited:edited||input_table_outdata.edited,readonly_fun:set_readonly};service.make_formal(formal_data)})),window.onbeforeunload=function(e){(edited||input_table_outdata.edited)&&((e=window.event||e).returnValue="编辑未保存提醒")};