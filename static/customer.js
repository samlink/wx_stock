import{table_data,table_init,fetch_table}from"/assets/js/parts/table.mjs";import{notifier}from"/assets/js/parts/notifier.mjs";import{AutoInput}from"/assets/js/parts/autocomplete.mjs";import{regInt,regReal,getHeight,SPLITER,download_file,checkFileType}from"/assets/js/parts/tools.mjs";import*as service from"/assets/js/parts/service.mjs";import{modal_init,close_modal,leave_alert,modal_out_data}from"/assets/js/parts/modal.mjs";let table_fields,cus_cate=document.querySelector("#category").textContent,global={row_id:0,edit:0,eidt_cate:""},get_height=getHeight()-198,row_num=Math.floor(get_height/30),table_name={name:cus_cate},init_data={container:".table-customer",url:"/fetch_customer",post_data:{id:"",name:"",sort:"名称 ASC",rec:row_num,cate:cus_cate},edit:!1,row_fn:table_row,blank_row_fn:blank_row};function table_row(tr){let rec=tr.split(SPLITER),row=`<tr><td style="text-align: center;">${rec[1]}</td><td hidden>${rec[0]}</td>`;return service.build_row_from_string(rec,row,table_fields)}function blank_row(){return service.build_blank_from_fields("<tr><td></td><td hidden></td>",table_fields)}fetch("/fetch_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(table_name)}).then((response=>response.json())).then((content=>{if(-1!=content){table_fields=content[0].filter((item=>item.is_show));let table=document.querySelector(".table-customer"),custom_fields=[{name:"序号",width:3}],data=service.build_table_header(table,custom_fields,table_fields,"","customers");table.querySelector("thead tr").innerHTML=data.th_row,init_data.header_names=data.header_names,table_init(init_data),fetch_table()}}));let search_input=document.querySelector("#search-input"),auto_comp=new AutoInput(search_input,document.querySelector("#category"),"customer_auto",(()=>{search_table()}));function search_table(){let search=document.querySelector("#search-input").value;Object.assign(table_data.post_data,{name:search,page:1}),fetch_table()}auto_comp.init(),modal_init(),document.querySelector("#serach-button").addEventListener("click",(function(){search_table()})),document.querySelector("#add-button").addEventListener("click",(function(){global.eidt_cate="add",document.querySelector(".modal-body").innerHTML=service.build_add_form(table_fields),document.querySelector(".modal-title").textContent="增加"+cus_cate,document.querySelector(".modal-dialog").style.cssText="max-width: 500px;",document.querySelector(".modal").style.display="block",document.querySelector(".modal-body input").focus(),leave_alert()})),document.querySelector("#edit-button").addEventListener("click",(function(){global.eidt_cate="edit";let chosed=document.querySelector("tbody .focus"),id=chosed?chosed.querySelector("td:nth-child(2)").textContent:"";""!=id?(global.row_id=id,document.querySelector(".modal-body").innerHTML=service.build_edit_form(3,table_fields,chosed),document.querySelector(".modal-title").textContent="编辑"+cus_cate,document.querySelector(".modal-dialog").style.cssText="max-width: 500px;",document.querySelector(".modal").style.display="block",document.querySelector(".modal-body input").focus(),leave_alert()):notifier.show("请先选择"+cus_cate,"danger")})),document.querySelector("#modal-sumit-button").addEventListener("click",(function(){if("add"==global.eidt_cate||"edit"==global.eidt_cate){let all_input=document.querySelectorAll(".has-value"),num=0;for(let input of all_input){if(""==input.value.trim()&&"备注"!=input.parentNode.querySelector("label").textContent&&"行号"!=input.parentNode.querySelector("label").textContent)return notifier.show("除了行号和备注外，不能为空","danger"),!1;if("整数"==table_fields[num].data_type&&!regInt.test(input.value)||"实数"==table_fields[num].data_type&&!regReal.test(input.value))return notifier.show("数字字段输入错误","danger"),!1;num++}let customer=`${global.row_id}${SPLITER}${global.row_id}${SPLITER}`,n=0;for(let input of all_input){let value;if("布尔"!=table_fields[n].data_type)value=input.value;else{let v=table_fields[n].option_value.split("_");value=input.checked?v[0]:v[1]}customer+=`${value}${SPLITER}`,n++}let data={data:customer,cate:cus_cate},url="edit"==global.eidt_cate?"/update_customer":"/add_customer";fetch(url,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{if(1==content){if(global.edit=0,modal_out_data.edit=0,notifier.show(cus_cate+"修改成功","success"),fetch_table(),"add"==global.eidt_cate)for(let input of all_input)input.value="";close_modal()}else notifier.show("权限不够，操作失败","danger")}))}else{let url="批量导入"==global.eidt_cate?"/customer_addin":"/customer_updatein";fetch(url,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:cus_cate})}).then((response=>response.json())).then((content=>{1==content?(notifier.show("批量操作成功","success"),fetch_table(),close_modal()):notifier.show("权限不够，操作失败","danger")}))}})),document.querySelector("#data-out").addEventListener("click",(function(){fetch("/customer_out",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:cus_cate})}).then((response=>response.json())).then((content=>{-1!=content?(download_file(`/download/${content}.xlsx`),notifier.show("成功导出至 Excel 文件","success")):notifier.show("权限不够，操作失败","danger")}))}));let fileBtn=document.getElementById("choose_file");document.getElementById("data-in").addEventListener("click",(function(){fileBtn.click()})),fileBtn.addEventListener("change",(()=>{data_in(fileBtn,"将追加","追加新数据，同时保留原数据","批量导入")}));let fileBtn_update=document.getElementById("choose_file2");function data_in(fileBtn,info1,info2,cate){if(checkFileType(fileBtn)){const fd=new FormData;fd.append("file",fileBtn.files[0]),fetch("客户"==cus_cate?"/customer_in":"/supplier_in",{method:"POST",body:fd}).then((res=>res.json())).then((content=>{if(-1!=content&&-2!=content){let rows="<div class='table-container table-customer'><table style='font-size: 12px;'><thead>",n=1;for(let item of content[0]){let arr_p=item.split(SPLITER),row="<tr>";if(1==n){for(let i=0;i<arr_p.length-1;i++)row+=`<th>${arr_p[i]}</th}>`;row+="</tr></thead><tbody>",n=2}else{for(let i=0;i<arr_p.length-1;i++)row+=`<td>${arr_p[i]}</td>`;row+="</tr>"}rows+=row}rows+="</tbody></table></div>",document.querySelector(".modal-body").innerHTML=rows;let message=content[1]>50?" (仅显示前 50 条）":"";document.querySelector(".modal-title").innerHTML=`${cate}信息${info1} ${content[1]} 条数据${message}：`,document.querySelector("#modal-info").innerHTML=`${cate}信息${info2}`,global.eidt_cate=cate,document.querySelector(".modal-dialog").style.cssText="max-width: 1200px;",document.querySelector(".modal").style.cssText="display: block",fileBtn.value=""}else-1==content?notifier.show("缺少操作权限","danger"):notifier.show("excel 表列数不符合","danger")}))}else notifier.show("需要 excel 文件","danger")}document.getElementById("data-update").addEventListener("click",(function(){fileBtn_update.click()})),fileBtn_update.addEventListener("change",(()=>{data_in(fileBtn_update,"将更新","更新数据，原数据将被替换，请谨慎操作！","批量更新")}));