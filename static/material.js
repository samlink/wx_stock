import{notifier}from"/assets/js/parts/notifier.mjs";import{alert_confirm}from"/assets/js/parts/alert.mjs";import{AutoInput}from"/assets/js/parts/autocomplete.mjs";import*as service from"/assets/js/parts/service.mjs";import{SPLITER,regInt,append_blanks,set_key_move,padZero}from"/assets/js/parts/tools.mjs";import{build_blank_table,build_items_table,build_out_table,input_table_outdata}from"/assets/js/parts/edit_table.mjs";import{modal_init}from"/assets/js/parts/modal.mjs";let document_table_fields,table_lines,show_names,edited,document_name,document_bz=document.querySelector("#document-bz").textContent.trim(),dh_div=document.querySelector("#dh");-1!=document_bz.indexOf("入库")?document_name="入库单据":-1!=document_bz.indexOf("出库")&&(document_name="出库单据"),fetch("/fetch_inout_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(document_name)}).then((response=>response.json())).then((content=>{if(-1!=content)if(document_table_fields=content,"新单据"!=dh_div.textContent)fetch("/fetch_document_rkd",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:document_name,dh:dh_div.textContent})}).then((response=>response.json())).then((data=>{document_top_handle(service.build_inout_form(document_table_fields,data),!0),build_items(document.querySelector("#文本字段6").value);let da=data.split(SPLITER),pic=da[da.length-6].replace("pic_","min_");pic.startsWith("/upload")&&document.querySelector("#upload-pic").setAttribute("src",`${pic}?${Math.random()}`);let set_data={content:data,readonly_fun:set_readonly,focus_fun:()=>{setTimeout((()=>{document.querySelector("#文本字段6").focus()}),200)}};service.set_shens_owner(set_data)}));else{document_top_handle(service.build_inout_form(content),!1),document.querySelector("#remember-button").textContent="审核",setTimeout((()=>{document.querySelector("#文本字段6").focus()}),200)}}));let standart=document.querySelector("#执行标准"),auto_comp=new AutoInput(standart,"执行标准","/get_status_auto");auto_comp.init();let position=document.querySelector("#库位"),auto_comp2=new AutoInput(position,"库位","/get_status_auto");function set_readonly(){let all_edit=document.querySelectorAll(".fields-show input");for(let edit of all_edit)"备注"!=edit.id&&(edit.disabled=!0);document.querySelector("#material-add").setAttribute("disabled",!0),document.querySelector("#pic-button").setAttribute("disabled",!0),setTimeout((()=>{document.querySelectorAll(".table-items tbody input").forEach((input=>{input.disabled=!0}))}),100),service.edit_button_disabled()}function document_top_handle(html,has_date){document.querySelector(".fields-show .table-head").innerHTML=html;let date=document.querySelector("#日期");if(has_date||(date.value=(new Date).Format("yyyy-MM-dd")),laydate.render({elem:date,showBottom:!1}),document.querySelector("#文本字段5")){let da=document.querySelector("#文本字段5");laydate.render({elem:da,showBottom:!1})}let all_input=document.querySelectorAll(".fields-show input"),form=document.querySelector(".fields-show");set_key_move(all_input,form,7),service.set_sumit_shen(),document.querySelector("#sumit-shen").addEventListener("click",(function(){let shen_data={button:this,dh:dh_div.textContent,document_name:document_name,edited:edited||input_table_outdata.edited};service.sumit_shen(shen_data)}))}auto_comp2.init(),service.get_materials_docs("/materialin_docs","材料采购",build_items);let lu_upload=document.querySelector("#lu_upload");function build_items(dh){fetch("/get_items",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh)}).then((response=>response.json())).then((content=>{let tr="";content.forEach((obj=>{let material=obj.split(`${SPLITER}`),done="true"==material[3]?"class='red'":"";tr+=`<tr ${done}><td hidden>${material[0]}</td><td>${material[1]}</td>\n                    <td hidden>${material[2]}</td></tr>`})),document.querySelector(".table-history tbody").innerHTML=tr;let lines=document.querySelectorAll(".table-history tbody tr");for(let l of lines)l.addEventListener("dblclick",(()=>{if("已审核"==document.querySelector("#remember-button").textContent||1==document.querySelector("#save-button").disabled)return!1;document.querySelector("#m_id").value=l.querySelector("td:nth-child(1)").textContent,document.querySelector("#d_id").value=l.querySelector("td:nth-child(3)").textContent;let na=l.querySelector("td:nth-child(2)").textContent.split("　");document.querySelector("#名称").value=na[0],document.querySelector("#材质").value=na[1],document.querySelector("#规格").value=na[2],document.querySelector("#状态").value=na[3],document.querySelector("#生产厂家").value=na[4],document.querySelector("#执行标准").value=na[5],document.querySelector("#炉号").focus()}))}))}if(document.querySelector("#lu_button").addEventListener("click",(e=>{if(""==document.querySelector("#炉号").value.trim())return notifier.show("请先输入炉号","danger"),!1;e.preventDefault(),lu_upload.click()})),lu_upload.addEventListener("change",(()=>{let lu_btn=document.querySelector("#lu_button"),lh=document.querySelector("#炉号").value.trim();lu_btn.disabled=!0;const fd=new FormData;fd.append("file",lu_upload.files[0]),fetch("/pdf_in",{method:"POST",body:fd}).then((res=>res.json())).then((content=>{fetch("/pdf_in_save",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(lh)}).then((response=>response.json())).then((content=>{-2==content?alert_confirm("炉号质保书已存在, 是否替换？",{confirmText:"确认",cancelText:"取消",confirmCallBack:()=>{fetch("/pdf_in_save",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(lh+" yyy")}).then((response=>response.json())).then((content=>{lu_btn.classList.add("remembered"),notifier.show("质保书成功保存","success")}))}}):(lu_btn.classList.add("remembered"),notifier.show("质保书成功保存","success")),lu_btn.disabled=""}))}))})),show_names=[{name:"序号",width:10,class:"序号",type:"普通输入",editable:!1,is_save:!0,default:""},{name:"名称",width:40,class:"名称",type:"普通输入",editable:!1,is_save:!1,default:""},{name:"材质",width:60,class:"材质",type:"普通输入",editable:!1,is_save:!1,default:""},{name:"规格",width:50,class:"规格",type:"普通输入",editable:!1,is_save:!0,default:""},{name:"状态",width:80,class:"状态",type:"普通输入",editable:!1,is_save:!0,default:""},{name:"炉号",width:100,class:"炉号",type:"普通输入",editable:!1,is_save:!0,default:""},{name:"执行标准",width:120,class:"执行标准",type:"普通输入",editable:!1,is_save:!0,default:""},{name:"生产厂家",width:70,class:"生产厂家",type:"普通输入",editable:!1,is_save:!0,default:""},{name:"库位",width:20,class:"库位",type:"普通输入",editable:!1,is_save:!0,default:""},{name:"物料号",width:60,class:"物料号",type:"普通输入",editable:!0,is_save:!0,default:""},{name:"长度",width:30,class:"长度",type:"普通输入",editable:!0,is_save:!0,default:""},{name:"重量",width:30,class:"重量",type:"普通输入",editable:!1,is_save:!0,default:""},{name:"合格",width:20,class:"合格",type:"二值选一",value:"checked",editable:!0,is_save:!0,default:""},{name:"备注",width:90,class:"备注",type:"普通输入",editable:!0,is_save:!0,default:"",css:'style="border-right:none"'},{name:"",width:0,class:"m_id",type:"普通输入",editable:!1,is_save:!0,default:"",css:'style="width:0%; border-left:none; border-right:none; color:white"'},{name:"",width:0,class:"d_id",type:"普通输入",editable:!1,is_save:!0,css:'style="width:0%; border-left:none; color:white"'}],table_lines=Math.floor((document.querySelector("body").clientHeight-395)/33),"新单据"==dh_div.textContent){build_blank_table({show_names:show_names,lines:table_lines,dh:dh_div.textContent,document:document_name,calc_func:get_weight,del_func:sum_weight})}else fetch("/fetch_document_items_rk",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:document_name,dh:dh_div.textContent})}).then((response=>response.json())).then((content=>{let data={show_names:show_names,rows:content,lines:table_lines,dh:dh_div.textContent,document:document_name,calc_func:get_weight,del_func:sum_weight};build_items_table(data)}));function get_weight(input_row){input_row.querySelector(".长度").addEventListener("blur",(function(){weight(input_row),sum_weight()}))}function weight(input_row){let data={long:input_row.querySelector(".长度").value.trim(),num:1,name:input_row.querySelector(".名称").textContent.trim(),cz:input_row.querySelector(".材质").textContent.trim(),gg:input_row.querySelector(".规格").textContent.trim()};regInt.test(data.long)&&regInt.test(data.num)?input_row.querySelector(".重量").textContent=service.calc_weight(data):input_row.querySelector(".重量").textContent=0}function sum_weight(){let all_input=document.querySelectorAll(".has-input"),sum=0;for(let i=0;i<all_input.length;i++)sum+=Number(all_input[i].querySelector(".重量").textContent);document.querySelector("#实数字段3")&&(document.querySelector("#实数字段3").value=sum.toFixed(Number(1)))}function make_complete(dh){fetch("/make_ck_complete",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh)})}function handle_not_pass(){let rows=document.querySelectorAll(".table-items .has-input"),dh="",cgdh="";for(let row of rows)if(0==row.querySelector(".合格").checked){cgdh=document.querySelector("#文本字段6").value,dh=document.querySelector("#dh").textContent.trim();break}""!=dh&&fetch("/handle_not_pass",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:cgdh,dh:dh})}).then((response=>response.json())).then((content=>{-1!=content&&alert_confirm("不合格材料已转入退货单 "+content,{cancel:!1,confirmText:"返回",confirmCallBack:()=>{}})}))}function error_check(){let all_rows=document.querySelectorAll(".table-items .has-input");if(!service.header_error_check(document_table_fields,all_rows))return!1;for(let row of all_rows)if(""!=row.querySelector("td:nth-child(1)").textContent){if(""==row.querySelector(".物料号").value.trim())return notifier.show("物料号不能为空","danger"),!1;if(row.querySelector(".长度").value&&!regInt.test(row.querySelector(".长度").value))return notifier.show("长度输入错误","danger"),!1;row.querySelector(".长度").value||(row.querySelector(".长度").value=0),""==row.querySelector(".重量").textContent.trim()&&(row.querySelector(".重量").textContent=0)}return!0}document.querySelector("#material-add").addEventListener("click",(function(){if(!document.querySelector("#名称").value)return notifier.show("采购条目输入有错误","danger"),!1;let n=document.querySelector("#数量").value;if(!n||!regInt.test(n)||n<=0)return notifier.show("数量输入有错误","danger"),!1;fetch("/fetch_max_num",{method:"get"}).then((response=>response.json())).then((content=>{let max_num=content;document.querySelectorAll(".table-items .has-input .物料号").forEach((num=>{let v=Number(num.value.replace("M",""));max_num<v&&(max_num=v)})),show_names[1].value=document.querySelector("#名称").value,show_names[2].value=document.querySelector("#材质").value,show_names[3].value=document.querySelector("#规格").value,show_names[4].value=document.querySelector("#状态").value,show_names[5].value=document.querySelector("#炉号").value,show_names[6].value=document.querySelector("#执行标准").value,show_names[7].value=document.querySelector("#生产厂家").value,show_names[8].value=document.querySelector("#库位").value,show_names[12].value="checked",show_names[14].value=document.querySelector("#m_id").value,show_names[15].value=document.querySelector("#d_id").value;let data={show_names:show_names,show_names_fn:function(n){this.show_names[9].value=`M${padZero(this.material_num+n+1,6)}`},num:n,lines:table_lines,dh:dh_div.textContent,document:document_name,material_num:max_num};build_out_table(data),edited=1}))})),service.handle_pic(dh_div,"/pic_in_save"),modal_init(),document.querySelector("#save-button").addEventListener("click",(function(){if(!error_check())return!1;let all_values=document.querySelectorAll(".document-value"),save_str=`${document_bz}${SPLITER}${dh_div.textContent}${SPLITER}`,n=0;for(let f of document_table_fields){if("文本"==f.data_type){save_str+=`${-1==f.show_name.indexOf("单号")?all_values[n].value:all_values[n].value.split("　")[0]}${SPLITER}`}else if("整数"==f.data_type||"实数"==f.data_type){save_str+=`${all_values[n].value?all_values[n].value:0}${SPLITER}`}else save_str+=`${all_values[n].checked?"是":"否"}${SPLITER}`;n++}let table_data=[],all_rows=document.querySelectorAll(".table-items .has-input");for(let row of all_rows)if(""!=row.querySelector("td:nth-child(1)").textContent){let save_str="";save_str+=service.build_save_items(0,row,show_names),table_data.push(save_str)}let data={rights:document_bz,document:save_str,remember:document.querySelector("#remember-button").textContent,items:table_data};fetch("/save_material",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{-1!=content?(dh_div.textContent=content,notifier.show("单据保存成功","success"),edited=!1,input_table_outdata.edited=!1):notifier.show("权限不够，操作失败","danger")}))})),document.querySelector("#print-button").addEventListener("click",(function(){if(!error_check())return!1;document.querySelector("#print .print-title").textContent="五星(天津)石油装备有限公司-原材料入库单",document.querySelector("#p-block1").innerHTML=`<p> 单号：${document.querySelector("#dh").textContent}</p>`,document.querySelector("#p-block2").innerHTML=`<p>日期：${document.querySelector("#日期").value}</p>`;document.querySelector(".print-table thead").innerHTML='<tr>\n        <th width="3%">序号</th>\n        <th width="5%">物料号</th>\n        <th width="5%">材质</th>\n        <th width="7%">规格</th>\n        <th width="7%">状态</th>\n        <th width="6%">炉号</th>\n        <th width="4%">长度</th>\n        <th width="3%">支数</th>\n        <th width="9%">执行标准</th>\n        <th width="6%">生产厂家</th>\n        <th width="6%">重量</th>\n    </tr>';let sum_weight=0,all_rows=document.querySelectorAll(".table-items .has-input"),trs="";for(let row of all_rows){trs+=`<tr><td>${row.querySelector("td:nth-child(1)").textContent}</td>\n                <td>${row.querySelector("td:nth-child(10) input").value}</td>`;for(let i=3;i<13;i++){if(7==i){let v=row.querySelector(`td:nth-child(${i})`).textContent,l=row.querySelector("td:nth-child(11) input").value;l="0"==l?"":l,trs+=`<td>${l}</td><td>1</td><td>${v}</td>`;continue}if(9==i||10==i||11==i)continue;let t=row.querySelector(`td:nth-child(${i}) input`),td=t?t.value:row.querySelector(`td:nth-child(${i})`).textContent;td=0==Number(td)?"":td,trs+=`<td>${td}</td>`}trs+="</tr>",sum_weight+=Number(row.querySelector("td:nth-child(12)").textContent)}let len=9-all_rows.length;trs+=append_blanks(len,11),trs+=`<tr style="height: 50px"><td colspan="7"></td><td>${all_rows.length}</td>\n            <td style="white-space: normal">来料重量：<br> ${document.querySelector("#实数字段1").value}</td>\n            <td>实际重量：<br> ${document.querySelector("#实数字段2").value}</td><td>理论重量：<br> ${sum_weight.toFixed(1)}</td>`,document.querySelector(".print-table tbody").innerHTML=trs,document.querySelector("#p-block5").innerHTML="<p>采购：</p>",document.querySelector("#p-block6").innerHTML="<p>财务：</p>",document.querySelector("#p-block7").innerHTML="<p>质检：</p>",document.querySelector("#p-block8").innerHTML="<p>仓库：</p>",document.querySelector("#print").hidden=!1,Print("#print",{}),document.querySelector("#print").hidden=!0})),document.querySelector("#remember-button").addEventListener("click",(function(){let formal_data={button:this,dh:dh_div.textContent,document_name:document_name,edited:edited||input_table_outdata.edited,readonly_fun:set_readonly,after_shen_fun:handle_not_pass,xsdh:document.querySelector("#文本字段6").value,after_func:make_complete};service.make_formal(formal_data)})),window.onbeforeunload=function(e){(edited||input_table_outdata.edited)&&((e=window.event||e).returnValue="编辑未保存提醒")};