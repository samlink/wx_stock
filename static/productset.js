let page_productset=function(){getCookie("wxok")||(window.location.href="/");let cartManager=null;const lang=localStorage.getItem("language")||"zh",cartTexts={zh:{cartTitle:"购物车",cartTooltip:"查看购物车",addToCart:"添加到购物车",addSuccess:"商品已添加到购物车",addError:"添加失败，请重试",networkError:"网络连接失败",serverError:"服务器错误",loginRequired:"请先登录",alreadyInCart:"商品已在购物车中",loading:"正在添加...",emptyCart:"购物车为空",itemsInCart:"购物车中有 {count} 件商品"},en:{cartTitle:"Shopping Cart",cartTooltip:"View Cart",addToCart:"Add to Cart",addSuccess:"Item added to cart successfully",addError:"Failed to add item, please try again",networkError:"Network connection failed",serverError:"Server error, please try again later",loginRequired:"Please login first to continue",alreadyInCart:"Item is already in cart",loading:"Adding...",emptyCart:"Cart is empty",itemsInCart:"{count} item(s) in cart"}};"en"==lang&&(document.querySelector("#auto_input").placeholder="Name search",document.querySelector(".tree-title").textContent="Product category　",document.querySelector("#search-input").placeholder="Specification search",document.querySelector("#serach-button").textContent="Search",document.querySelector("#data-out").textContent="Export data",document.querySelector("#first").title="First page",document.querySelector("#pre").title="Previous page",document.querySelector("#aft").title="Next page",document.querySelector("#last").title="Last page",document.querySelector(".page-info").innerHTML='<span>Page</span><input type="text" class="form-control" id="page-input" value="1">\n                <span>of</span><span id="pages"></span><span>pages</span>',document.querySelector(".table-info").innerHTML='Total <span id="total-records"></span> records',document.querySelector(".all-choose").textContent="Check all",document.querySelector("#f-ok").textContent="OK",document.querySelector("#f-cancel").textContent="Cancel");let global={row_id:0,edit:0,eidt_cate:"",product_id:"",product_name:"",filter_conditions:new Map,filter_sqls:[]};async function initializeCart(){try{cartManager=new CartManager,await cartManager.init(),cartManager.updateLanguage(lang),console.log("Shopping cart initialized successfully")}catch(error){console.error("Failed to initialize shopping cart:",error)}}function onTableRefresh(){cartManager&&(cartManager.updateCartDisplay(cartManager.getCurrentCount()),cartManager.highlightCartItems())}"undefined"!=typeof window&&(window.getCartManager=function(){return cartManager},window.refreshCartCount=async function(){cartManager&&(await cartManager.getCartCount(),cartManager.updateCartDisplay(cartManager.getCurrentCount()))},window.updateCartLanguage=function(newLang){cartManager&&cartManager.updateLanguage(newLang)},window.getCartText=function(key,params={}){let text=cartTexts[lang][key]||cartTexts.zh[key]||key;return params&&"string"==typeof text&&Object.keys(params).forEach((param=>{text=text.replace(`{${param}}`,params[param])})),text});let tree_height=document.querySelector(".tree-container").clientHeight,row_num=Math.floor((tree_height-80)/30),tree_data={leaf_click:(id,name)=>{global.product_name=name,global.product_id=id,document.querySelector("#product-name").textContent=name,document.querySelector("#product-id").textContent=id,document.querySelector("#search-input").value="";let post_data={id:id,name:"",filter:"",page:1};Object.assign(tool_table.table_data().post_data,post_data),tool_table.fetch_table((content=>{make_filter(),show_stat(content),onTableRefresh()})),document.querySelectorAll(".filter_button").forEach((button=>{button.classList.remove("red")}))}};tool_tree.tree_init(tree_data),tool_tree.fetch_tree((function(){document.querySelectorAll(".item-down").forEach((stem=>{stem.addEventListener("click",(function(){let cate;cate="zh"==lang?"圆钢"==this.textContent.trim()?"3":"4":"Bar"==this.textContent.trim()?"3":"4",function(cate){fetch("/stock/fetch_statistic",{method:"post",headers:{"Content-Type":"application/json"},body:cate}).then((response=>response.json())).then((content=>{let obj="zh"==lang?{3:"圆钢",4:"无缝钢管"}:{3:"Bar",4:"Pipe"};document.querySelector(".info-show").textContent="zh"==lang?`${obj[cate]}长度合计：${content.库存长度} 米，重量合计：${content.库存重量} KG`:`Total length of ${obj[cate]}: ${content.库存长度} meters, total weight: ${content.库存重量} KG`}))}(cate)}))}))}));let eng_map,input=document.querySelector("#auto_input");function show_stat(content){let long=0==content[3]&&0!=content[4]?"< 1":content[3];document.querySelector(".info-show").textContent="zh"==lang?`长度合计：${long} 米，重量合计：${content[4]} KG`:`Total length: ${long} meters, total weight: ${content[4]} KG`}function make_filter(){const ths=document.querySelectorAll(".table-container thead th");for(let th of ths)if(th.querySelector(".filter_button"))return!1;let has_filter=["规格","状态","执行标准","生产厂家","炉批号","库存长度 (mm)"];"zh"!=lang&&(has_filter=["Dia./OD*WT mm","Condition","Standard","Manufacturer","Heat No.","Length (mm)"],eng_map={"Dia./OD*WT mm":"规格",Condition:"状态",Standard:"执行标准",Manufacturer:"生产厂家","Heat No.":"炉批号","Length (mm)":"库存长度"}),ths.forEach((th=>{-1!=has_filter.indexOf(th.textContent)&&(th.innerHTML=`${th.textContent} <button class="filter_button"><i class="fa fa-filter"></i></button>`)})),document.querySelectorAll(".filter_button").forEach((button=>{button.addEventListener("click",(function(e){e.stopPropagation();let filter=document.querySelector(".filter-container");filter.style.top=e.clientY+20+"px",filter.style.left=e.clientX-this.parentNode.clientWidth+20+"px",document.querySelector("#f-check-all").checked=!1,filter.style.display="block";let na=button.parentNode.textContent.trim();na="zh"==lang?na:eng_map[na];let search=document.querySelector("#search-input").value,id=document.querySelector("#product-id").textContent.trim();document.querySelector("#filter-name").textContent=na;let filter_sql="";global.filter_sqls.length>1&&na==global.filter_sqls[0].name?filter_sql=global.filter_sqls[1].sql:global.filter_sqls.length>0&&na==global.filter_sqls[0].name||0==global.filter_sqls.length?filter_sql="":global.filter_sqls.length>0&&na!=global.filter_sqls[0].name&&(filter_sql=global.filter_sqls[0].sql);let post_data={id:id,name:search,cate:"正常销售",filter_name:na,filter:filter_sql};fetch("/stock/fetch_filter_items",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(post_data)}).then((response=>response.json())).then((content=>{let html="",n=0;for(let row of content){if(""==row.trim()&&0==n)row="zh"==lang?"(空白)":"(Blank)",n++;else if(""==row.trim()&&1==n)continue;"状态"==post_data.filter_name&&"en"==lang&&(row=service.status_to_en(row)),"生产厂家"==post_data.filter_name&&"en"==lang&&(row=service.factor_to_en(row)),html+=`\n                                <label class="check-radio">\n                                    <input class="form-check" type="checkbox">\n                                    <span class="checkmark"></span>\n                                    <span class="all-choose">${row}</span>\n                                </label>\n                            `}filter.querySelector(".f-choose").innerHTML=html;let now_select=[];for(let item of global.filter_sqls)if(item.name.trim()==na){now_select=item.now;break}for(let ch of filter.querySelectorAll(".form-check")){let na=ch.parentNode.textContent.trim();"(Blank)"==na&&(na="(空白)"),"状态"==post_data.filter_name&&"en"==lang&&(na=service.status_to_zh(na)),"生产厂家"==post_data.filter_name&&"en"==lang&&(na=service.factor_to_zh(na)),-1!=now_select.indexOf(`<${na}>`)&&(ch.checked=!0)}}))}))})),make_red()}function fresh_table(data){document.querySelector(".f-choose").innerHTML="",Object.assign(tool_table.table_data().post_data,data),tool_table.fetch_table((content=>{make_filter(),show_stat(content),onTableRefresh()})),make_red()}function make_red(){document.querySelectorAll(".filter_button").forEach((button=>{let name=button.parentNode.textContent.trim();"en"==lang&&(name=eng_map[name]);let has=!1;for(let item of global.filter_sqls)if(item.name==name){button.classList.add("red"),has=!0;break}has||button.classList.remove("red")}))}function get_filter(){let filter="AND (";for(const[key,value]of global.filter_conditions)filter+=`${value} AND (`;return filter=filter.slice(0,-6),filter}new AutoInput(input,"","/stock/tree_auto",(()=>{tool_tree.tree_search(input.value)})).init(),document.querySelector("#auto_search").addEventListener("click",(()=>{tool_tree.tree_search(input.value)})),service.build_product_table(row_num,make_filter,onTableRefresh,show_stat),document.querySelector("#data-out").addEventListener("click",(function(){if(""!=global.product_name){let data={id:document.querySelector("#product-id").textContent.trim(),name:document.querySelector("#product-name").textContent.trim(),search:document.querySelector("#search-input").value.trim(),filter:get_filter(),cate:"正常销售",lang:lang};fetch("/stock/product_out",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{-1!=content?(download_file(`/stock/download/${content}.xlsx`),notifier.show("zh"==lang?"成功导出至 Excel 文件":"Successfully exported to Excel file","success")):notifier.show("zh"==lang?"权限不够，操作失败":"Permissions dinied, operation failed","danger")}))}else notifier.show("zh"==lang?"请先选择商品":"Please select a product first","danger")})),document.querySelector("#f-ok").addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),document.querySelector(".filter-container").style.display="none";let checked=document.querySelector(".f-choose").querySelectorAll(".form-check"),filter_name=document.querySelector("#filter-name").textContent,f_sql="",check_now="";if(document.querySelector("#f-check-all").checked){if(document.querySelector(".f-choose").innerHTML="",global.filter_sqls.length>0&&global.filter_sqls[0].name==filter_name){global.filter_conditions.delete(filter_name),global.filter_sqls.shift(),fresh_table({filter:0==global.filter_sqls.length?"":global.filter_sqls[0].sql,page:1})}}else if(checked.forEach((ch=>{let ch_name=ch.parentNode.textContent.trim();"(Blank)"==ch_name&&(ch_name="(空白)"),"状态"==filter_name&&"en"==lang&&(ch_name=service.status_to_zh(ch_name)),"生产厂家"==filter_name&&"en"==lang&&(ch_name=service.factor_to_zh(ch_name)),ch.checked&&(f_sql+=`${filter_name} = '${ch_name}' OR `,check_now+=`<${ch_name}>, `)})),""!=check_now){let f_sql2=f_sql.slice(0,-4)+")";global.filter_conditions.set(filter_name,f_sql2);let filter=get_filter();if(0!=global.filter_sqls.length&&global.filter_sqls[0].name==filter_name||""==check_now||check_now.split(",").length==checked.length+1)global.filter_sqls.length>0&&global.filter_sqls[0].name==filter_name&&(check_now==global.filter_sqls[0].origin||check_now.split(",").length==checked.length+1?(global.filter_sqls.shift(),filter=0==global.filter_sqls.length?"":global.filter_sqls[0].sql):(global.filter_sqls[0].sql=filter,global.filter_sqls[0].now=check_now));else{let orig="";checked.forEach((ch=>{orig+=`${ch.parentNode.textContent.trim()}, `}));let sql={name:filter_name,sql:filter,origin:orig,now:check_now};global.filter_sqls.unshift(sql)}fresh_table({filter:filter,page:1})}else document.querySelector("#f-check-all").click(),document.querySelector("#f-ok").click()})),document.querySelector("#f-cancel").addEventListener("click",(()=>{document.querySelector(".filter-container").style.display="none",document.querySelector(".f-choose").innerHTML=""})),document.querySelector("#f-check-all").addEventListener("click",(()=>{let checked=document.querySelector("#f-check-all").checked;document.querySelector(".f-choose").querySelectorAll(".form-check").forEach((input=>{input.checked=!!checked}))})),document.querySelector("body").addEventListener("click",(e=>{-1==["filter-container","f-title","f-choose","f-sumit","f-items","checkmark","check-radio","form-check","all-choose","f-button"].indexOf(e.target.className)&&(document.querySelector(".filter-container").style.display="none",document.querySelector(".f-choose").innerHTML="")})),document.addEventListener("keydown",(event=>{"Escape"===event.key&&(document.querySelector(".filter-container").style.display="none",document.querySelector(".f-choose").innerHTML="")}),!1),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(function(){setTimeout(initializeCart,100)})):setTimeout(initializeCart,100)}();