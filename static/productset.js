let page_productset=function(){let global={row_id:0,edit:0,eidt_cate:"",product_id:"",product_name:"",filter_conditions:new Map,filter_sqls:[]},tree_height=document.querySelector(".tree-container").clientHeight,row_num=Math.floor((tree_height-50)/30),tree_data={leaf_click:(id,name)=>{global.product_name=name,global.product_id=id,document.querySelector("#product-name").textContent=name,document.querySelector("#product-id").textContent=id,document.querySelector("#search-input").value="";let post_data={id:id,name:"",filter:"",page:1};Object.assign(tool_table.table_data().post_data,post_data),tool_table.fetch_table((()=>{make_filter()}))}};tool_tree.tree_init(tree_data),tool_tree.fetch_tree(open_node);let input=document.querySelector("#auto_input");function make_filter(){const ths=document.querySelectorAll(".table-container thead th");let has_filter=["规格","状态","执行标准","生产厂家","炉号","库存长度","区域"];ths.forEach((th=>{-1!=has_filter.indexOf(th.textContent)&&(th.innerHTML=`${th.textContent} <button class="filter_button"><i class="fa fa-filter"></i></button>`)})),document.querySelectorAll(".filter_button").forEach((button=>{button.addEventListener("click",(function(e){e.stopPropagation();let filter=document.querySelector(".filter-container");filter.style.top=e.clientY+20+"px",filter.style.left=e.clientX-this.parentNode.clientWidth+20+"px",document.querySelector("#f-check-all").checked=!1,filter.style.display="block";let na=button.parentNode.textContent.trim(),search=document.querySelector("#search-input").value,id=document.querySelector("#product-id").textContent.trim();document.querySelector("#filter-name").textContent=na;let filter_sql="";global.filter_sqls.length>1&&na==global.filter_sqls[0].name?filter_sql=global.filter_sqls[1].sql:global.filter_sqls.length>0&&na==global.filter_sqls[0].name||0==global.filter_sqls.length?filter_sql="":global.filter_sqls.length>0&&na!=global.filter_sqls[0].name&&(filter_sql=global.filter_sqls[0].sql);let post_data={id:id,name:search,cate:"现有库存",filter_name:na,filter:filter_sql};fetch("/fetch_filter_items",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(post_data)}).then((response=>response.json())).then((content=>{let html="",n=0;for(let row of content){if(""==row.trim()&&0==n)row="(空白)",n++;else if(""==row.trim()&&1==n)continue;html+=`\n                                <label class="check-radio">\n                                    <input class="form-check" type="checkbox">\n                                    <span class="checkmark"></span>\n                                    <span class="all-choose">${row}</span>\n                                </label>\n                            `}filter.querySelector(".f-choose").innerHTML=html;let now_select=[];for(let item of global.filter_sqls)if(item.name.trim()==na){now_select=item.now;break}for(let ch of filter.querySelectorAll(".form-check"))-1!=now_select.indexOf(`<${ch.parentNode.textContent.trim()}>`)&&(ch.checked=!0)}))}))})),make_red()}function make_red(){document.querySelectorAll(".filter_button").forEach((button=>{let name=button.parentNode.textContent.trim(),has=!1;for(let item of global.filter_sqls)if(item.name==name){button.classList.add("red"),has=!0;break}has||button.classList.remove("red")}))}new AutoInput(input,"","/tree_auto",(()=>{tool_tree.tree_search(input.value)})).init(),document.querySelector("#auto_search").addEventListener("click",(()=>{tool_tree.tree_search(input.value)})),service.build_product_table(row_num,make_filter),document.querySelector("#f-ok").addEventListener("click",(()=>{let checked=document.querySelector(".f-choose").querySelectorAll(".form-check"),filter_name=document.querySelector("#filter-name").textContent,f_sql="",check_now="";if(document.querySelector(".f-choose").innerHTML="",document.querySelector(".filter-container").style.display="none",checked.forEach((ch=>{const ch_name=ch.parentNode.textContent.trim();ch.checked&&(f_sql+=`${filter_name} = '${ch_name}' OR `,check_now+=`<${ch_name}>, `)})),""==check_now)return;let f_sql2=f_sql.slice(0,-4)+")";global.filter_conditions.set(filter_name,f_sql2);let filter="AND (",keys=[];for(const[key,value]of global.filter_conditions)filter+=`${value} AND (`,keys.push(key);if(filter=filter.slice(0,-6),0!=global.filter_sqls.length&&global.filter_sqls[0].name==filter_name||""==check_now||check_now.split(",").length==checked.length+1)global.filter_sqls.length>0&&global.filter_sqls[0].name==filter_name&&(check_now==global.filter_sqls[0].origin||check_now.split(",").length==checked.length+1?(global.filter_sqls.shift(),filter=0==global.filter_sqls.length?"":global.filter_sqls[0].sql):(global.filter_sqls[0].sql=filter,global.filter_sqls[0].now=check_now));else{let orig="";checked.forEach((ch=>{orig+=`${ch.parentNode.textContent.trim()}, `}));let sql={name:filter_name,sql:filter,origin:orig,now:check_now};global.filter_sqls.unshift(sql)}let post_data={filter:filter,page:1};Object.assign(tool_table.table_data().post_data,post_data),tool_table.fetch_table((()=>{make_filter()})),make_red()})),document.querySelector("#f-cancel").addEventListener("click",(()=>{document.querySelector(".filter-container").style.display="none"})),document.querySelector("#f-check-all").addEventListener("click",(()=>{let checked=document.querySelector("#f-check-all").checked;document.querySelector(".f-choose").querySelectorAll(".form-check").forEach((input=>{input.checked=!!checked}))})),document.querySelector("body").addEventListener("click",(e=>{-1==["filter-container","f-title","f-choose","f-sumit","f-items","checkmark","check-radio","form-check","all-choose","f-button"].indexOf(e.target.className)&&(document.querySelector(".filter-container").style.display="none")})),document.addEventListener("keydown",(event=>{"Escape"===event.key&&(document.querySelector(".filter-container").style.display="none")}),!1)}();