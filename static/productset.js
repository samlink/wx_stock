let page_productset=function(){let global={row_id:0,edit:0,eidt_cate:"",product_id:"",product_name:"",filter_conditions:new Map,filter_sqls:[]},tree_height=document.querySelector(".tree-container").clientHeight,row_num=Math.floor((tree_height-50)/30),tree_data={leaf_click:(id,name)=>{global.product_name=name,global.product_id=id,document.querySelector("#product-name").textContent=name,document.querySelector("#product-id").textContent=id,document.querySelector("#search-input").value="";let post_data={id:id,name:"",filter:"",page:1};Object.assign(tool_table.table_data().post_data,post_data),tool_table.fetch_table((content=>{make_filter(),add_lu_link(),show_stat(content)}))}};tool_tree.tree_init(tree_data),tool_tree.fetch_tree((function(){document.querySelectorAll(".item-down").forEach((stem=>{stem.addEventListener("click",(function(){!function(cate){fetch("/fetch_statistic",{method:"post",headers:{"Content-Type":"application/json"},body:cate}).then((response=>response.json())).then((content=>{let obj={3:"圆钢",4:"无缝钢管"};document.querySelector(".info-show").textContent=`${obj[cate]}长度合计：${content.库存长度} 米，重量合计：${content.库存重量} KG`}))}("圆钢"==this.textContent.trim()?"3":"4")}))}))}));let input=document.querySelector("#auto_input");function show_stat(content){document.querySelector(".info-show").textContent=`长度合计：${content[3]} 米，重量合计：${content[4]} KG`}function add_lu_link(){let trs=document.querySelectorAll(".table-product tbody tr"),lus_arr=[];for(let tr of trs){let lu=tr.querySelector(".炉号");if(!lu)break;{let da=`${tr.querySelector(".名称").textContent.trim().split(" ")[0]}_${tr.querySelector(".规格").textContent.trim()}_${lu.textContent.trim()}`;lus_arr.push(da)}let rk=tr.querySelector(".入库单号");if(rk&&"KT202312-01"!=rk.textContent.trim()){let url=rk.textContent.trim().startsWith("RK")?"/material_in/":"/stock_change_in/";rk.innerHTML=`<a href="${url}${rk.textContent.trim()}" title="点击查阅单据">${rk.textContent.trim()}</a>`}"销售锁定"!=document.querySelector("#p-select").value&&"锁定"==tr.querySelector(".库存类别").textContent.trim()&&tr.classList.add("red")}lus_arr.length>0&&fetch("/fetch_lu",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(lus_arr)}).then((response=>response.json())).then((content=>{for(let tr of trs){let lu=tr.querySelector(".炉号");if(!lu)break;for(let cont of content){let da=`${tr.querySelector(".名称").textContent.trim().split(" ")[0]}_${tr.querySelector(".规格").textContent.trim()}_${lu.textContent.trim()}`;if(-1!=cont.indexOf(da)){lu.innerHTML=`<a href="${cont}" title="点击下载质保书">${lu.textContent.trim()}</a>`;break}}}}))}function make_filter(){const ths=document.querySelectorAll(".table-container thead th");for(let th of ths)if(th.querySelector(".filter_button"))return!1;let has_filter=["规格","状态","执行标准","生产厂家","炉号","库存长度","区域"];ths.forEach((th=>{-1!=has_filter.indexOf(th.textContent)&&(th.innerHTML=`${th.textContent} <button class="filter_button"><i class="fa fa-filter"></i></button>`)})),document.querySelectorAll(".filter_button").forEach((button=>{button.addEventListener("click",(function(e){e.stopPropagation();let filter=document.querySelector(".filter-container");filter.style.top=e.clientY+20+"px",filter.style.left=e.clientX-this.parentNode.clientWidth+20+"px",document.querySelector("#f-check-all").checked=!1,filter.style.display="block";let na=button.parentNode.textContent.trim(),search=document.querySelector("#search-input").value,cate=document.querySelector("#p-select").value,id=document.querySelector("#product-id").textContent.trim();document.querySelector("#filter-name").textContent=na;let filter_sql="";global.filter_sqls.length>1&&na==global.filter_sqls[0].name?filter_sql=global.filter_sqls[1].sql:global.filter_sqls.length>0&&na==global.filter_sqls[0].name||0==global.filter_sqls.length?filter_sql="":global.filter_sqls.length>0&&na!=global.filter_sqls[0].name&&(filter_sql=global.filter_sqls[0].sql);let post_data={id:id,name:search,cate:cate,filter_name:na,filter:filter_sql};fetch("/fetch_filter_items",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(post_data)}).then((response=>response.json())).then((content=>{let html="",n=0;for(let row of content){if(""==row.trim()&&0==n)row="(空白)",n++;else if(""==row.trim()&&1==n)continue;html+=`\n                                <label class="check-radio">\n                                    <input class="form-check" type="checkbox">\n                                    <span class="checkmark"></span>\n                                    <span class="all-choose">${row}</span>\n                                </label>\n                            `}filter.querySelector(".f-choose").innerHTML=html;let now_select=[];for(let item of global.filter_sqls)if(item.name.trim()==na){now_select=item.now;break}for(let ch of filter.querySelectorAll(".form-check"))-1!=now_select.indexOf(`<${ch.parentNode.textContent.trim()}>`)&&(ch.checked=!0)}))}))})),make_red()}function fresh_table(data){document.querySelector(".f-choose").innerHTML="",Object.assign(tool_table.table_data().post_data,data),tool_table.fetch_table((content=>{make_filter(),add_lu_link(),show_stat(content)})),make_red()}function make_red(){document.querySelectorAll(".filter_button").forEach((button=>{let name=button.parentNode.textContent.trim(),has=!1;for(let item of global.filter_sqls)if(item.name==name){button.classList.add("red"),has=!0;break}has||button.classList.remove("red")}))}function get_filter(){let filter="AND (";for(const[key,value]of global.filter_conditions)filter+=`${value} AND (`;return filter=filter.slice(0,-6),filter}new AutoInput(input,"","/tree_auto",(()=>{tool_tree.tree_search(input.value)})).init(),document.querySelector("#auto_search").addEventListener("click",(()=>{tool_tree.tree_search(input.value)})),service.build_product_table(row_num,make_filter,add_lu_link,show_stat),document.querySelector("#f-ok").addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),document.querySelector(".filter-container").style.display="none";let checked=document.querySelector(".f-choose").querySelectorAll(".form-check"),filter_name=document.querySelector("#filter-name").textContent,f_sql="",check_now="";if(document.querySelector("#f-check-all").checked){if(document.querySelector(".f-choose").innerHTML="",global.filter_sqls.length>0&&global.filter_sqls[0].name==filter_name){global.filter_conditions.delete(filter_name),global.filter_sqls.shift(),fresh_table({filter:0==global.filter_sqls.length?"":global.filter_sqls[0].sql,page:1})}}else if(checked.forEach((ch=>{const ch_name=ch.parentNode.textContent.trim();ch.checked&&(f_sql+=`${filter_name} = '${ch_name}' OR `,check_now+=`<${ch_name}>, `)})),""!=check_now){let f_sql2=f_sql.slice(0,-4)+")";global.filter_conditions.set(filter_name,f_sql2);let filter=get_filter();if(0!=global.filter_sqls.length&&global.filter_sqls[0].name==filter_name||""==check_now||check_now.split(",").length==checked.length+1)global.filter_sqls.length>0&&global.filter_sqls[0].name==filter_name&&(check_now==global.filter_sqls[0].origin||check_now.split(",").length==checked.length+1?(global.filter_sqls.shift(),filter=0==global.filter_sqls.length?"":global.filter_sqls[0].sql):(global.filter_sqls[0].sql=filter,global.filter_sqls[0].now=check_now));else{let orig="";checked.forEach((ch=>{orig+=`${ch.parentNode.textContent.trim()}, `}));let sql={name:filter_name,sql:filter,origin:orig,now:check_now};global.filter_sqls.unshift(sql)}fresh_table({filter:filter,page:1})}else document.querySelector("#f-check-all").click(),document.querySelector("#f-ok").click()})),document.querySelector("#f-cancel").addEventListener("click",(()=>{document.querySelector(".filter-container").style.display="none",document.querySelector(".f-choose").innerHTML=""})),document.querySelector("#f-check-all").addEventListener("click",(()=>{let checked=document.querySelector("#f-check-all").checked;document.querySelector(".f-choose").querySelectorAll(".form-check").forEach((input=>{input.checked=!!checked}))})),document.querySelector("body").addEventListener("click",(e=>{-1==["filter-container","f-title","f-choose","f-sumit","f-items","checkmark","check-radio","form-check","all-choose","f-button"].indexOf(e.target.className)&&(document.querySelector(".filter-container").style.display="none",document.querySelector(".f-choose").innerHTML="")})),document.addEventListener("keydown",(event=>{"Escape"===event.key&&(document.querySelector(".filter-container").style.display="none",document.querySelector(".f-choose").innerHTML="")}),!1),document.querySelector("#p-select").addEventListener("change",(()=>{let post_data={id:document.querySelector("#product-id").textContent.trim(),name:document.querySelector("#search-input").value,cate:document.querySelector("#p-select").value,page:1};Object.assign(tool_table.table_data().post_data,post_data),tool_table.fetch_table((content=>{make_filter(),add_lu_link(),show_stat(content)}))})),document.querySelector("#add-button").addEventListener("click",(function(){global.eidt_cate="add",""!=global.product_name?(document.querySelector(".modal-body").innerHTML=service.build_add_form(service.table_fields()),document.querySelector(".modal-title").textContent=global.product_name,document.querySelector(".modal-dialog").style.cssText="max-width: 500px;",document.querySelector(".modal").style.display="block",document.querySelector(".modal-body input").focus(),leave_alert()):notifier.show("请先选择商品","danger")})),document.querySelector("#find-button").addEventListener("click",(function(){global.eidt_cate="add";let chosed=document.querySelector("tbody .focus"),id=chosed?chosed.querySelector("td:nth-child(2)").textContent.trim():"",p_name=chosed?chosed.querySelector(".名称").textContent.trim():"",sale_lock=chosed?chosed.querySelector(".库存类别").textContent.trim():"";""==global.product_name&&(global.product_name=p_name),""!=global.product_name&&""!=id?(id="锁定"!=sale_lock?id:id+"#"+sale_lock,fetch("/fetch_pout_items",{method:"post",headers:{"Content-Type":"application/json"},body:id}).then((response=>response.json())).then((content=>{let tds="",n=1,addr={"销售出库":"/material_out/","调整出库":"/stock_change_out/","商品销售":"/sale/"};for(let row of content)tds+=`<tr><td>${n++}</td><td>${row.cate}</td><td>${row.date}</td><td><a href="${addr[row.cate]}${row.dh}" target="_blank">${row.dh}</a></td>\n                            <td>${row.num}</td><td>${row.all_long}</td><td>${row.weight}</td><td>${row.note}</td></tr>`;for(let i=0;i<15-n+1;i++)tds+="<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>";let gg=chosed.querySelector(".规格").textContent,status=chosed.querySelector(".状态").textContent,now_long=chosed.querySelector(".库存长度").textContent;document.querySelector(".modal-body").innerHTML='\n                    <div class="table-container table-pout">\n                        <table>\n                            <thead>\n                                <tr><th width="6%">序号</th><th width="10%">单据类别</th><th width="15%">日期</th><th width="15%">单号</th>\n                                <th width="8%">切分数量</th><th width="8%">总长度</th><th width="10%">实际重量</th><th width="13%">备注</th></tr>\n                            </thead>\n                            <tbody>\n                            </tbody>\n                        </table>                        \n                    </div>',document.querySelector(".modal-body .table-pout tbody").innerHTML=tds,document.querySelector(".modal-title").textContent=`${id}：${global.product_name}　${gg}　${status}，库存长度：${now_long}`,document.querySelector(".modal-dialog").style.cssText="max-width: 800px;",document.querySelector(".modal").style.display="block",document.querySelector("#modal-sumit-button").style.display="none"}))):notifier.show("请先选择物料","danger")})),document.querySelector("#all-button").addEventListener("click",(function(){let chosed=document.querySelector("tbody .focus"),id=chosed?chosed.querySelector("td:nth-child(2)").textContent:"",p_name=chosed?chosed.querySelector(".名称").textContent.trim():"",p_id=chosed?chosed.querySelector(".商品id").textContent.trim():"";""==global.product_name&&(global.product_name=p_name),""==global.product_id&&(global.product_id=p_id),""!=global.product_name&&""!=id?fetch("/fetch_all_info",{method:"post",headers:{"Content-Type":"application/json"},body:id}).then((response=>response.json())).then((content=>{let fields=["物料号","规格","状态","执行标准","炉号","生产厂家","切分","库存长度","库存重量","入库长度","外径壁厚","入库单号","入库日期","入库方式","原因","库位","库存类别","区域","备注"],form="<form>";for(let name of fields){let control;control=`\n                        <div class="form-group">\n                            <div class="form-label">\n                                <label>${name}</label>\n                            </div>\n                            <input class="form-control input-sm has-value" type="text" value="${content[name]}" readonly>\n                        </div>`,form+=control}form+="</form>",global.row_id=id,document.querySelector(".modal-body").innerHTML=form,document.querySelector(".modal-title").textContent=global.product_name,document.querySelector(".modal-dialog").style.cssText="max-width: 500px;",document.querySelector("#modal-sumit-button").style.display="none",document.querySelector(".modal").style.display="block"})):notifier.show("请先选择物料","danger")})),document.querySelector("#edit-button")&&document.querySelector("#edit-button").addEventListener("click",(function(){global.eidt_cate="edit";let chosed=document.querySelector("tbody .focus"),id=chosed?chosed.querySelector("td:nth-child(2)").textContent:"",p_name=chosed?chosed.querySelector(".名称").textContent.trim():"",p_id=chosed?chosed.querySelector(".商品id").textContent.trim():"";if(""==global.product_name&&(global.product_name=p_name),""==global.product_id&&(global.product_id=p_id),""!=global.product_name&&""!=global.product_id&&""!=id){let fields=[{show_name:"物料号",ctr_type:"普通输入",is_use:!1},{show_name:"状态",ctr_type:"普通输入",is_use:!0},{show_name:"炉号",ctr_type:"普通输入",is_use:!0},{show_name:"入库长度",ctr_type:"普通输入",is_use:!0},{show_name:"库存类别",ctr_type:"下拉列表",option_value:"正常销售_自用_不合格_已切完",is_use:!0},{show_name:"备注",ctr_type:"普通输入",is_use:!0}],form="<form>";for(let name of fields){let control,dis=name.is_use?"":"disabled";if("普通输入"==name.ctr_type){let value=chosed.querySelector(`.${name.show_name}`).textContent;control=`<div class="form-group">\n                            <div class="form-label">\n                                <label>${name.show_name}</label>\n                            </div>\n                            <input class="form-control input-sm has-value" type="text" value="${value}" ${dis}>\n                        </div>`}else{let show_value=chosed.querySelector(`.${name.show_name}`).textContent;control=`<div class="form-group">\n                            <div class="form-label">                                    \n                                <label>${name.show_name}</label>\n                            </div>\n                            <select class='select-sm has-value'>`;let options=name.option_value.split("_");for(let value of options)control+=value==show_value?`<option value="${value}" selected>${value}</option>`:`<option value="${value}">${value}</option>`;control+="</select></div>"}form+=control}form+="</form>",global.row_id=id,document.querySelector(".modal-body").innerHTML=form,document.querySelector(".modal-title").textContent="编辑物料 - "+global.product_name,document.querySelector(".modal-dialog").style.cssText="max-width: 500px;",document.querySelector(".modal").style.display="block",document.querySelector(".modal-body input").focus(),leave_alert()}else notifier.show("请先选择物料","danger")})),document.querySelector("#modal-sumit-button").addEventListener("click",(function(){if(-1!=document.querySelector(".modal-title").textContent.indexOf("编辑"))if("add"==global.eidt_cate||"edit"==global.eidt_cate){let all_input=document.querySelectorAll(".has-value");if(""!=all_input[0].value){let num=0;for(let input of all_input){if("整数"==service.table_fields()[num].data_type&&!regInt.test(input.value)||"实数"==service.table_fields()[num].data_type&&!regReal.test(input.value))return notifier.show("数字字段输入错误","danger"),!1;num++}let product=`${global.row_id}${SPLITER}${global.product_id}${SPLITER}`;num=0;for(let input of all_input){let value;value=-1==input.parentNode.className.indexOf("check-radio")?input.value:input.checked,"整数"!=service.table_fields()[num].data_type&&"实数"!=service.table_fields()[num].data_type||(value=Number(value)),product+=`${value}${SPLITER}`,num++}let data={data:product},url="edit"==global.eidt_cate?"/update_product":"/add_product";fetch(url,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{if(1==content){if(global.edit=0,modal_out_data.edit=0,notifier.show("商品修改成功","success"),tool_table.fetch_table((content=>{make_filter(),add_lu_link(),show_stat(content)})),"add"==global.eidt_cate)for(let input of all_input)input.value="";close_modal()}else notifier.show("权限不够，操作失败","danger")}))}else notifier.show("空值不能提交","danger")}else{let url="批量导入"==global.eidt_cate?"/product_datain":"/product_updatein";fetch(url,{method:"post",body:global.product_id}).then((response=>response.json())).then((content=>{1==content?(notifier.show("批量操作成功","success"),tool_table.fetch_table((content=>{make_filter(),add_lu_link(),show_stat(content)})),close_modal()):notifier.show("权限不够，操作失败","danger")}))}else{let inputs=document.querySelectorAll(".fields-out input[type=checkbox]"),names="";inputs.forEach((input=>{input.checked&&(names+=input.nextElementSibling.textContent.trim()+"#")}));let data={id:document.querySelector("#product-id").textContent.trim(),name:document.querySelector("#product-name").textContent.trim(),fields:names,cate:document.querySelector("#p-select").value,filter:get_filter(),search:document.querySelector("#search-input").value};console.log(data),fetch("/product_out",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{-1!=content?(download_file(`/download/${content}.xlsx`),notifier.show("成功导出至 Excel 文件","success")):notifier.show("权限不够，操作失败","danger")}))}})),modal_init(),document.querySelector("#data-out").addEventListener("click",(function(){if(""!=global.product_name){let fields=[{name:"名称",checked:"checked"},{name:"材质",checked:"checked"},{name:"物料号",checked:"checked"},{name:"规格",checked:"checked"},{name:"状态",checked:"checked"},{name:"执行标准",checked:"checked"},{name:"炉号",checked:"checked"},{name:"切分",checked:""},{name:"库存长度",checked:"checked"},{name:"理论重量",checked:"checked"},{name:"入库长度",checked:""},{name:"外径壁厚",checked:""},{name:"入库单号",checked:""},{name:"入库日期",checked:""},{name:"入库方式",checked:""},{name:"原因",checked:""},{name:"库位",checked:""},{name:"库存类别",checked:""},{name:"区域",checked:""},{name:"备注",checked:"checked"}],form="<form class='form-out'>";for(let f of fields){let control;control=`\n                    <div class="form-group fields-out">\n                        <label class="check-radio">\n                            <input type="checkbox" ${f.checked}>\n                            <span>${f.name}</span>\n                            <span class="checkmark"></span>\n                        </label>\n                    </div>`,form+=control}form+="</form>",document.querySelector(".modal-body").innerHTML=form,document.querySelector(".modal-title").textContent=global.product_name+" - 请选择导出字段：",document.querySelector(".modal-dialog").style.cssText="max-width: 300px;",document.querySelector(".modal").style.display="block"}else notifier.show("请先选择商品","danger")}));let fileBtn=document.getElementById("choose_file");document.getElementById("data-in").addEventListener("click",(function(){if(""==global.product_name)return notifier.show("请先选择商品分类","danger"),!1;fileBtn.click()})),fileBtn.addEventListener("change",(()=>{data_in(fileBtn,"将追加","追加新数据，同时保留原数据","批量导入")}));let fileBtn_update=document.getElementById("choose_file2");function data_in(fileBtn,info1,info2,cate){if(checkFileType(fileBtn)){const fd=new FormData;fd.append("file",fileBtn.files[0]),fetch("/product_in",{method:"POST",body:fd}).then((res=>res.json())).then((content=>{if(-1!=content&&-2!=content){let rows="<div class='table-container table-product'><table style='font-size: 12px;'><thead>",n=1;for(let item of content[0]){let row,arr_p=item.split("<`*_*`>");if(1==n){row="<tr>";for(let i=0;i<arr_p.length-1;i++)row+=`<th>${arr_p[i]}</th}>`;row+="</tr></thead><tbody>",n=2}else{row="<tr>";for(let i=0;i<arr_p.length-1;i++)row+=`<td>${arr_p[i]}</td>`;row+="</tr>"}rows+=row}rows+="</tbody></table></div>",document.querySelector(".modal-body").innerHTML=rows;let message=content[2]>50?" (仅显示前 50 条）":"";document.querySelector(".modal-title").innerHTML=`${global.product_name} ${info1} ${content[1]} 条数据${message}：`,document.querySelector("#modal-info").innerHTML=`${global.product_name} ${info2}`,global.eidt_cate=cate,document.querySelector(".modal-dialog").style.cssText="max-width: 1200px;",document.querySelector(".modal").style.cssText="display: block",fileBtn.value=""}else-1==content?notifier.show("缺少操作权限","danger"):notifier.show("excel 表列数不符合","danger")}))}else notifier.show("需要 excel 文件","danger")}document.getElementById("data-update").addEventListener("click",(function(){if(""==global.product_name)return notifier.show("请先选择商品分类","danger"),!1;fileBtn_update.click()})),fileBtn_update.addEventListener("change",(()=>{data_in(fileBtn_update,"将更新","更新数据，原数据将被替换，请谨慎操作！","批量更新")}))}();