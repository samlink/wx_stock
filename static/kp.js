import{notifier}from"/assets/js/parts/notifier.mjs";import*as service from"/assets/js/parts/service.mjs";import{SPLITER,regReal,set_key_move}from"/assets/js/parts/tools.mjs";import{appand_edit_row,build_blank_table,build_items_table,input_table_outdata}from"/assets/js/parts/edit_table.mjs";import{modal_init}from"/assets/js/parts/modal.mjs";let document_table_fields,table_lines,show_names,edited,document_bz=document.querySelector("#document-bz").textContent.trim(),dh_div=document.querySelector("#dh");const document_name="销售开票";function document_top_handle(html,has_date){document.querySelector(".fields-show").innerHTML=html;let date=document.querySelector("#日期");has_date||(date.value=(new Date).Format("yyyy-MM-dd")),laydate.render({elem:date,showBottom:!1});let all_input=document.querySelectorAll(".fields-show input"),form=document.querySelector(".fields-show");set_key_move(all_input,form,all_input.length-1),service.set_sumit_shen(),document.querySelector("#sumit-shen").addEventListener("click",(function(){let shen_data={button:this,dh:dh_div.textContent,document_name:"销售开票",edited:edited||input_table_outdata.edited};service.sumit_shen(shen_data)}))}fetch("/fetch_inout_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify("销售开票")}).then((response=>response.json())).then((content=>{if(-1!=content)if(document_table_fields=content,"新单据"!=dh_div.textContent)fetch("/fetch_document_ck",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:"销售开票",dh:dh_div.textContent})}).then((response=>response.json())).then((data=>{document_top_handle(service.build_inout_form(document_table_fields,data),!0);let values=data.split(SPLITER),len=values.length,customer=document.querySelector("#文本字段2");customer.value=values[2],customer.setAttribute("data",values[len-4]);let pic=values[values.length-3].replace("pic_","min_");pic.startsWith("/upload")&&document.querySelector("#upload-pic").setAttribute("src",`${pic}?${Math.random()}`);let set_data={content:data,readonly_fun:set_readonly,focus_fun:()=>{setTimeout((()=>{document.querySelector(".table-items tbody .名称").focus()}),200)}};service.set_shens_owner(set_data),fetch_others(document.querySelector("#文本字段6").value)}));else{document_top_handle(service.build_inout_form(content),!1),document.querySelector("#remember-button").textContent="审核",setTimeout((()=>{document.querySelector(".table-items tbody .名称").focus()}),200)}})),show_names=[{name:"序号",width:40,class:"序号",type:"普通输入",editable:!1,is_save:!0,default:1},{name:"名称",width:80,class:"名称",type:"autocomplete",editable:!0,is_save:!0,save:"id",default:""},{name:"规格型号",width:100,class:"材质",type:"普通输入",editable:!1,is_save:!0,default:""},{name:"单位",width:50,class:"单位",type:"普通输入",editable:!0,is_save:!0,default:"kg"},{name:"数量",width:50,class:"num",type:"普通输入",editable:!0,is_save:!0,default:""},{name:"单价",width:50,class:"price",type:"普通输入",editable:!0,is_save:!0,default:""},{name:"金额",width:80,class:"money",type:"普通输入",editable:!1,is_save:!1,default:""},{name:"税率",width:60,class:"税率",type:"普通输入",editable:!0,is_save:!0,default:"13%"},{name:"税额",width:80,class:"税额",type:"普通输入",editable:!1,is_save:!1,default:""}],table_lines=Math.floor((document.querySelector("body").clientHeight-395)/33);let show_th=[{name:"名称",width:60},{name:"材质",width:80},{name:"规格",width:80},{name:"状态",width:100}],auto_data=[{n:2,cate:"销售开票",auto_url:"/buyin_auto",show_th:show_th,type:"table",cb:fill_gg}];if(fetch("/fetch_sale_docs",{method:"post"}).then((response=>response.json())).then((content=>{let tr="";content.forEach((obj=>{let material=obj.label.split(`${SPLITER}`);tr+=`<tr><td hidden>${obj.id}</td><td>${material[0]}</td>\n                <td hidden>${material[1]}</td></tr>`})),document.querySelector(".table-docs tbody").innerHTML=tr;let lines=document.querySelectorAll(".table-docs tbody tr");for(let l of lines)l.addEventListener("dblclick",(()=>{if("已审核"==document.querySelector("#remember-button").textContent||1==document.querySelector("#save-button").disabled)return!1;let value=l.querySelector("td:nth-child(3)").textContent.split("　"),dh=l.querySelector("td:nth-child(1)").textContent;document.querySelector("#文本字段6").value=dh,document.querySelector("#文本字段8").value=""!=value[2]?`${value[1]} / ${value[2]}`:value[1],document.querySelector("#文本字段2").value=value[0],document.querySelector("#文本字段2").setAttribute("data",value[4]),document.querySelector("#应结金额").value=value[3],fetch_others(dh)}))})),"新单据"==dh_div.textContent){build_blank_table({show_names:show_names,lines:table_lines,auto_data:auto_data,dh:dh_div.textContent,calc_func:calculate,del_func:sum_money}),appand_edit_row()}else fetch("/fetch_kp_items",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:"销售开票",dh:dh_div.textContent})}).then((response=>response.json())).then((content=>{let edit_data={show_names:show_names,rows:content,auto_data:auto_data,lines:table_lines,dh:dh_div.textContent,document:"销售开票",calc_func:calculate,change_func:sum_money};build_items_table(edit_data),setTimeout((()=>{"审核"==document.querySelector("#remember-button").textContent.trim()&&appand_edit_row()}),200)}));function fetch_others(dh){fetch("/fetch_other_documents",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh)}).then((response=>response.json())).then((data=>{let tr="";data.forEach((obj=>{-1==obj.indexOf("开票")&&(tr+=`<tr><td>${obj}</td></tr>`)})),document.querySelector(".table-history tbody").innerHTML=tr;let trs=document.querySelectorAll(".table-history tbody tr"),ck="DO: ",fh="FO: ";for(let tr of trs){let cate=tr.querySelector("td").textContent.split("　");tr.addEventListener("click",(function(){let url;url=-1!=cate[0].indexOf("出库")?"/material_out/":-1!=cate[0].indexOf("发货")?"/transport/":"/material_in/",window.open(url+tr.querySelector("td").textContent.split("　")[1])})),-1!=cate[0].indexOf("出库")?ck+=cate[1]+" / ":-1!=cate[0].indexOf("发货")&&(fh+=cate[1]+" / ")}let note=`<p>CN: ${document.querySelector("#文本字段8").value}</p><p>${ck.replace(/(\s|\/)+$/g,"")}</p><p>${fh.replace(/(\s|\/)+$/g,"")}</p>`;document.querySelector(".table-note tbody").innerHTML=note}))}function calculate(input_row){input_row.querySelector(".price").addEventListener("blur",(function(){calc_money(input_row),calc_tax(input_row),sum_money()})),input_row.querySelector(".num").addEventListener("blur",(function(){calc_money(input_row),calc_tax(input_row),sum_money()})),input_row.querySelector(".税率").addEventListener("blur",(function(){calc_tax(input_row),sum_money()}))}function calc_money(input_row){let price=input_row.querySelector(".price").value,mount=input_row.querySelector(".num").value;input_row.querySelector(".money").textContent=(price*mount).toFixed(2)}function calc_tax(input_row){let price=input_row.querySelector(".price").value,mount=input_row.querySelector(".num").value,tax=Number(input_row.querySelector(".税率").value.replace("%",""))/100;input_row.querySelector(".税额").textContent=(price*mount*tax).toFixed(2)}function sum_money(){let all_input=document.querySelectorAll(".has-input"),sum=0,sum_tax=0;for(let i=0;i<all_input.length;i++){let price=all_input[i].querySelector(".price").value,mount=all_input[i].querySelector(".num").value,tax=Number(all_input[i].querySelector(".税率").value.replace("%",""))/100;""!=all_input[i].querySelector("td:nth-child(2) .auto-input").value&&price&&regReal.test(price)&&mount&&regReal.test(mount)&&tax&&regReal.test(tax)&&(sum+=price*mount,sum_tax+=price*mount*tax)}document.querySelector("#sum-money").innerHTML=`金额合计：${sum.toFixed(2)} 元  　 　 税额合计：${sum_tax.toFixed(2)} 元`,document.querySelector("#文本字段5")&&(document.querySelector("#文本字段5").value=sum.toFixed(2))}function fill_gg(){let field_values=document.querySelector(".inputting .auto-input").getAttribute("data").split(SPLITER),n=3;for(let i=2;i<3;i++){let val=field_values[i];"普通输入"!=show_names[i].type&&"autocomplete"!=show_names[i].type||!show_names[i].editable?"普通输入"!=show_names[i].type||show_names[i].editable?"下拉列表"==show_names[i].type&&show_names[i].editable?document.querySelector(`.inputting td:nth-child(${n}) select`).value=val:"下拉列表"!=show_names[i].type||show_names[i].editable||(document.querySelector(`.inputting td:nth-child(${n})`).textContent=val):document.querySelector(`.inputting td:nth-child(${n})`).textContent=val:document.querySelector(`.inputting td:nth-child(${n}) input`).value=val,n++}document.querySelector(".inputting .单位").focus(),appand_edit_row(),edited=!0}function set_readonly(){let all_edit=document.querySelectorAll(".fields-show input");for(let edit of all_edit)"备注"!=edit.id&&(edit.disabled=!0);setTimeout((()=>{document.querySelectorAll(".table-items tbody input").forEach((input=>{input.classList.contains("备注")||input.classList.contains("note")||(input.disabled=!0)}))}),100),service.edit_button_disabled()}function error_check(){if(""==document.querySelector("#文本字段8").value.trim())return notifier.show("合同编号不能为空","danger"),!1;let all_rows=document.querySelectorAll(".table-items .has-input");if(!service.header_error_check(document_table_fields,all_rows))return!1;if(1==all_rows.length&&""==all_rows[0].querySelector("td:nth-child(2) input").value)return notifier.show("明细不能为空","danger"),!1;for(let row of all_rows)if(""!=row.querySelector("td:nth-child(2) input").value){let num=row.querySelector(".num");if(row.querySelector(".price").value&&!regReal.test(row.querySelector(".price").value))return notifier.show("单价输入错误","danger"),!1;if(row.querySelector(".price").value||(row.querySelector(".price").value=0),num.value&&!regReal.test(num.value))return notifier.show("数量输入错误","danger"),!1;num.value||(num.value=0)}return!0}service.handle_pic(dh_div,"/pic_kp_save"),modal_init(),document.querySelector("#save-button").addEventListener("click",(function(){if(!error_check())return!1;let all_values=document.querySelectorAll(".document-value"),custid=document.querySelector("#文本字段2").getAttribute("data"),save_str=`${document_bz}${SPLITER}${dh_div.textContent}${SPLITER}${custid}${SPLITER}`,n=0;for(let f of document_table_fields){if("文本"==f.data_type){save_str+=`${-1==f.show_name.indexOf("单号")?all_values[n].value:all_values[n].value.split("　")[0]}${SPLITER}`}else if("整数"==f.data_type||"实数"==f.data_type){save_str+=`${all_values[n].value?all_values[n].value:0}${SPLITER}`}else save_str+=`${all_values[n].checked?"是":"否"}${SPLITER}`;n++}let table_data=[],all_rows=document.querySelectorAll(".table-items .has-input");for(let row of all_rows)if(""!=row.querySelector("td:nth-child(2) input").value.trim()){let len=show_names.length,save_str="";for(let i=0;i<len;i++)if(show_names[i].is_save)if("普通输入"==show_names[i].type||"autocomplete"==show_names[i].type||"下拉列表"==show_names[i].type){let value=row.querySelector(`.${show_names[i].class}`).value;value||(value=row.querySelector(`.${show_names[i].class}`).textContent),save_str+=`${value.trim()}${SPLITER}`}else{save_str+=`${(row.querySelector(`.${show_names[i].class}`).checked?"是":"否").trim()}${SPLITER}`}table_data.push(save_str)}let data={rights:document_bz,document:save_str,remember:document.querySelector("#remember-button").textContent,items:table_data};console.log(data),fetch("/save_document_kp",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{-1!=content?(dh_div.textContent=content,notifier.show("单据保存成功","success"),edited=!1,input_table_outdata.edited=!1):notifier.show("权限不够，操作失败","danger")}))})),document.querySelector("#remember-button").addEventListener("click",(function(){let formal_data={button:this,dh:dh_div.textContent,xsdh:`${document.querySelector("#文本字段6").value}${SPLITER}${document.querySelector("#是否欠款").checked}`,document_name:"销售开票",edited:edited||input_table_outdata.edited,readonly_fun:set_readonly,after_func:function(xsdh,dh){fetch("/make_xs_kp",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(xsdh)})}};service.make_formal(formal_data)})),window.onbeforeunload=function(e){(edited||input_table_outdata.edited)&&((e=window.event||e).returnValue="编辑未保存提醒")};