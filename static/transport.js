let page_transport=function(){let document_table_fields,table_lines,show_names,edited,document_bz=document.querySelector("#document-bz").textContent.trim(),dh_div=document.querySelector("#dh"),shen_print="";function set_readonly(){let all_edit=document.querySelectorAll(".document-value");for(let edit of all_edit)"备注"!=edit.id&&(edit.disabled=!0);document.querySelector("#save-button").disabled=!0,setTimeout((()=>{document.querySelectorAll(".table-items tbody input").forEach((input=>{input.disabled=!0}))}),100),service.edit_button_disabled()}function document_top_handle(html){document.querySelector(".fields-show").innerHTML=html;let comany=document.querySelector("#文本字段5"),auto_doc=document.querySelector("#文本字段11");auto_doc.parentNode.classList.add("autocomplete"),new AutoInput(auto_doc,comany,"/get_truck_auto",(()=>{})).init();let auto_doc2=document.querySelector("#文本字段12");auto_doc2.parentNode.classList.add("autocomplete"),new AutoInput(auto_doc2,comany,"/get_truck2_auto",(()=>{})).init();let date=document.querySelector("#日期");date.closest(".form-group").style.display="none",date.value=(new Date).Format("yyyy-MM-dd");let all_input=document.querySelectorAll(".fields-show input"),form=document.querySelector(".fields-show");set_key_move(all_input,form,9),service.set_sumit_shen(),document.querySelector("#sumit-shen").addEventListener("click",(function(){if(""==document.querySelector("#日期").value.trim()||!regDate.test(document.querySelector("#日期").value))return notifier.show("日期输入错误","danger"),!1;if(""==document.querySelector("#文本字段11").value.trim())return notifier.show("请填写提货车牌","danger"),!1;if(""==document.querySelector("#文本字段12").value.trim())return notifier.show("请填写提货车牌","danger"),!1;let shen_data={button:this,dh:dh_div.textContent,document_name:"发货单据",edited:edited||edit_table.input_table_outdata().edited};service.sumit_shen(shen_data)}))}function build_items(dh){fetch("/get_trans_info",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh)}).then((response=>response.json())).then((content=>{let info=content.split(SPLITER);document.querySelector("#文本字段3").value=info[0],document.querySelector("#文本字段5").value=info[1],document.querySelector("#文本字段8").value=info[2],document.querySelector("#文本字段9").value=info[3],document.querySelector("#文本字段1").value=info[4]})),fetch("/get_sale_out",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh)}).then((response=>response.json())).then((content=>{let tr="";content.forEach((obj=>{let c=obj.split(SPLITER),done="true"==c[1]?"class='red'":"";tr+=`<tr ${done}><td>${c[0]}</td></tr>`})),document.querySelector(".table-history tbody").innerHTML=tr;let lines=document.querySelectorAll(".table-history tbody tr");for(let l of lines)l.addEventListener("dblclick",(()=>{if("已审核"==document.querySelector("#remember-button").textContent||1==document.querySelector("#save-button").disabled)return!1;let dh=l.querySelector("td:nth-child(1)").textContent.split("　")[0];fetch("/get_items_trans",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh)}).then((response=>response.json())).then((content=>{document.querySelectorAll("#trans-table tbody tr").forEach((tr=>{"锯口费"==tr.querySelector("td:nth-child(2)").textContent.trim()&&tr.parentNode.removeChild(tr)}));for(let c of content){let value=c.split("　"),money=Number(value[9]*value[8]).toFixed(2);"锯口费"==value[0]&&(money=Number(value[9]*value[6]).toFixed(2)),show_names[1].value=value[0],show_names[2].value=value[1],show_names[3].value=value[2],show_names[4].value=value[3],show_names[5].value=value[4],show_names[6].value=value[5],show_names[7].value=value[6],show_names[8].value=value[7],show_names[9].value=value[8],show_names[10].value=value[9],show_names[11].value=money,show_names[12].value=value[10],show_names[13].value=value[11],show_names[14].value=value[12];let data={show_names:show_names,lines:table_lines,dh:dh_div.textContent,document:"发货单据",calc_func:calculate,change_func:sum_money};edit_table.build_out_table(data)}sum_money(),edited=1,document.querySelector("#文本字段6").focus()}))}))}))}function calculate(input_row){input_row.querySelector(".数量").addEventListener("blur",(function(){let mount=input_row.querySelector(".数量").value;regInt.test(mount)?function(input_row){let data={long:input_row.querySelector(".长度").textContent.trim(),num:input_row.querySelector(".数量").value.trim(),name:input_row.querySelector(".名称").textContent.trim(),cz:input_row.querySelector(".材质").textContent.trim(),gg:input_row.querySelector(".规格").textContent.trim()};regInt.test(data.long)&&regInt.test(data.num)?input_row.querySelector(".理论重量").textContent=service.calc_weight(data):input_row.querySelector(".理论重量").textContent=0}(input_row):input_row.querySelector(".理论重量").textContent=0,sum_money()})),input_row.querySelector(".实际重量").addEventListener("blur",(function(){let mount=input_row.querySelector(".实际重量").value,price=input_row.querySelector(".单价").textContent;regReal.test(mount)?input_row.querySelector(".总价").textContent=(price*mount).toFixed(2):input_row.querySelector(".总价").textContent=0,sum_money()}))}function sum_money(){let all_input=document.querySelectorAll(".has-input"),sum=0,sum_n=0,sum_weight=0,sum_weight_s=0;for(let i=0;i<all_input.length;i++){let mount=Number(all_input[i].querySelector(".理论重量").textContent);sum+=Number(all_input[i].querySelector(".总价").textContent),sum_n+=Number(all_input[i].querySelector(".数量").value),sum_weight+=mount,sum_weight_s+=Number(all_input[i].querySelector(".实际重量").value)}document.querySelector("#sum-money").innerHTML=`数量：${sum_n}，  理论重量：${sum_weight.toFixed(1)} kg，  实际重量：${sum_weight_s.toFixed(1)} kg， 金额合计：${sum.toFixed(2)} 元`}if(fetch("/fetch_inout_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify("发货单据")}).then((response=>response.json())).then((content=>{if(-1!=content)if(document_table_fields=content,"新单据"!=dh_div.textContent)fetch("/fetch_document_fh",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:"发货单据",dh:dh_div.textContent})}).then((response=>response.json())).then((data=>{document_top_handle(service.build_inout_form(document_table_fields,data)),build_items(document.querySelector("#文本字段6").value);let set_data={content:data,readonly_fun:set_readonly,focus_fun:()=>{setTimeout((()=>{document.querySelector("#文本字段6").focus()}),200)}};service.set_shens_owner(set_data);let da=data.split(SPLITER),pic=da[da.length-6].replace("pic_","min_");shen_print=da[16],pic.startsWith("/upload")&&document.querySelector("#upload-pic").setAttribute("src",`${pic}?${Math.random()}`)}));else{document_top_handle(service.build_inout_form(content)),document.querySelector("#remember-button").textContent="审核",setTimeout((()=>{document.querySelector("#文本字段6").focus()}),200)}})),service.get_materials_docs("/materialout_docs","商品销售",build_items),fetch("/materialout_saved_docs",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify("商品销售")}).then((response=>response.json())).then((content=>{let title=document.querySelector(".table-save thead th");title.innerHTML=title.textContent+" "+content.length+" 单";let tr="";content.forEach((obj=>{tr+=`<tr><td>${obj.label}</td><td hidden>${obj.id}</td></tr>`})),document.querySelector(".table-save tbody").innerHTML=tr;let lines=document.querySelectorAll(".table-save tbody tr");for(let l of lines)l.addEventListener("dblclick",(()=>{let dh=l.querySelector("td:nth-child(2)").textContent.trim();window.location.href="/transport/"+dh}))})),show_names=[{name:"序号",width:10,class:"序号",type:"普通输入",editable:!1,is_save:!0},{name:"名称",width:40,class:"名称",type:"普通输入",editable:!1,is_save:!1},{name:"材质",width:60,class:"材质",type:"普通输入",editable:!1,is_save:!1},{name:"规格",width:60,class:"规格",type:"普通输入",editable:!1,is_save:!0},{name:"状态",width:80,class:"状态",type:"普通输入",editable:!1,is_save:!0},{name:"炉号",width:80,class:"炉号",type:"普通输入",editable:!1,is_save:!0},{name:"长度",width:30,class:"长度",type:"普通输入",editable:!1,is_save:!0},{name:"数量",width:30,class:"数量",type:"普通输入",editable:!0,is_save:!0},{name:"理论重量",width:30,class:"理论重量",type:"普通输入",editable:!1,is_save:!0},{name:"实际重量",width:30,class:"实际重量",type:"普通输入",editable:!0,is_save:!0},{name:"单价",width:30,class:"单价",type:"普通输入",editable:!1,is_save:!0},{name:"总价",width:60,class:"总价",type:"普通输入",editable:!1,is_save:!1,no_button:!0},{name:"备注",width:100,class:"备注",type:"普通输入",editable:!0,is_save:!0,css:'style="border-right:none"'},{name:"",width:0,class:"m_id",type:"普通输入",editable:!1,is_save:!0,css:'style="width:0%; border-left:none; border-right:none; color:white"'},{name:"",width:0,class:"m_dh",type:"普通输入",editable:!1,is_save:!0,css:'style="width:0%; border-left:none; color:white"'}],table_lines=Math.floor((document.querySelector("body").clientHeight-395)/33),"新单据"==dh_div.textContent){let data={show_names:show_names,lines:table_lines,dh:dh_div.textContent,document:"发货单据"};edit_table.build_blank_table(data)}else fetch("/fetch_trans_items",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:"发货单据",dh:dh_div.textContent})}).then((response=>response.json())).then((content=>{let data={show_names:show_names,rows:content,lines:table_lines,dh:dh_div.textContent,document:"发货单据",calc_func:calculate,change_func:sum_money};edit_table.build_items_table(data);let trs=document.querySelectorAll(".table-items .has-input");for(let tr of trs)if(tr.querySelector(".炉号")){let lu=`${tr.querySelector(".材质").textContent.trim()}_${tr.querySelector(".规格").textContent.trim()}_${tr.querySelector(".炉号").textContent.trim()}`;fetch("/fetch_lu",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(lu)}).then((response=>response.json())).then((content=>{""!=content&&-1!=content&&(tr.querySelector(".炉号").innerHTML=`<a href="${content}" title="点击下载质保书">${tr.querySelector(".炉号").textContent.trim()}</a>`)}))}}));function make_complete(dh){fetch("/make_fh_complete",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh)})}function error_check(){let all_rows=document.querySelectorAll(".table-items .has-input");return!!service.header_error_check(document_table_fields,all_rows)}service.handle_pic(dh_div,"/pic_fh_save"),modal_init(),document.querySelector("#save-button").addEventListener("click",(function(){if(!error_check())return!1;let all_values=document.querySelectorAll(".document-value"),save_str=`${document_bz}${SPLITER}${dh_div.textContent}${SPLITER}`,n=0;for(let f of document_table_fields){if("文本"==f.data_type){save_str+=`${-1==f.show_name.indexOf("单号")?all_values[n].value:all_values[n].value.split("　")[0]}${SPLITER}`}else if("整数"==f.data_type||"实数"==f.data_type){save_str+=`${all_values[n].value?all_values[n].value:0}${SPLITER}`}else save_str+=`${all_values[n].checked?"是":"否"}${SPLITER}`;n++}let table_data=[],all_rows=document.querySelectorAll(".table-items .has-input");for(let row of all_rows)if(""!=row.querySelector("td:nth-child(1)").textContent){let len=show_names.length,save_str="";for(let i=0;i<len;i++)if(show_names[i].is_save)if("普通输入"==show_names[i].type||"autocomplete"==show_names[i].type||"下拉列表"==show_names[i].type){let value=row.querySelector(`.${show_names[i].class}`).value;value||(value=row.querySelector(`.${show_names[i].class}`).textContent),save_str+=`${value.trim()}${SPLITER}`}else{save_str+=`${(row.querySelector(`.${show_names[i].class}`).checked?"是":"否").trim()}${SPLITER}`}table_data.push(save_str)}let data={rights:"运输发货",document:save_str,remember:"",items:table_data};fetch("/save_stransport",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{-1!=content?(!function(trans_dh){let sum_money=document.querySelector("#sum-money").textContent,sum_a=sum_money.match(/\d+(\.\d+)?/g),weight=sum_a[2],sum=sum_a[3],da=`${document.querySelector("#文本字段6").value}${SPLITER}${trans_dh}${SPLITER}${sum}${SPLITER}${weight}`;fetch("/save_sale_money",{method:"post",headers:{"Content-Type":"application/json"},body:da})}(content),dh_div.textContent=content,notifier.show("单据保存成功","success"),edited=!1,edit_table.input_table_outdata().edited=!1):notifier.show("权限不够，操作失败","danger")}))})),document.querySelector("#print-button").addEventListener("click",(async function(){if(!error_check())return!1;let cus_po=await(await fetch("/get_customer_po",{method:"post",headers:{"Content-Type":"application/json"},body:document.querySelector("#文本字段6").value.trim()})).json();document.querySelector("#print .print-title").innerHTML="<img src='/assets/img/logo_blue.png'/> 五星(天津)石油装备有限公司-销售发货单";let p=`<p style="padding:0">客户名称：${document.querySelector("#文本字段5").value}</p>\n                        <p>客户地址：${document.querySelector("#文本字段1").value}</p>`;document.querySelector("#p-block1").innerHTML=p;let contact=`收货人/电话：${document.querySelector("#文本字段8").value} ${document.querySelector("#文本字段9").value}`;p=`<p>发货日期：${document.querySelector("#日期").value}</p><p>${contact}</p>`,document.querySelector("#p-block2").innerHTML=p,p=`<p>合同号：${document.querySelector("#文本字段3").value}</p><p>车号：${document.querySelector("#文本字段2").value} / ${document.querySelector("#文本字段11").value}</p>`,document.querySelector("#p-block3").innerHTML=p,p=`<p>客户PO：${cus_po}</p><p>销售单号：${document.querySelector("#文本字段6").value.split("　")[0]}</p>`,document.querySelector("#p-block4").innerHTML=p;document.querySelector(".print-table thead").innerHTML='<tr>\n        <th width="3%">序号</th>\n        <th width="7%">商品名称</th>\n        <th width="8%">材质</th>\n        <th width="6%">规格<br>(mm)</th>\n        <th width="10%">状态</th>\n        <th width="10%">炉号</th>\n        <th width="5%">长度 (mm)</th>\n        <th width="3%">支数</th>\n        <th width="6%">理论重量<br>(KG)</th>\n        <th width="7%">实际重量<br>(KG)</th>\n        <th width="5%">单价<br>(元/KG)</th>\n        <th width="8%">总价<br>(元)</th>\n        <th width="8%">备注</th>\n    </tr>';let sum_money=0,sum_weight=0,sum_li_weight=0,sum_zhi=0,all_rows=document.querySelectorAll(".table-items .has-input"),trs="";for(let row of all_rows){trs+="<tr>";for(let i=1;i<14;i++){let t=row.querySelector(`td:nth-child(${i}) input`);trs+=`<td>${t?t.value:row.querySelector(`td:nth-child(${i})`).textContent}</td>`}trs+="</tr>",sum_weight+=Number(row.querySelector("td:nth-child(10) input").value),sum_money+=Number(row.querySelector("td:nth-child(12)").textContent),sum_li_weight+=Number(row.querySelector("td:nth-child(9)").textContent),sum_zhi+="锯口费"!=row.querySelector("td:nth-child(2)").textContent.trim()?Number(row.querySelector("td:nth-child(8) input").value):0}let len=6-all_rows.length;trs+=append_blanks(len,13),trs+=`<tr><td colspan="2">合计</td>${append_cells(5)}<td>${sum_zhi}</td><td>${sum_li_weight.toFixed(1)}</td>\n             <td>${sum_weight.toFixed(1)}</td><td></td><td>${sum_money.toFixed(2)}</td><td></td>`,trs+=`<tr><td colspan="2">合计（大写）</td><td colspan="11">${moneyUppercase(sum_money.toFixed(2))}</td>`,trs+='<tr class=\'no-bottom\' style="height: 40px"><td colspan="2">备注</td><td colspan="11"></td>',document.querySelector(".print-table tbody").innerHTML=trs,document.querySelector("#p-block5").innerHTML=`<p>制单人：${document.querySelector("#user-name").textContent.split("　")[1]}</p>`,document.querySelector("#p-block6").innerHTML=`<p>审核：${shen_print}</p>`,document.querySelector("#p-block7").innerHTML="<p>装车：</p>",document.querySelector("#p-block8").innerHTML="<p>提货：</p>",document.querySelector("#print").hidden=!1,Print("#print",{}),document.querySelector("#print").hidden=!0})),document.querySelector("#remember-button").addEventListener("click",(function(){if("已审核"==document.querySelector("#remember-button").textContent.trim())return!1;let formal_data={button:this,dh:dh_div.textContent,document_name:"发货单据",edited:edited||edit_table.input_table_outdata().edited,readonly_fun:set_readonly,xsdh:document.querySelector("#文本字段6").value,after_func:make_complete};service.make_formal(formal_data)})),window.onbeforeunload=function(e){(edited||edit_table.input_table_outdata().edited)&&((e=window.event||e).returnValue="编辑未保存提醒")}}();