let page_myorders=function(){if(!getCookie("wxok"))return void(window.location.href="/");const lang=localStorage.getItem("language")||"zh",texts={zh:{pageTitle:"我的订单",ordersList:"订单列表",orderDetails:"订单明细",orderNumber:"订单号",orderDate:"订单日期",orderStatus:"订单状态",selectOrderPrompt:"请选择订单查看明细",selectOrderDescription:"点击左侧订单列表中的订单项查看详细信息",noOrders:"暂无订单",noOrdersDescription:"您还没有提交过任何订单",loading:"加载中...",refresh:"刷新",networkError:"网络连接失败",serverError:"服务器错误",loadOrdersError:"加载订单列表失败",loadDetailsError:"加载订单明细失败",orderDetailsLoadError:"订单明细加载失败",orderDetailsLoadErrorDescription:"请刷新页面重试",orderNotFound:"订单不存在或已删除",unauthorized:"无权限访问此订单",materialNumber:"物料号",productName:"商品名称",specification:"规格型号",status:"状态",standard:"执行标准",manufacturer:"生产厂家",heatNumber:"炉批号",stockLength:"库存长度",stockWeight:"库存重量",stockLengthUnit:"库存长度(mm)",stockWeightUnit:"库存重量(kg)",quantity:"数量",totalItems:"商品总数",totalLength:"总长度",totalWeight:"总重量",totalLengthUnit:"mm",totalWeightUnit:"kg",statusPending:"待处理",statusDone:"已处理",retry:"重试",serialNumber:"序号",itemsCount:"件商品"},en:{pageTitle:"My Orders",ordersList:"Orders List",orderDetails:"Order Details",orderNumber:"Order Number",orderDate:"Order Date",orderStatus:"Order Status",selectOrderPrompt:"Please select an order to view details",selectOrderDescription:"Click on an order item in the left list to view detailed information",noOrders:"No orders found",noOrdersDescription:"You have not submitted any orders yet",loading:"Loading...",refresh:"Refresh",networkError:"Network connection failed",serverError:"Server error",loadOrdersError:"Failed to load orders list",loadDetailsError:"Failed to load order details",orderDetailsLoadError:"Failed to load order details",orderDetailsLoadErrorDescription:"Please refresh the page and try again",orderNotFound:"Order not found or deleted",unauthorized:"Unauthorized to access this order",materialNumber:"Material Number",productName:"Product Name",specification:"Specification",status:"Status",standard:"Standard",manufacturer:"Manufacturer",heatNumber:"Heat Number",stockLength:"Stock Length",stockWeight:"Stock Weight",stockLengthUnit:"Stock Length(mm)",stockWeightUnit:"Stock Weight(kg)",totalItems:"Total Items",totalLength:"Total Length",totalWeight:"Total Weight",totalLengthUnit:"mm",totalWeightUnit:"kg",statusPending:"Pending",statusDone:"Done",quantity:"Quantity",retry:"Retry",serialNumber:"Serial No.",itemsCount:" items"}};class OrderManager{constructor(){this.orders=[],this.selectedOrder=null,this.selectedOrderDetails=null,this.isLoading=!1,this.userId=Number(document.querySelector("#user-id").textContent.trim()),this.currentPage=1,this.recordsPerPage=10,this.totalCount=0,this.currentSearch="",this.calculateRecordsPerPage()}calculateRecordsPerPage(){try{const ordersListHeight=.6*window.innerHeight,itemHeight=56,maxRecords=Math.max(5,Math.floor(ordersListHeight/itemHeight));this.recordsPerPage=Math.min(maxRecords,20)}catch(error){this.recordsPerPage=10}}async init(){try{await this.getOrdersList()}catch(error){console.error("Failed to initialize OrderManager:",error),notifier.show(texts[lang].loadOrdersError,"danger",4e3)}}async getOrdersList(resetPage=!0){if(!this.isLoading){resetPage&&(this.currentPage=1);try{this.isLoading=!0,this.showOrdersLoadingState();const response=await fetch("/stock/get_user_orders",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:this.userId,search:this.currentSearch,page:this.currentPage,rec:this.recordsPerPage})});if(response.ok){const data=await response.json();if(!data.success)throw new Error(data.message||"Failed to get orders");this.orders=data.orders||[],this.totalCount=data.total_count||0,this.renderOrdersList(),this.updatePagination()}else{if(401!==response.status)throw new Error(`Server error: ${response.status}`);window.location.href="/"}}catch(error){console.error("Error loading orders:",error),this.showOrdersErrorState(error.message),notifier.show(texts[lang].loadOrdersError,"danger",4e3)}finally{this.isLoading=!1}}}async searchOrders(searchTerm){this.currentSearch=searchTerm.trim(),await this.getOrdersList()}async goToPage(page){const totalPages=Math.ceil(this.totalCount/this.recordsPerPage);page>=1&&page<=totalPages&&page!==this.currentPage&&(this.currentPage=page,await this.getOrdersList(!1))}async nextPage(){await this.goToPage(this.currentPage+1)}async prevPage(){await this.goToPage(this.currentPage-1)}async firstPage(){await this.goToPage(1)}async lastPage(){const totalPages=Math.ceil(this.totalCount/this.recordsPerPage);await this.goToPage(totalPages)}async getOrderDetails(orderId){if(!this.isLoading)try{this.isLoading=!0,this.showDetailsLoadingState();const response=await fetch("/stock/get_order_details",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:this.userId,order_id:orderId})});if(response.ok){const data=await response.json();if(!data.success||!data.order)throw new Error(data.message||texts[lang].orderNotFound);{this.selectedOrderDetails=data.order;const headerLoading=document.getElementById("details-loading");headerLoading&&(headerLoading.style.display="none"),this.renderOrderDetails(data.order)}}else{if(401!==response.status)throw 403===response.status?new Error(texts[lang].unauthorized):404===response.status?new Error(texts[lang].orderNotFound):new Error(`Server error: ${response.status}`);window.location.href="/"}}catch(error){console.error("Error loading order details:",error),this.showDetailsErrorState(error.message),notifier.show(texts[lang].loadDetailsError,"danger",4e3)}finally{this.isLoading=!1}}selectOrder(orderId){this.selectedOrder=orderId,this.updateOrderSelection(),this.getOrderDetails(orderId),document.querySelector("#order-details-title").textContent=texts[lang].orderDetails+" - "+orderId}updatePagination(){const totalPages=Math.ceil(this.totalCount/this.recordsPerPage),pageInput=document.getElementById("orders-page-input"),totalPagesSpan=document.getElementById("orders-pages"),totalRecordsSpan=document.getElementById("orders-total-records");pageInput&&(pageInput.value=this.currentPage),totalPagesSpan&&(totalPagesSpan.textContent=totalPages),totalRecordsSpan&&(totalRecordsSpan.textContent=this.totalCount);const firstBtn=document.getElementById("orders-first"),prevBtn=document.getElementById("orders-pre"),nextBtn=document.getElementById("orders-aft"),lastBtn=document.getElementById("orders-last");firstBtn&&(firstBtn.disabled=1===this.currentPage),prevBtn&&(prevBtn.disabled=1===this.currentPage),nextBtn&&(nextBtn.disabled=this.currentPage===totalPages||0===totalPages),lastBtn&&(lastBtn.disabled=this.currentPage===totalPages||0===totalPages);const pagination=document.getElementById("orders-pagination");pagination&&(pagination.style.display=this.totalCount>this.recordsPerPage?"flex":"none")}renderOrdersList(){const container=document.getElementById("orders-list");if(0===this.orders.length){container.innerHTML=`\n                    <div class="empty-orders">\n                        <i class="fa fa-list-alt"></i>\n                        <p>${this.currentSearch?"未找到匹配的订单":texts[lang].noOrders}</p>\n                    </div>\n                `;const pagination=document.getElementById("orders-pagination");return void(pagination&&(pagination.style.display="none"))}let html='<div class="orders-list">';this.orders.forEach((order=>{const statusClass=this.getOrderStatusClass(order.status),statusText=this.getOrderStatusText(order.status);html+=`\n                    <div class="order-item" data-order-id="${order.order_id}" onclick="orderManager.selectOrder('${order.order_id}')">\n                        <div class="order-header">\n                            <div class="order-number">${order.order_id}</div>\n                            <div class="order-date">${this.formatDate(order.created_at)}</div>\n                            <div class="order-status ${statusClass}">${statusText}</div>\n                        </div>\n                    </div>\n                `})),html+="</div>",container.innerHTML=html}renderOrderDetails(orderData){document.querySelector(".order-details-container");const infoBlock=document.getElementById("order-info"),tableBlock=document.getElementById("order-details-table"),tbody=document.getElementById("order-details-tbody"),summaryBlock=document.getElementById("order-summary");if(!orderData||!orderData.items){const headerLoading=document.getElementById("details-loading");headerLoading&&(headerLoading.style.display="none");const infoBlock=document.getElementById("order-info"),tableBlock=document.getElementById("order-details-table"),summaryBlock=document.getElementById("order-summary"),defaultBlock=document.getElementById("default-details-state");return infoBlock&&(infoBlock.style.display="none"),tableBlock&&(tableBlock.style.display="none"),summaryBlock&&(summaryBlock.style.display="none"),void(defaultBlock&&(defaultBlock.style.display="block"))}if(infoBlock){const headerLoading=document.getElementById("details-loading");headerLoading&&(headerLoading.style.display="none"),infoBlock.style.display="block";const idEl=document.getElementById("order-id-display"),dateEl=document.getElementById("order-date-display"),statusEl=document.getElementById("order-status-display");idEl&&(idEl.textContent=orderData.order_id||""),dateEl&&(dateEl.textContent=this.formatDate(orderData.created_at)),statusEl&&(statusEl.textContent=this.getOrderStatusText(orderData.status),statusEl.className="info-value status "+this.getOrderStatusClass(orderData.status))}let totalItems=orderData.items.length,totalLength=0,totalWeight=0;if(orderData.items.forEach((item=>{const qty=Number(item.quantity||1),len=Number(item.stock_length||0),wt=Number(item.stock_weight||0);totalLength+=len*qty,totalWeight+=wt*qty})),tableBlock&&tbody){const defaultBlock=document.getElementById("default-details-state");defaultBlock&&(defaultBlock.style.display="none"),tableBlock.style.display="block";let rowsHtml="";orderData.items.forEach(((item,index)=>{rowsHtml+=`\n                        <tr>\n                            <td>${index+1}</td>\n                            <td>${item.product_name||""}</td>\n                            <td>${item.material_number||""}</td>\n                            <td>${item.specification||""}</td>\n                            <td>${item.status||""}</td>\n                            <td title="${item.standard||""}">${item.standard||""}</td>\n                            <td>${item.manufacturer||""}</td>\n                            <td title="${item.heat_number||""}">${item.heat_number||""}</td>\n                            <td>${Number(item.stock_length||0)}</td>\n                            <td>${Number(item.stock_weight||0).toFixed(2)}</td>\n                            <td>${Number(item.quantity||1)}</td>\n                        </tr>\n                    `})),tbody.innerHTML=rowsHtml,fixOrderDetailsHeaderAlignment(),setTimeout((()=>{try{syncOrderDetailsTableHeight()}catch(e){}}),0)}if(summaryBlock){summaryBlock.style.display="block";const itemsEl=document.getElementById("order-total-items"),lengthEl=document.getElementById("order-total-length"),weightEl=document.getElementById("order-total-weight");itemsEl&&(itemsEl.textContent=totalItems.toString()),lengthEl&&(lengthEl.textContent=`${totalLength} ${texts[lang].totalLengthUnit}`),weightEl&&(weightEl.textContent=`${totalWeight.toFixed(2)} ${texts[lang].totalWeightUnit}`)}setTimeout((()=>{try{syncOrderDetailsTableHeight()}catch(e){}}),0)}updateOrderSelection(){if(document.querySelectorAll(".order-item").forEach((item=>{item.classList.remove("selected")})),this.selectedOrder){const selectedItem=document.querySelector(`[data-order-id="${this.selectedOrder}"]`);selectedItem&&selectedItem.classList.add("selected")}}showOrdersLoadingState(){document.getElementById("orders-list").innerHTML=`\n                <div class="loading-state">\n                    <i class="fa fa-spinner fa-spin"></i>\n                    <p>${texts[lang].loading}</p>\n                </div>\n            `}showDetailsLoadingState(){const headerLoading=document.getElementById("details-loading");headerLoading&&(headerLoading.style.display="block");const infoBlock=document.getElementById("order-info"),tableBlock=document.getElementById("order-details-table"),summaryBlock=document.getElementById("order-summary");infoBlock&&(infoBlock.style.display="none"),tableBlock&&(tableBlock.style.display="none"),summaryBlock&&(summaryBlock.style.display="none")}showOrdersErrorState(errorMessage){document.getElementById("orders-list").innerHTML=`\n                <div class="error-state">\n                    <i class="fa fa-exclamation-triangle"></i>\n                    <p>${errorMessage||texts[lang].loadOrdersError}</p>\n                    <button class="btn btn-primary" onclick="orderManager.getOrdersList()">\n                        ${texts[lang].retry}\n                    </button>\n                </div>\n            `}showDetailsErrorState(errorMessage){const headerLoading=document.getElementById("details-loading");headerLoading&&(headerLoading.style.display="none");const defaultBlock=document.getElementById("default-details-state"),infoBlock=document.getElementById("order-info"),tableBlock=document.getElementById("order-details-table"),summaryBlock=document.getElementById("order-summary"),emptyDetails=document.getElementById("empty-details");if(defaultBlock&&(defaultBlock.style.display="none"),infoBlock&&(infoBlock.style.display="none"),tableBlock&&(tableBlock.style.display="none"),summaryBlock&&(summaryBlock.style.display="none"),emptyDetails){emptyDetails.style.display="block";const emptyMsg=emptyDetails.querySelector(".empty-message");emptyMsg&&(emptyMsg.textContent=errorMessage||texts[lang].loadDetailsError)}}getOrderStatusClass(status){switch(status){case"pending":return"status-pending";case"done":return"status-done";default:return"status-unknown"}}getOrderStatusText(status){switch(status){case"pending":return texts[lang].statusPending;case"done":return texts[lang].statusDone;default:return status||""}}formatDate(dateString){if(!dateString)return"";try{return new Date(dateString).toLocaleString("zh"===lang?"zh-CN":"en-US")}catch(error){return dateString}}}class MyOrdersPageController{constructor(){this.orderManager=new OrderManager}async initPage(){document.title=texts[lang].pageTitle,this.updatePageTexts(),this.bindEventListeners(),await this.orderManager.init(),this.showDefaultPrompt()}updatePageTexts(){const pageTitle=document.querySelector(".myorders-title");pageTitle&&(pageTitle.innerHTML=`<i class="fa fa-list-alt"></i>${texts[lang].pageTitle}`);const refreshBtn=document.querySelector("#refresh-orders-btn");refreshBtn&&(refreshBtn.innerHTML=`<i class="fa fa-refresh"></i>${texts[lang].refresh}`);const ordersListHeader=document.querySelector(".orders-list-section h3");ordersListHeader&&(ordersListHeader.textContent=texts[lang].ordersList),this.updateSearchAndPaginationTexts();const orderDetailsTitle=document.querySelector("#order-details-title");orderDetailsTitle&&(orderDetailsTitle.textContent=texts[lang].orderDetails),this.updateTableHeaders(),this.updateEmptyStates()}updateSearchAndPaginationTexts(){const searchInput=document.getElementById("order-search-input");searchInput&&(searchInput.placeholder="en"===lang?"Search orders":"搜索订单名称");const pageInfo=document.querySelector(".orders-pagination .page-info");pageInfo&&(pageInfo.innerHTML="en"===lang?'<span>Page</span><input type="text" class="form-control" id="orders-page-input" value="1">\n                       <span>of</span><span id="orders-pages"></span><span>pages</span>':'<span>第</span><input type="text" class="form-control" id="orders-page-input" value="1">\n                       <span>页，共</span><span id="orders-pages"></span><span>页</span>');const firstBtn=document.getElementById("orders-first"),prevBtn=document.getElementById("orders-pre"),nextBtn=document.getElementById("orders-aft"),lastBtn=document.getElementById("orders-last");firstBtn&&(firstBtn.title="en"===lang?"First":"首页"),prevBtn&&(prevBtn.title="en"===lang?"Pre":"前一页"),nextBtn&&(nextBtn.title="en"===lang?"Next":"后一页"),lastBtn&&(lastBtn.title="en"===lang?"Last":"尾页");const totalRecords=document.querySelector(".orders-pagination .table-info");totalRecords&&(totalRecords.innerHTML="en"===lang?'Total <span id="orders-total-records"></span> records':'共 <span id="orders-total-records"></span> 条')}updateTableHeaders(){const tableHeaders=document.querySelectorAll(".order-details-table-container th");if(tableHeaders.length>0){const headerTexts=[texts[lang].serialNumber,texts[lang].productName,texts[lang].materialNumber,texts[lang].specification,texts[lang].status,texts[lang].standard,texts[lang].manufacturer,texts[lang].heatNumber,texts[lang].stockLengthUnit,texts[lang].stockWeightUnit,texts[lang].quantity];tableHeaders.forEach(((header,index)=>{headerTexts[index]&&(header.textContent=headerTexts[index])}))}}updateEmptyStates(){const emptyMessage=document.querySelector("#empty-orders .empty-message"),emptyDescription=document.querySelector("#empty-orders .empty-description");emptyMessage&&(emptyMessage.textContent=texts[lang].noOrders),emptyDescription&&(emptyDescription.textContent=texts[lang].noOrdersDescription);const defaultMessage=document.querySelector("#default-details-state .default-message"),defaultDescription=document.querySelector("#default-details-state .default-description");defaultMessage&&(defaultMessage.textContent=texts[lang].selectOrderPrompt),defaultDescription&&(defaultDescription.textContent=texts[lang].selectOrderDescription);const emptyDetailsMessage=document.querySelector("#empty-details .empty-message"),emptyDetailsDescription=document.querySelector("#empty-details .empty-description");emptyDetailsMessage&&(emptyDetailsMessage.textContent=texts[lang].orderDetailsLoadError),emptyDetailsDescription&&(emptyDetailsDescription.textContent=texts[lang].orderDetailsLoadErrorDescription);const summaryLabels=document.querySelectorAll(".order-summary .summary-label");summaryLabels.length>=3&&(summaryLabels[0].textContent=texts[lang].totalItems+"：",summaryLabels[1].textContent=texts[lang].totalLength+"：",summaryLabels[2].textContent=texts[lang].totalWeight+"：")}bindEventListeners(){const refreshBtn=document.getElementById("refresh-orders-btn");refreshBtn&&refreshBtn.addEventListener("click",(()=>{this.handlePageRefresh()})),this.bindSearchListeners(),this.bindPaginationListeners(),document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.clearSelection()})),window.addEventListener("resize",(()=>{this.adjustLayout()}))}bindSearchListeners(){const searchInput=document.getElementById("order-search-input"),searchBtn=document.getElementById("order-search-btn");if(searchBtn&&searchBtn.addEventListener("click",(()=>{this.handleSearch()})),searchInput){let searchTimeout;searchInput.addEventListener("keypress",(e=>{"Enter"===e.key&&this.handleSearch()})),searchInput.addEventListener("input",(()=>{clearTimeout(searchTimeout),searchTimeout=setTimeout((()=>{this.handleSearch()}),500)}))}}bindPaginationListeners(){const firstBtn=document.getElementById("orders-first"),prevBtn=document.getElementById("orders-pre"),nextBtn=document.getElementById("orders-aft"),lastBtn=document.getElementById("orders-last"),pageInput=document.getElementById("orders-page-input");firstBtn&&firstBtn.addEventListener("click",(()=>this.orderManager.firstPage())),prevBtn&&prevBtn.addEventListener("click",(()=>this.orderManager.prevPage())),nextBtn&&nextBtn.addEventListener("click",(()=>this.orderManager.nextPage())),lastBtn&&lastBtn.addEventListener("click",(()=>this.orderManager.lastPage())),pageInput&&pageInput.addEventListener("keypress",(e=>{if("Enter"===e.key){const page=parseInt(pageInput.value,10);isNaN(page)||this.orderManager.goToPage(page)}}))}async handleSearch(){const searchInput=document.getElementById("order-search-input");searchInput&&await this.orderManager.searchOrders(searchInput.value)}async handlePageRefresh(){try{await this.orderManager.getOrdersList(),this.showDefaultPrompt()}catch(error){console.error("Error refreshing page:",error)}}showDefaultPrompt(){if(!this.orderManager.selectedOrder){const headerLoading=document.getElementById("details-loading");headerLoading&&(headerLoading.style.display="none");const defaultBlock=document.getElementById("default-details-state"),infoBlock=document.getElementById("order-info"),tableBlock=document.getElementById("order-details-table"),summaryBlock=document.getElementById("order-summary"),emptyDetails=document.getElementById("empty-details");defaultBlock&&(defaultBlock.style.display="block"),infoBlock&&(infoBlock.style.display="none"),tableBlock&&(tableBlock.style.display="none"),summaryBlock&&(summaryBlock.style.display="none"),emptyDetails&&(emptyDetails.style.display="none")}}clearSelection(){this.orderManager.selectedOrder=null,this.orderManager.selectedOrderDetails=null,this.orderManager.updateOrderSelection(),this.showDefaultPrompt()}adjustLayout(){this.orderManager.calculateRecordsPerPage(),setTimeout((()=>{try{fixOrderDetailsHeaderAlignment()}catch(e){}try{syncOrderDetailsTableHeight()}catch(e){}}),100)}}let orderManager=null,pageController=null;async function initPage(){pageController=new MyOrdersPageController,orderManager=pageController.orderManager;try{"undefined"!=typeof CartManager&&(window._cartManager=new CartManager,await window._cartManager.init())}catch(e){console.warn("Cart init failed on MyOrders:",e)}try{"undefined"!=typeof OrdersManager&&(window._ordersManager=new OrdersManager,await window._ordersManager.init())}catch(e){console.warn("Orders manager init failed on MyOrders:",e)}window.orderManager=orderManager,pageController.initPage()}function fixOrderDetailsHeaderAlignment(){const table=document.querySelector("#order-details-table table");if(!table)return;const thead=table.querySelector("thead"),tbody=table.querySelector("tbody");if(!thead||!tbody)return;const adjust=()=>{const scrollbarWidth=tbody.offsetWidth-tbody.clientWidth;thead.style.width=scrollbarWidth>0?`calc(100% - ${scrollbarWidth}px)`:"100%"};if(adjust(),window.ResizeObserver){new ResizeObserver(adjust).observe(tbody)}tbody.addEventListener("scroll",(()=>{thead.scrollLeft=tbody.scrollLeft}))}function syncOrderDetailsTableHeight(){const outer=document.querySelector(".order-details-table-container"),inner=document.querySelector(".order-details-table-container .table-container.table-order-details");if(!outer||!inner)return;const rect=outer.getBoundingClientRect(),height=Math.max(0,Math.floor(rect.height));height>0&&(inner.style.height=height+"px")}return"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initPage):initPage(),window.addEventListener("languageChanged",(function(event){pageController&&(pageController.updatePageTexts(),orderManager&&(orderManager.renderOrdersList(),orderManager.selectedOrderDetails&&orderManager.renderOrderDetails(orderManager.selectedOrderDetails)))})),{orderManager:()=>orderManager,pageController:()=>pageController,texts:texts,updateLanguage:function(newLang){texts[newLang]&&(localStorage.setItem("language",newLang),window.location.reload())}}}();