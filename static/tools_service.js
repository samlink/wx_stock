String.prototype.trimStr=function(char,type){return char?"left"==type?this.replace(new RegExp("^\\"+char+"+","g"),""):"right"==type?this.replace(new RegExp("\\"+char+"+$","g"),""):this.replace(new RegExp("^\\"+char+"+|\\"+char+"+$","g"),""):this.replace(/^\s+|\s+$/g,"")},Date.prototype.Format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var k in/(y+)/.test(fmt)&&(fmt=fmt.replace(RegExp.$1,this.getFullYear()+"")),o)new RegExp("("+k+")").test(fmt)&&(fmt=fmt.replace(RegExp.$1,1==RegExp.$1.length?o[k]:("00"+o[k]).substr((""+o[k]).length)));return fmt};var SPLITER="<`*_*`>",regInt=/^[+]{0,1}(\d+)$/,regReal=/^-?\d+(\.\d+)?$/,regDate=/(([0-9]{3}[1-9]|[0-9]{2}[1-9][0-9]{1}|[0-9]{1}[1-9][0-9]{2}|[1-9][0-9]{3})-(((0[13578]|1[02])-(0[1-9]|[12][0-9]|3[01]))|((0[469]|11)-(0[1-9]|[12][0-9]|30))|(02-(0[1-9]|[1][0-9]|2[0-8]))))|((([0-9]{2})(0[48]|[2468][048]|[13579][26])|((0[48]|[2468][048]|[3579][26])00))-02-29)/;function padZero(num,length){return(Array(length).join("0")+num).slice(-length)}function getHeight(){let content_height=document.body.clientHeight-138;var sum=0;for(let i=0;i<arguments.length;i++)sum+=arguments[i];return content_height-sum}function download_file(url){var downloadLink=document.createElement("a");downloadLink.href=url,document.body.appendChild(downloadLink),downloadLink.click(),document.body.removeChild(downloadLink)}function checkFileType(input){var acceptType=input.getAttribute("accept"),selectedFile=input.value,fileType=selectedFile.substring(selectedFile.indexOf(".")+1,selectedFile.length);return acceptType.indexOf(fileType)>-1}function append_blanks(len,m){let trs="";for(let i=0;i<len;i++){trs+="<tr>";for(let j=0;j<m;j++)trs+="<td>　</td>";trs+="</tr>"}return trs}function append_cells(m){let tds="";for(let j=0;j<m;j++)tds+="<td></td>";return tds}function goto_tabindex(row,idx){for(var inputs=row.getElementsByTagName("input"),i=0,j=inputs.length;i<j;i++)if(inputs[i].getAttribute("idx")==idx){inputs[i].focus();break}return inputs[i]}function enterToTab(row,input,max_idx){var tabindex=input.getAttribute("idx");return goto_tabindex(row,++tabindex),tabindex}function set_key_move(all_input,form,max_n){all_input.forEach((input=>{input.onkeydown=function(e){if("Enter"==(e=event||window.event).code||"NumpadEnter"==e.code){enterToTab(form,input,all_input.length)==max_n+1&&goto_tabindex(form,1)}}}))}function getLeft(element,parent){for(var left=element.offsetLeft,current=element.offsetParent;null!==current;)left+=current.offsetLeft,current=current.offsetParent;return left-parent.scrollLeft}function getTop(element,parent){for(var actualTop=element.offsetTop,current=element.offsetParent;null!==current;)actualTop+=current.offsetTop,current=current.offsetParent;return actualTop-parent.scrollTop}function moneyUppercase(n){var fraction=["角","分","厘","毫"],digit=["零","壹","贰","叁","肆","伍","陆","柒","捌","玖"],unit=[["元","万","亿"],["","拾","佰","仟"]],head=n<0?"欠":"";n=Math.abs(n);for(var s="",i=0;i<fraction.length;i++)s+=(digit[Math.floor(10*n*Math.pow(10,i))%10]+fraction[i]).replace(/零./,"");s=s||"整",n=Math.floor(n);for(i=0;i<unit[0].length&&n>0;i++){for(var p="",j=0;j<unit[1].length&&n>0;j++)p=digit[n%10]+unit[1][j]+p,n=Math.floor(n/10);s=p.replace(/(零.)*零$/,"").replace(/^$/,"零")+unit[0][i]+s}return head+s.replace(/(零.)*零元/,"元").replace(/(零.)+/g,"零").replace(/^整$/,"零元整")}function open_node(){document.querySelector("#t_4 span").click(),document.querySelector("#t_3 span").click()}function alert_confirm(message,optionsA){var options={cancel:!0,confirmText:"确认",cancelText:"取消",cancelCallBack:()=>{},confirmCallBack:()=>{}};"object"==typeof optionsA&&Object.assign(options,optionsA);let element=document.querySelector("#roar-alert"),cancelElement=document.querySelector(".roar-alert-message-button-cancel"),confirmElement=document.querySelector(".roar-alert-message-button-confirm");options.cancel?(cancelElement.innerHTML=options.cancelText,cancelElement.addEventListener("click",(()=>{options.cancelCallBack(),element.style.display="none"}))):cancelElement.style.display="none",confirmElement.innerHTML=options.confirmText,confirmElement.addEventListener("click",(()=>{options.confirmCallBack(),element.style.display="none"})),document.querySelector(".roar-alert-message-content").innerHTML=message,element.style.display="block"}!function(root,factory){"object"==typeof exports&&"object"==typeof module?module.exports=factory():"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?exports.notifier=factory():root.notifier=factory()}("undefined"!=typeof self?self:this,(function(){var container,count=0,d=document,myCreateElement=function(elem,attrs){var el=d.createElement(elem);for(var prop in attrs)el.setAttribute(prop,attrs[prop]);return el},hide=function(notificationId){var notification=document.getElementById(notificationId);return!!notification&&(notification.className=notification.className.replace(" shown",""),setTimeout((function(){notification.parentNode.removeChild(notification)}),600),!0)};return container=myCreateElement("div",{class:"notifier-container",id:"notifier-container"}),d.body.appendChild(container),{show:function(msg,type,timeout=3e3,width=0){var ntfId="notifier-"+count,container=d.querySelector(".notifier-container"),ntf=myCreateElement("div",{class:"notifier "+type}),ntfBody=myCreateElement("div",{class:"notifier-body"}),ntfClose=myCreateElement("button",{class:"notifier-close",type:"button"});return 0!=width&&(container.style.width=width+"px"),ntfBody.innerHTML=msg,ntfClose.innerHTML="×",ntf.appendChild(ntfClose),ntf.appendChild(ntfBody),container.appendChild(ntf),setTimeout((function(){ntf.className+=" shown",ntf.setAttribute("id",ntfId)}),100),timeout>0&&setTimeout((function(){hide(ntfId)}),timeout),ntfClose.addEventListener("click",(function(){hide(ntfId)})),count+=1,ntfId},hide:hide}}));class AutoInput{constructor(input,cate,url,cb,width){this.input=input,this.cate=cate,this.url=url,this.cb=cb,this.space=400,this.width=width}init(){var currentFocus,input=this.input,cb=this.cb,width=this.width;function addActive(x){if(!x)return!1;!function(x){for(var i=0;i<x.length;i++)x[i].classList.remove("autocomplete-active")}(x),currentFocus>=x.length&&(currentFocus=0),currentFocus<0&&(currentFocus=x.length-1),x[currentFocus].classList.add("autocomplete-active")}function closeAllLists(elmnt){var x=document.querySelector(".autocomplete-items");x&&elmnt!=x&&elmnt!=input&&x.parentNode.removeChild(x)}input.addEventListener("input",(()=>{var a,b,i,get_url,val=input.value,space=this.space;if(closeAllLists(),!val)return!1;currentFocus=-1,get_url=""==this.cate?`${this.url}?s=${val}`:"string"==typeof this.cate?`${this.url}?s=${val}&cate=${this.cate}`:`${this.url}?s=${val}&cate=${this.cate.textContent?this.cate.textContent:this.cate.value}`,fetch(get_url).then((response=>response.json())).then((function(arr){if(-1!=arr&&arr.length>0){(a=document.createElement("DIV")).setAttribute("id","autocomplete-list"),a.setAttribute("class","autocomplete-items"),input.parentNode.appendChild(a);let top=getTop(input,document.querySelector("body"))+30,left=getLeft(input,document.querySelector("body")),au_width=width||input.clientWidth;for(a.style.cssText=`position:fixed; top: ${top}px; left: ${left}px; width: ${au_width}px;`,i=0;i<arr.length;i++)(b=document.createElement("DIV")).innerHTML=arr[i].label,b.innerHTML+="<input type='hidden' id='"+arr[i].id+"' value='"+arr[i].label+"'>",b.addEventListener("click",(function(e){e.stopPropagation(),input.value=this.querySelector("input").value,input.setAttribute("data",this.querySelector("input").getAttribute("id")),closeAllLists(),cb&&"function"==typeof cb&&cb()})),a.appendChild(b),b.style.width=.93*au_width+"px";a.clientHeight>space&&(a.style.top=-(a.clientHeight-space+30)+"px",a.style.left="120px",a.style.borderTop="1px solid #9acffa")}}))})),input.addEventListener("keydown",(function(e){var x=document.querySelectorAll("#autocomplete-list div");x.length>0&&("ArrowDown"==e.key?(currentFocus++,addActive(x)):"ArrowUp"==e.key?(currentFocus--,addActive(x)):"Enter"==e.key?(e.preventDefault(),currentFocus>-1?x[currentFocus].click():x[0].click()):"Escape"==e.key?closeAllLists():"Tab"==e.key&&(e.preventDefault(),currentFocus>-1?x[currentFocus].click():x[0].click()))})),document.addEventListener("click",(function(e){closeAllLists(e.target)}))}}function auto_table(input,cate,url,thead,cb,cf){var currentFocus;function addActive(x){if(!x)return!1;!function(x){for(var i=0;i<x.length;i++)x[i].classList.remove("autocomplete-active")}(x),currentFocus>=x.length&&(currentFocus=0),currentFocus<0&&(currentFocus=x.length-1),x[currentFocus].classList.add("autocomplete-active")}function closeAllLists(elmnt){var x=document.querySelector(".autocomplete-items");x&&elmnt!=x&&elmnt!=input&&x.parentNode.removeChild(x)}input.addEventListener("input",(function(e){var a,i,val=this.value;if(closeAllLists(),!val)return!1;let get_url;if(currentFocus=-1,""!=cate){let c="string"==typeof cate?cate:cate.textContent;get_url=`${url}?s=${val}&cate=${c}`}else get_url=`${url}?s=${val}`;"function"==typeof cf&&(get_url+=`&ss=${cf()}`),fetch(get_url).then((response=>response.json())).then((function(arr){if(-1!=arr&&arr.length>0){(a=document.createElement("DIV")).setAttribute("id","autocomplete-list"),a.setAttribute("class","autocomplete-items table-auto"),a.innerHTML="<table><thead><tr></tr></thead><tbody></tbody></table>",input.parentNode.appendChild(a);let ths="";for(let i=0;i<thead.length;i++)ths+=`<th width=${thead[i].width}>${thead[i].name}</th>`;document.querySelector(".table-auto thead tr").innerHTML=ths;let tbody=document.querySelector(".table-auto tbody");for(i=0;i<arr.length;i++){let items=arr[i].label.split(SPLITER),tr=document.createElement("tr");tr.setAttribute("data",`${arr[i].id}${SPLITER}${arr[i].label}`);let row="";for(let i=0;i<items.length;i++)row+=`<td width=${thead[i].width}>${items[i]}</td>`;tr.innerHTML=row,tr.addEventListener("click",(function(e){e.stopPropagation(),input.value=this.querySelector("td:nth-child(1)").textContent,input.setAttribute("data",this.getAttribute("data")),closeAllLists(),cb&&"function"==typeof cb&&cb()})),tbody.appendChild(tr)}}}))})),input.addEventListener("keydown",(function(e){var x=document.querySelectorAll("#autocomplete-list tbody tr");x.length>0&&("ArrowDown"==e.key?(currentFocus++,addActive(x)):"ArrowUp"==e.key?(currentFocus--,addActive(x)):"Enter"==e.key?(e.preventDefault(),currentFocus>-1?x[currentFocus].click():x[0].click()):"Escape"==e.key?closeAllLists():"Tab"==e.key&&(e.preventDefault(),currentFocus>-1?x[currentFocus].click():x[0].click()))})),document.addEventListener("click",(function(e){closeAllLists(e.target)}))}var modal_out_data={edit:0};function modal_init(){document.querySelector("#modal-close-button").addEventListener("click",(function(){document.querySelector("#modal-sumit-button").style.display="inline-block",close_modal()})),document.querySelector(".top-close").addEventListener("click",(function(){document.querySelector("#modal-sumit-button").style.display="inline-block",close_modal()}))}function close_modal(){1==modal_out_data.edit?alert_confirm("编辑还未保存，确认退出吗？",{confirmCallBack:()=>{modal_edit=0,document.querySelector(".modal").style.display="none"}}):document.querySelector(".modal").style.display="none",document.querySelector("#modal-info").innerHTML=""}function leave_alert(){let all_input=document.querySelectorAll(".modal input");for(let input of all_input)input.addEventListener("input",(()=>{modal_edit=1}));let all_select=document.querySelectorAll(".modal select");for(let select of all_select)select.addEventListener("change",(function(){modal_edit=1}))}var tool_tree=function(){var zhezhao,global={tree_leaf:"",node_num:"",is_saved:!0,name_save:"",edit_cate:"",drag_id:"",home_id:"",drag_list:[]};function tree_change(node){node.parentNode.parentNode.hasAttribute("id")||(node.parentNode.parentNode.classList.add("active"),node.parentNode.parentNode.previousElementSibling.classList.remove("item"),node.parentNode.parentNode.previousElementSibling.classList.add("item-down"),tree_change(node.parentNode.parentNode))}function find_root(node){let id=node.parentNode.getAttribute("id");if(id&&"tree"==id)node.parentNode.insertAdjacentElement("afterbegin",node);else{find_root(node.parentNode)}}function gener_tree(tree_node,data){if(data.length>0){for(let i in data){var node=document.createElement("li");if(node.setAttribute("id","t_"+data[i].num),node.setAttribute("draggable","true"),data[i].children.length>0){node.innerHTML='<span class="item" data-num="'+data[i].num+'">'+data[i].node_name+"</span>";var ul=document.createElement("ul");ul.classList.add("nested");var child=gener_tree(ul,data[i].children);node.appendChild(child)}else node.innerText=data[i].node_name,node.classList.add("leaf"),node.setAttribute("data-num",data[i].num),node.addEventListener("click",leaf_click);tree_node.appendChild(node)}return tree_node}}function leaf_click(){if("INPUT"==event.target.tagName)return!1;let self=this;if(global.node_num==this.dataset.num)return!1;let get_new=function(){global.is_saved=!0,global.tree_leaf=self.innerText,global.node_num=self.dataset.num,"function"==typeof global.leaf_click&&global.leaf_click(global.node_num,self.textContent);var leaves=document.querySelectorAll(".leaf");for(let leaf of leaves)leaf.classList.remove("is-selected");self.classList.add("is-selected")};if(global.is_saved)get_new();else{alert_confirm("编辑还未保存，是否加载新内容？",{confirmCallBack:get_new})}}return{tree_init:function(data){Object.assign(global,data),document.querySelector("#context-menu"),zhezhao=document.querySelector("#zhezhao"),document.addEventListener("click",(function(event){var has_input=document.querySelector("#input_node");has_input&&"INPUT"!==event.target.tagName&&tree_edit(has_input,undefined)})),document.addEventListener("keydown",(function(event){if(event&&"Enter"==event.key){var has_input=document.querySelector("#input_node");tree_edit(has_input,undefined)}else if(event&&"Escape"==event.key){if((has_input=document.querySelector("#input_node"))&&"编辑"==global.edit_cate)zhezhao.style.display="none",has_input.parentNode.innerHTML=global.name_save;else if(has_input&&"增加"==global.edit_cate){var parent_node=has_input.parentNode.parentNode;parent_node.removeChild(has_input.parentNode),function(parent_node){if(0==parent_node.children.length){var pp_node=parent_node.parentNode,num2=pp_node.firstChild.dataset.num;pp_node.removeChild(parent_node),pp_node.innerHTML=pp_node.firstChild.innerHTML,pp_node.classList.add("leaf"),pp_node.setAttribute("data-num",num2),pp_node.addEventListener("click",leaf_click)}}(parent_node),zhezhao.style.display="none"}}}))},fetch_tree:function(func){fetch("/stock/tree").then((response=>response.json())).then((data=>{var tree=document.querySelector("#tree");tree.innerHTML="",gener_tree(tree,data);var toggle=document.querySelectorAll(".item");for(let i=0;i<toggle.length;i++)toggle[i].classList.remove("item"),toggle[i].classList.add("item-down"),toggle[i].parentNode.querySelector(".nested").classList.add("active");"function"==typeof func&&func()}))},tree_search:function(value){value=value.toLowerCase();var tree=document.querySelector("#tree"),spans=tree.querySelectorAll("span"),leaves=tree.querySelectorAll(".leaf"),items=tree.querySelectorAll(".item-down");for(let item of items)item.click();for(let span of spans)span.classList.remove("found-color"),""!=value&&span.innerText.toLowerCase().includes(value)&&(span.classList.add("found-color"),span.classList.remove("item"),span.classList.add("item-down"),span.nextElementSibling.classList.add("active"),tree_change(span),find_root(span));for(let leaf of leaves)leaf.classList.remove("found-color"),""!=value&&leaf.innerText.toLowerCase().includes(value)&&(leaf.classList.add("found-color"),leaf.parentNode.classList.add("active"),leaf.parentNode.previousElementSibling.classList.remove("item"),leaf.parentNode.previousElementSibling.classList.add("item-down"),tree_change(leaf.parentNode),find_root(leaf.parentNode))}}}(),tool_table=function(){var cb_function,container,resize,table_data={},fetch_table=function(cb){fetch(table_data.url,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(table_data.post_data)}).then((response=>response.json())).then((content=>{if(-1!=content){let rows="",count=0;for(let tr of content[0])rows+=table_data.row_fn(tr),count++;for(let i=0;i<table_data.post_data.rec-count;i++){let row="<tr>";for(let j=0;j<table_data.blank_cells;j++)row+="<td></td>";rows+=row+"</tr>"}table_data.body.innerHTML=rows,table_data.total_records.textContent=content[1],table_data.total_pages.textContent=content[2],table_data.page_input.value=table_data.post_data.page,table_data.other_info&&content[3]&&(table_data.other_info.textContent=content[3]),function(input,first,pre,aft,last,pages){input.value<=1?(input.value=1,first.disabled=!0,pre.disabled=!0):(first.disabled=!1,pre.disabled=!1);input.value>=pages?(input.value=pages,last.disabled=!0,aft.disabled=!0):(last.disabled=!1,aft.disabled=!1)}(table_data.page_input,table_data.page_first,table_data.page_pre,table_data.page_aft,table_data.page_last,content[2]);for(let tr of table_data.body.children)tr.addEventListener("click",(function(e){if(!table_data.edit){for(let r of table_data.body.children)r.classList.remove("focus");this.classList.add("focus"),"function"==typeof table_data.row_click&&table_data.row_click(tr)}}));let links=table_data.body.querySelectorAll("a");if(links.length>0)for(let l of links)l.addEventListener("click",(function(e){e.stopPropagation()}));!function(){var tTD,table=document.querySelector(container+" table");for(let j=0;j<table.rows[0].cells.length;j++)table.rows[0].cells[j].onmousedown=function(event){tTD=this,event.offsetX>tTD.offsetWidth-10&&(tTD.mouseDown=!0,tTD.oldX=event.x,tTD.oldWidth=tTD.offsetWidth)},table.rows[0].cells[j].onmouseup=function(event){null==tTD&&(tTD=this),tTD.mouseDown=!1,tTD.style.cursor="pointer",setTimeout((()=>{resize=!1}),100)},table.rows[0].cells[j].onmousemove=function(event){if(event.offsetX>this.offsetWidth-10?this.style.cursor="col-resize":this.style.cursor="pointer",null==tTD&&(tTD=this),null!=tTD.mouseDown&&1==tTD.mouseDown){for(tTD.style.cursor="pointer",tTD.oldWidth+(event.x-tTD.oldX)>0&&(tTD.width=tTD.oldWidth+(event.x-tTD.oldX)),tTD.style.width=tTD.width,tTD.style.cursor="col-resize",table=tTD;"TABLE"!=table.tagName;)table=table.parentElement;for(j=0;j<table.rows.length;j++)table.rows[j].cells[tTD.cellIndex].width=tTD.width;resize=!0}}}(),"function"==typeof cb&&(cb_function=cb,cb(content))}else alert("无此操作权限")}))};function change_page(value){table_data.page_input.value=value>Number(table_data.total_pages.textContent)?Number(table_data.total_pages.textContent):value<1?1:value,Object.assign(table_data.post_data,{page:Number(table_data.page_input.value)}),fetch_table(cb_function)}return{table_data:function(){return table_data},table_init:function(data){if(table_data=Object.assign(data,{header:document.querySelector(data.container+" thead tr"),body:document.querySelector(data.container+" tbody"),page_input:document.querySelector(data.container+" #page-input"),page_first:document.querySelector(data.container+" #first"),page_pre:document.querySelector(data.container+" #pre"),page_aft:document.querySelector(data.container+" #aft"),page_last:document.querySelector(data.container+" #last"),total_pages:document.querySelector(data.container+" #pages"),total_records:document.querySelector(data.container+" #total-records"),other_info:document.querySelector(data.container+" #other-info")}),container=data.container,table_data.page_input.value=1,table_data.page_first.disabled=!0,table_data.page_pre.disabled=!0,table_data.post_data.page=1,table_data.page_pre.addEventListener("click",(e=>{table_data.edit||(table_data.page_input.value--,change_page(table_data.page_input.value))})),table_data.page_aft.addEventListener("click",(e=>{table_data.edit||(table_data.page_input.value++,change_page(table_data.page_input.value))})),table_data.page_first.addEventListener("click",(e=>{table_data.edit||change_page(1)})),table_data.page_last.addEventListener("click",(e=>{table_data.edit||change_page(table_data.total_pages.textContent)})),table_data.page_input.addEventListener("change",(function(){table_data.edit||change_page(table_data.page_input.value)})),table_data.header)for(let th of table_data.header.children)th.addEventListener("click",(function(e){if(!resize&&!table_data.edit&&"序号"!=this.textContent){for(let t of table_data.header.children)t.textContent=t.textContent.split(" ")[0];let order=-1!==table_data.post_data.sort.indexOf("ASC")?"DESC":"ASC",sort=(table_data.post_data.sort.indexOf("ASC"),table_data.header_names[this.textContent]+" "+order);Object.assign(table_data.post_data,{page:1,sort:sort}),table_data.page_input.value=1,fetch_table(cb_function)}}))},fetch_table:fetch_table}}();class MakeTable{constructor(table_data,cb){this.table_data=table_data,this.cb_function=cb}init(){let this_table=this,table_data=this.table_data;if(table_data.page_input.value=1,table_data.page_first.disabled=!0,table_data.page_pre.disabled=!0,table_data.post_data.page=1,table_data.page_pre.addEventListener("click",(e=>{table_data.edit||(table_data.page_input.value--,change_page(table_data.page_input.value))})),table_data.page_aft.addEventListener("click",(e=>{table_data.edit||(table_data.page_input.value++,change_page(table_data.page_input.value))})),table_data.page_first.addEventListener("click",(e=>{table_data.edit||change_page(1)})),table_data.page_last.addEventListener("click",(e=>{table_data.edit||change_page(table_data.total_pages.textContent)})),table_data.page_input.addEventListener("change",(function(){table_data.edit||change_page(table_data.page_input.value)})),table_data.header)for(let th of table_data.header.children)th.addEventListener("click",(function(e){if(!table_data.edit&&"序号"!=th.textContent){for(let t of table_data.header.children)t.textContent=t.textContent.split(" ")[0];let order=-1!==table_data.post_data.sort.indexOf("ASC")?"DESC":"ASC",arrow=-1!==table_data.post_data.sort.indexOf("ASC")?"▼":"▲",sort=table_data.header_names[this.textContent]+" "+order;this.textContent=this.textContent+" "+arrow,Object.assign(table_data.post_data,{page:1,sort:sort}),table_data.page_input.value=1,this_table.fetch_table()}}));function change_page(value){table_data.page_input.value=value>Number(table_data.total_pages.textContent)?Number(table_data.total_pages.textContent):value<1?1:value,Object.assign(table_data.post_data,{page:Number(table_data.page_input.value)}),this_table.fetch_table()}}change_data(data){Object.assign(this.table_data.post_data,data)}fetch_table(){let table_data=this.table_data;fetch(table_data.url,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(table_data.post_data)}).then((response=>response.json())).then((content=>{if(-1!=content){let rows="",count=0;for(let tr of content[0])rows+=table_data.row_fn(tr),count++;for(let i=0;i<table_data.post_data.rec-count;i++)rows+=table_data.blank_row_fn();table_data.body.innerHTML=rows,table_data.total_records.textContent=content[1],table_data.total_pages.textContent=content[2],table_data.page_input.value=table_data.post_data.page,function(input,first,pre,aft,last,pages){input.value<=1?(input.value=1,first.disabled=!0,pre.disabled=!0):(first.disabled=!1,pre.disabled=!1);input.value>=pages?(input.value=pages,last.disabled=!0,aft.disabled=!0):(last.disabled=!1,aft.disabled=!1)}(table_data.page_input,table_data.page_first,table_data.page_pre,table_data.page_aft,table_data.page_last,content[2]);for(let tr of table_data.body.children)tr.addEventListener("click",(function(e){if(!table_data.edit){for(let r of table_data.body.children)r.classList.remove("focus");this.classList.add("focus"),"function"==typeof table_data.row_click&&table_data.row_click(tr)}}));let links=table_data.body.querySelectorAll("a");if(links.length>0)for(let l of links)l.addEventListener("click",(function(e){e.stopPropagation()}));!function(){var tTD,table=table_data.table;for(let j=0;j<table.rows[0].cells.length;j++)table.rows[0].cells[j].onmousedown=function(event){tTD=this,event.offsetX>tTD.offsetWidth-10&&(tTD.mouseDown=!0,tTD.oldX=event.x,tTD.oldWidth=tTD.offsetWidth)},table.rows[0].cells[j].onmouseup=function(event){null==tTD&&(tTD=this),tTD.mouseDown=!1,tTD.style.cursor="pointer"},table.rows[0].cells[j].onmousemove=function(event){if(event.offsetX>this.offsetWidth-10?this.style.cursor="col-resize":this.style.cursor="pointer",null==tTD&&(tTD=this),null!=tTD.mouseDown&&1==tTD.mouseDown){for(tTD.style.cursor="pointer",tTD.oldWidth+(event.x-tTD.oldX)>0&&(tTD.width=tTD.oldWidth+(event.x-tTD.oldX)),tTD.style.width=tTD.width,tTD.style.cursor="col-resize",table=tTD;"TABLE"!=table.tagName;)table=table.parentElement;for(j=0;j<table.rows.length;j++)table.rows[j].cells[tTD.cellIndex].width=tTD.width}}}(),"function"==typeof this.cb_function&&this.cb_function()}else alert("无此操作权限")}))}}var service=function(){let build_table_header=function(table_container,custom_fields,table_fields,last_fields,table_name){let all_width=0;for(let item of custom_fields)all_width+=item.width;if(last_fields)for(let item of last_fields)all_width+=item.width;for(let item of table_fields)all_width+=item.show_width;let table_width=table_container.clientWidth,width_raio=table_width/all_width,row="";if(width_raio<18){for(let item of custom_fields)row+=`<th width='${18*item.width}px'>${item.name}</th>`;table_container.style.width=table_width,table_container.querySelector(".table-ctrl").style.cssText=`\n            position: absolute;\n            width: ${table_width+2}px;\n            margin-top: 11px;\n            border: 1px solid #edf5fb;\n            margin-left: -2px;`}else for(let item of custom_fields)row+=`<th width='${100*item.width/all_width}%'>${item.name}</th>`;let header_names={};for(let th of custom_fields)header_names[th.name]=th.field;for(let th of table_fields)row+=width_raio>18?`<th width="${(100*th.show_width/all_width).toFixed(1)}%">${th.show_name}</th>`:`<th width="${18*th.show_width}px">${th.show_name}</th>`,header_names[th.show_name]=`${table_name}.${th.field_name}`;if(last_fields)for(let item of last_fields)row+=width_raio<18?`<th width='${18*item.width}px'>${item.name}</th>`:`<th width='${100*item.width/all_width}%'>${item.name}</th>`,header_names[item.name]=item.field;return{th_row:row,header_names:header_names}};function table_row(tr){let rec=tr.split(SPLITER),name=rec[1].split(" ");return`<tr><td class="序号">${rec[0]}</td><td class="名称">${name[1]}</td><td class="材质">${name[0]}</td>\n                <td class="物料号">${rec[2]}</td><td class="规格">${rec[3]}</td><td class="状态">${rec[4]}</td>\n                <td class="执行标准" title="${rec[5]}">${rec[5]}</td><td class="生产厂家">${rec[6]}</td>\n                <td class="炉号" title="${rec[7]}">${rec[7]}</td><td>${rec[8]}</td><td>${rec[9]}</td><td>${rec[10]}</td></tr>`}return{build_table_header:build_table_header,build_product_table:function(row_num,cb,more,more2){let init_data={container:".table-product",url:"/stock/fetch_product",post_data:{id:"",name:"",sort:"products.物料号 ASC",rec:row_num,cate:"正常销售",page:1,filter:"",user:document.querySelector("#user-id").textContent.trim()},header_names:{"名称":"split_part(node_name,' ',2)","材质":"split_part(node_name,' ',1)","物料号":"products.物料号","规格":"规格型号","状态":"products.文本字段2","执行标准":"products.文本字段3","生产厂家":"products.文本字段5","炉号":"products.文本字段4","库存长度":"COALESCE(foo.库存长度,0)","库存重量":"COALESCE(foo.理论重量,0)","备注":"products.备注"},edit:!1,blank_cells:18,row_fn:table_row},table=document.querySelector(".table-product"),header=build_table_header(table,[{name:"序号",width:2},{name:"名称",width:4},{name:"材质",width:4},{name:"物料号",width:4},{name:"规格",width:4},{name:"状态",width:4},{name:"执行标准",width:6},{name:"生产厂家",width:4},{name:"炉号",width:5},{name:"库存长度",width:3},{name:"库存重量",width:3},{name:"备注",width:5}],"","","products");table.querySelector("thead tr").innerHTML=header.th_row,tool_table.table_init(init_data),tool_table.fetch_table((content=>{cb&&cb(table),more&&more(),more2&&more2(content)})),document.querySelector("#serach-button").addEventListener("click",(function(){!function(){let search=document.querySelector("#search-input").value;Object.assign(tool_table.table_data().post_data,{name:search,page:1});let table=document.querySelector(".table-product");tool_table.fetch_table((content=>{cb&&cb(table),more&&more(),more2&&more2(content)}))}()}))}}}();let edit_table=function(){if(!document.querySelector(".table-history"))return;let all_width;input_data={container:document.querySelector(".table-items"),width:document.querySelector(".content").clientWidth-document.querySelector(".table-history").clientWidth-15,show_names:"",document:"入库单据"};var input_table_outdata={};document.querySelector("#row-insert").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");if(edit){let table_body=document.querySelector(".table-items tbody"),input_row=build_input_row(input_data.show_names,all_width);remove_inputting(),table_body.insertBefore(input_row,edit),rebuild_index(),sum_records(),keep_up(),input_row.querySelector("td:nth-child(2)").click()}else notifier.show("请先选择行","danger")})),document.querySelector("#row-del").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");edit?alert_confirm("确认删除行吗？",{confirmCallBack:()=>{edit.parentNode.removeChild(edit),sum_records(),rebuild_index(),keep_up(),"function"==typeof input_data.change_func&&input_data.change_func()}}):notifier.show("请先选择行","danger")})),document.querySelector("#row-up").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");edit?edit.previousElementSibling&&(edit.parentNode.insertBefore(edit,edit.previousElementSibling),rebuild_index()):notifier.show("请先选择行","danger")})),document.querySelector("#row-down").addEventListener("click",(function(e){let edit=document.querySelector(".inputting");edit?edit.nextElementSibling&&""!=edit.nextElementSibling.querySelector("td:nth-child(1)").textContent&&(edit.parentNode.insertBefore(edit.nextElementSibling,edit),rebuild_index()):notifier.show("请先选择行","danger")}));function build_blank_th(){input_data.container.style.width=input_data.width,all_width=0,input_data.show_names.forEach((obj=>{all_width+=obj.width}));let th="<tr>",blank="<tr>";input_data.show_names.forEach((obj=>{let hidden=obj.css?obj.css:"";th+=`<th width=${100*obj.width/all_width} ${hidden}>${obj.name}</th>`,blank+=`<td width=${100*obj.width/all_width} ${hidden}></td>`})),th+="</tr>",blank+="</tr>",input_data.container.querySelector("thead").innerHTML=th,input_data.blank_row=blank}function append_blanks(tbody,num){for(let i in input_data.show_names)void 0===input_data.show_names[i].value&&(input_data.show_names[i].value="");keep_up();let rows="";for(let i=0;i<input_data.lines-num+1;i++)rows+=input_data.blank_row;tbody.querySelector("tr:nth-last-child(1)").insertAdjacentHTML("afterend",rows),setTimeout((()=>{sum_records()}),100)}function build_input_row(show_names,all_width,num){num||(num=1);let input_row=document.createElement("tr");input_row.classList.add("has-input"),input_row.innerHTML=function(show_names,all_width){let control="",m_id=show_names[show_names.length-1].value,idx=1;for(let obj of show_names){let hidden=obj.css?obj.css:"";if("普通输入"==obj.type&&obj.editable){let va=obj.value?obj.value:"";control+=`<td width=${100*obj.width/all_width} class="editable" ${hidden}>\n            <input class="form-control input-sm has-value ${obj.class}" type="text" idx="${idx++}" value="${va}"></td>`}else if("普通输入"!=obj.type||obj.editable)if("二值选一"==obj.type&&obj.editable){let checked;checked=obj.value?obj.value:"",control+=`<td width=${100*obj.width/all_width} class="editable" ${hidden}><label class="check-radio">\n                                <input class="has-value ${obj.class}" type="checkbox" ${checked}>\n                                <span class="checkmark"></span>\n                            </label>\n                        </td>`}else if("二值选一"!=obj.type||obj.editable)if("下拉列表"==obj.type&&obj.editable){control+=`<td width=${100*obj.width/all_width} class="editable" ${hidden}><select class='select-sm has-value ${obj.class}'>`;let options=obj.default.split("_");for(let value of options)control+=`<option value="${value}" ${value==obj.value?"selected":""}>${value}</option>`;control+="</select></td>"}else if("下拉列表"!=obj.type||obj.editable){if("autocomplete"==obj.type&&obj.editable){let button=obj.no_button?"":"<button class='btn btn-info btn-sm product-search-button'> ... </button>";control+=`\n            <td width=${100*obj.width/all_width} class="editable" >\n                <div class="form-input autocomplete" style="z-index: 900; position: inherit">\n                    <input class="form-control input-sm has-value auto-input ${obj.class}" type="text" \n                        value="${obj.value}" idx="${idx++}" data="${m_id}">                        \n                    ${button}\n                </div>\n            </td>`}}else control+=`<td width=${100*obj.width/all_width}>${obj.value?obj.value:""} ${hidden}</td>`;else control+=`<td width=${100*obj.width/all_width}>${obj.value?obj.value:""} ${hidden}</td>`;else control+=`<td width=${100*obj.width/all_width} class='${obj.class}' ${hidden}>${obj.value?obj.value:""} </td>`}return control}(show_names,all_width),input_data.auto_data&&function(input_row,auto_data){for(let auto of auto_data){let th=document.querySelector(`.table-items th:nth-child(${auto.n})`),td=input_row.querySelector(`td:nth-child(${auto.n})`),data={auto_th:th,auto_td:td,auto_input:td.querySelector(".auto-input")};Object.assign(auto,data),auto.auto_td.addEventListener("click",(function(){element_position(this,7.4,1)})),auto.auto_input.addEventListener("focus",(function(){remove_inputting(),this.parentNode.parentNode.parentNode.classList.add("inputting")})),auto.type&&"table"!=auto.type?new AutoInput(auto.auto_input,auto.cate,auto.auto_url,"",auto.width).init():auto_table(auto.auto_input,auto.cate,auto.auto_url,auto.show_th,auto.cb,auto.cf)}}(input_row,input_data.auto_data),input_row.addEventListener("click",(function(){remove_inputting(),this.classList.add("inputting")})),input_row.querySelector("td:nth-child(1)").textContent=num,input_row.querySelector(".product-search-button")&&input_row.querySelector(".product-search-button").addEventListener("click",(function(){if(!this.parentNode.parentNode.parentNode.classList.contains("inputting"))return!1;service.sales_products("选择商品")})),"function"==typeof input_data.calc_func&&input_data.calc_func(input_row),"function"==typeof input_data.calc_func2&&input_data.calc_func2(input_row);let max_n=input_row.querySelectorAll("input").length;return input_row.querySelectorAll("input").forEach((input=>input.onkeydown=e=>{document.querySelectorAll(".table-items .has-input");let next_tr=document.querySelector(".table-items .inputting+tr");!function(event,row,input,next_tr,max_idx){var e=event||window.event;"Enter"!=e.code&&"NumpadEnter"!=e.code||enterToTab(row,input,max_idx)>max_idx&&(next_tr.classList.contains("has-input")?goto_tabindex(next_tr,1):goto_tabindex(row,1))}(e,input_row,input,next_tr,max_n),function(event,row,input){var e=event||window.event;if("ArrowLeft"==e.code){if(0==input.selectionStart){let tabindex=input.getAttribute("idx");goto_tabindex(row,--tabindex)}}else if("ArrowRight"==e.code&&input.selectionEnd==input.value.length){let tabindex=input.getAttribute("idx");goto_tabindex(row,++tabindex)}}(e,input_row,input)})),input_row}function sum_records(){let all_input=document.querySelectorAll(".has-input"),num=0;for(let i=0;i<all_input.length;i++)""==all_input[i].querySelector("td:nth-child(3)").textContent.trim()&&""==all_input[i].querySelector("td:nth-child(2) input").value.trim()||num++;input_data.change_func&&input_data.change_func(),document.querySelector("#total-records").innerHTML=num}function rebuild_index(){let all_input=document.querySelectorAll(".has-input");for(let i=0;i<all_input.length;i++)all_input[i].querySelector("td:nth-child(1)").textContent=i+1}function keep_up(){document.querySelectorAll(".table-items tbody tr").length>input_data.lines?document.querySelector(".table-items thead").style.width="calc(100% - 1.07em)":document.querySelector(".table-items thead").style.width="100%"}function remove_inputting(){let all_has_input=document.querySelectorAll(".has-input");for(let input of all_has_input)input.classList.remove("inputting")}function element_position(element,add_x,add_y){if(element.querySelector(".autocomplete").classList.contains("auto-edit"))return!1;let tbody=document.querySelector(".table-items tbody"),x=getLeft(element,tbody),y=getTop(element,tbody),auto_div=element.querySelector(".autocomplete");auto_div.style.left=x+add_x+"px",auto_div.style.top=y+add_y+"px",element.querySelector(".autocomplete").classList.add("auto-edit")}document.querySelector("#modal-sumit-button").addEventListener("click",(function(e){if("选择商品"==document.querySelector(".modal-title").textContent){e.stopImmediatePropagation();let selected_row=document.querySelector("table .focus");if(selected_row){let id=selected_row.querySelector(".id").textContent,name=selected_row.querySelector(".名称").textContent,cz=selected_row.querySelector(".材质").textContent,gg=selected_row.querySelector(".规格").textContent,zt=selected_row.querySelector(".状态").textContent,zx=selected_row.querySelector(".执行标准").textContent,data=`${id}${SPLITER}${cz}${SPLITER}${gg}${SPLITER}${zt}${SPLITER}${zx}`,el=document.querySelector(".table-items .inputting .名称");el.value=name,el.setAttribute("data",data),close_modal(),input_data.auto_data[0].cb()}else notifier.show("请先选择再提交","danger")}}),!1),modal_init();return{input_table_outdata:function(){return input_table_outdata},build_blank_table:function(data){Object.assign(input_data,data);build_blank_th();let tbody=input_data.container.querySelector("tbody"),rows="";for(let i=0;i<input_data.lines;i++)rows+=input_data.blank_row;tbody.innerHTML=rows,tbody.style.height=33*input_data.lines+"px"},build_out_table:function(data){Object.assign(input_data,data);let tbody=input_data.container.querySelector("tbody"),trs=tbody.querySelectorAll("tr");for(let tr of trs)tr.classList.contains("has-input")||tr.parentNode.removeChild(tr);let num=tbody.querySelectorAll(".has-input").length+1,n=input_data.num?input_data.num:1;for(let i=0;i<n;i++){"function"==typeof input_data.show_names_fn&&input_data.show_names_fn(i);let input_row=build_input_row(input_data.show_names,all_width,num);tbody.appendChild(input_row),num+=1}append_blanks(tbody,num)},appand_edit_row:function(){let tbody=input_data.container.querySelector("tbody"),trs=tbody.querySelectorAll("tr");for(let tr of trs)tr.classList.contains("has-input")||tr.parentNode.removeChild(tr);for(let i in input_data.show_names)input_data.show_names[i].value=input_data.show_names[i].default?input_data.show_names[i].default:"";let num=tbody.querySelectorAll(".has-input").length+1,input_row=build_input_row(input_data.show_names,all_width,num);return tbody.appendChild(input_row),num+=1,append_blanks(tbody,num),input_row},build_items_table:function(data){Object.assign(input_data,data);build_blank_th();let tbody=input_data.container.querySelector("tbody"),num=1;for(let row of input_data.rows){let row_data=row.split(SPLITER);for(let i=1;i<input_data.show_names.length;i++)input_data.show_names[i].value=row_data[i-1];let input_row=build_input_row(input_data.show_names,all_width,num);tbody.appendChild(input_row),num+=1}tbody.style.height=33*input_data.lines+"px",append_blanks(tbody,num),"function"==typeof input_data.change_func&&input_data.change_func()}}}();var tool_customer=function(){var customer_data={input:document.querySelector("#supplier-input"),button:document.querySelector("#supplier-serach"),auto_url:"/customer_auto",cate:document.querySelector("#customer-suplier"),info:document.querySelector("#supplier-info")},out_data={};function customer_table_row(tr){let rec=tr.split(SPLITER),row=`<tr><td style="text-align: center;">${rec[1]}</td><td hidden>${rec[0]}</td>`;return service.build_row_from_string(rec,row,out_data.customer_table_fields)}function customer_blank_row(){return service.build_blank_from_fields("<tr><td></td><td hidden></td>",out_data.customer_table_fields)}function row_dbclick(table){let rows=table.querySelectorAll("body tr");for(let row of rows)row.addEventListener("dblclick",(function(){chose_exit(this)}))}function chose_exit(selected_row){let id=selected_row.children[1].textContent;if(id){let name=selected_row.children[2].textContent,supplier=document.querySelector("#supplier-input");supplier.value=name,supplier.setAttribute("data",id),close_modal()}else notifier.show("请先选择记录","danger")}return{customer_init:function(data){Object.assign(customer_data,data),new AutoInput(customer_data.input,customer_data.cate,customer_data.auto_url,(()=>{})).init(),modal_init(),customer_data.button.addEventListener("click",(function(){if(!document.querySelector("#customer-show")){let width=.8*document.querySelector("body").clientWidth,height=.8*document.querySelector("body").clientHeight,customer_height=height-270,html=`<div id="customer-show">\n                    <div class="table-top">\n                        <div class="autocomplete customer-search">\n                            <input type="text" class="form-control search-input" id="search-input" placeholder="${customer_data.cate.textContent}搜索">\n                            <button class="btn btn-info btn-sm" id="serach-button">搜索</button>\n                        </div>\n                    </div>\n\n                    <div class="table-container table-customer">\n                        <table>\n                            <thead>\n                                <tr></tr>\n                            </thead>\n                            <tbody>\n                            </tbody>\n                        </table>\n                        <div class="table-ctrl">\n                            <div class="tools-button"></div>\n                            <div class="table-button">\n                                <button class="page-button btn" id="first" title="首页"><img src="/assets/img/backward.png"\n                                        width="12px"></button>\n                                <button class="page-button btn" id="pre" title="前一页"><img src="/assets/img/backward2.png"\n                                        width="12px"></button>\n                                <p class="seperator"></p>\n                                <span>第</span><input type="text" class="form-control" id="page-input" value="1">\n                                <span>页，共</span><span id="pages"></span><span>页</span>\n                                <p class="seperator"></p>\n                                <button class="page-button btn" id="aft" title="后一页"><img src="/assets/img/forward2.png"\n                                        width="12px"></button>\n                                <button class="page-button btn" id="last" title="尾页"><img src="/assets/img/forward.png"\n                                        width="12px"></button>\n                            </div>\n\n                            <div class="table-info">\n                                共 <span id="total-records"></span> 条记录\n                            </div>\n\n                        </div>\n                    </div>\n                </div>`;document.querySelector(".modal-body").innerHTML=html,fetch("/fetch_inout_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(customer_data.cate.textContent)}).then((response=>response.json())).then((content=>{out_data.customer_table_fields=content;let table=document.querySelector(".table-customer"),da=service.build_table_header(table,[{name:"序号",width:3}],content,"","customers");table.querySelector("thead tr").innerHTML=da.th_row;let init_data={container:".table-customer",url:"/fetch_inout_customer",header_names:da.header_names,post_data:{id:"",name:"",sort:"名称 ASC",rec:Math.floor(customer_height/30),cate:customer_data.cate.textContent},edit:!1,row_fn:customer_table_row,blank_row_fn:customer_blank_row};tool_table.table_init(init_data),tool_table.fetch_table((()=>{row_dbclick(table)}))})),document.querySelector("#serach-button").onclick=function(){!function(){let table=document.querySelector(".table-customer"),search=document.querySelector("#search-input").value;Object.assign(table_data.post_data,{name:search,page:1}),tool_table.fetch_table((()=>{row_dbclick(table)}))}()},document.querySelector(".modal-title").textContent=`选择${customer_data.cate.textContent}`,document.querySelector(".modal-dialog").style.cssText=`max-width: ${width}px; height: ${height}px;`,document.querySelector(".modal-content").style.cssText="height: 100%;"}document.querySelector(".modal").style.display="block"})),document.querySelector("#modal-sumit-button").addEventListener("click",(function(e){let cate=document.querySelector(".modal-title").textContent;if("选择客户"==cate||"选择供应商"==cate){let selected_row=document.querySelector("table .focus");selected_row?chose_exit(selected_row):notifier.show("请先选择再提交","danger")}}),!1)}}}();