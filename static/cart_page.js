let page_cart=function(){if(!getCookie("wxok"))return void(window.location.href="/");let cartData={items:[],total_count:0,total_length:0,total_weight:0},currentDeleteItem=null,isLoading=!1;const lang=localStorage.getItem("language")||"zh",texts={zh:{cartTitle:"购物车",totalItems:"商品总数：",totalLength:"总长度：",totalWeight:"总重量：",submitOrder:"提交订购",clearCart:"清空购物车",refresh:"刷新",confirmDelete:"确认删除",confirmDeleteMsg:"确定要从购物车中删除这个商品吗？",confirmClear:"确认清空",confirmClearMsg:"确定要清空整个购物车吗？此操作不可撤销。",confirmSubmit:"确认提交订单",confirmSubmitMsg:"确定要提交这个订单吗？",orderSuccess:"订单提交成功",orderSuccessMsg:"您的订单已成功提交！",orderNumber:"订单号：",orderTime:"提交时间：",cancel:"取消",delete:"删除",clear:"清空",confirm:"确定",loading:"加载中...",noItems:"购物车为空",networkError:"网络连接失败",serverError:"服务器错误",operationSuccess:"操作成功",operationFailed:"操作失败",stockInsufficient:"库存不足",quantityUpdated:"数量已更新",itemRemoved:"商品已删除",cartCleared:"购物车已清空",orderSubmitted:"订单已提交"},en:{cartTitle:"Shopping Cart",totalItems:"Total Items:",totalLength:"Total Length:",totalWeight:"Total Weight:",submitOrder:"Submit Order",clearCart:"Clear Cart",refresh:"Refresh",confirmDelete:"Confirm Delete",confirmDeleteMsg:"Are you sure you want to remove this item from cart?",confirmClear:"Confirm Clear",confirmClearMsg:"Are you sure you want to clear the entire cart? This action cannot be undone.",confirmSubmit:"Confirm Submit Order",confirmSubmitMsg:"Are you sure you want to submit this order?",orderSuccess:"Order Submitted Successfully",orderSuccessMsg:"Your order has been submitted successfully!",orderNumber:"Order Number:",orderTime:"Submit Time:",cancel:"Cancel",delete:"Delete",clear:"Clear",confirm:"Confirm",loading:"Loading...",noItems:"Cart is empty",networkError:"Network connection failed",serverError:"Server error",operationSuccess:"Operation successful",operationFailed:"Operation failed",stockInsufficient:"Insufficient stock",quantityUpdated:"Quantity updated",itemRemoved:"Item removed",cartCleared:"Cart cleared",orderSubmitted:"Order submitted"}};function initPage(){document.title=texts[lang].cartTitle,document.getElementById("refresh-cart-btn").addEventListener("click",(()=>{loadCartData()})),document.getElementById("clear-cart-btn").addEventListener("click",(()=>{document.getElementById("confirm-clear-modal").style.display="block"})),document.getElementById("submit-order-btn").addEventListener("click",(()=>{0!==cartData.items.length?(document.getElementById("submit-total-items").textContent=cartData.total_count||0,document.getElementById("submit-total-length").textContent=`${cartData.total_length||0} mm`,document.getElementById("submit-total-weight").textContent=`${(cartData.total_weight||0).toFixed(2)} kg`,document.getElementById("confirm-submit-modal").style.display="block"):notifier.show(texts[lang].noItems,"warning",3e3)})),document.getElementById("cancel-delete").addEventListener("click",(()=>{hideDeleteConfirmModal()})),document.getElementById("confirm-delete").addEventListener("click",(()=>{currentDeleteItem&&async function(materialNumber){if(!isLoading)try{hideDeleteConfirmModal();const response=await fetch("/stock/remove_from_cart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:Number(document.querySelector("#user-id").textContent.trim()),material_number:materialNumber})});if(response.ok){const result=await response.json();if(result.success){const currentCount=cartData.total_count||0;currentCount>1?function(newCount){const cartBadge=document.querySelector("#cart-count");cartBadge&&(cartBadge.classList.add("cart-count-animate"),setTimeout((()=>{newCount>0?cartBadge.textContent=newCount:cartBadge.style.display="none"}),150),setTimeout((()=>{cartBadge.classList.remove("cart-count-animate")}),600))}(currentCount-1):animateCartBadgeClear(),setTimeout((async()=>{await loadCartData()}),200),notifier.show(texts[lang].itemRemoved,"success",2e3)}else notifier.show(result.message||texts[lang].operationFailed,"danger",4e3)}else console.error("Remove item failed with status:",response.status),notifier.show(texts[lang].serverError,"danger",4e3)}catch(error){console.error("Error removing item:",error),notifier.show(texts[lang].networkError,"danger",4e3)}}(currentDeleteItem)})),document.getElementById("close-delete-modal").addEventListener("click",(()=>{hideDeleteConfirmModal()})),document.getElementById("cancel-clear").addEventListener("click",(()=>{hideClearConfirmModal()})),document.getElementById("confirm-clear").addEventListener("click",(()=>{!async function(){if(!isLoading)try{hideClearConfirmModal();const response=await fetch("/stock/clear_cart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:Number(document.querySelector("#user-id").textContent.trim())})});if(response.ok){const result=await response.json();result.success?(animateCartBadgeClear(),setTimeout((async()=>{await loadCartData()}),350),notifier.show(texts[lang].cartCleared,"success",2e3)):notifier.show(result.message||texts[lang].operationFailed,"danger",4e3)}else console.error("Clear cart failed with status:",response.status),notifier.show(texts[lang].serverError,"danger",4e3)}catch(error){console.error("Error clearing cart:",error),notifier.show(texts[lang].networkError,"danger",4e3)}}()})),document.getElementById("close-clear-modal").addEventListener("click",(()=>{hideClearConfirmModal()})),document.getElementById("cancel-submit").addEventListener("click",(()=>{hideSubmitConfirmModal()})),document.getElementById("confirm-submit").addEventListener("click",(()=>{!async function(){var orderId;if(!isLoading)try{isLoading=!0,hideSubmitConfirmModal(),showLoadingState();const orderItems=cartData.items.map((item=>({material_number:item.material_number}))),response=await fetch("/stock/submit_order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:Number(document.querySelector("#user-id").textContent.trim()),items:orderItems})});if(response.ok){const result=await response.json();result.success?(animateCartBadgeClear(),orderId=result.order_id,document.getElementById("order-number").textContent=orderId,document.getElementById("order-time").textContent=(new Date).toLocaleString(),document.getElementById("order-success-modal").style.display="block",notifier.show(texts[lang].orderSubmitted,"success",3e3),setTimeout((async()=>{await loadCartData()}),350)):notifier.show(result.message||texts[lang].operationFailed,"danger",4e3)}else notifier.show(texts[lang].serverError,"danger",4e3)}catch(error){console.error("Error submitting order:",error),notifier.show(texts[lang].networkError,"danger",4e3)}finally{isLoading=!1}}()})),document.getElementById("close-submit-modal").addEventListener("click",(()=>{hideSubmitConfirmModal()})),document.getElementById("close-success-modal").addEventListener("click",(()=>{hideOrderSuccessModal()})),document.getElementById("close-success").addEventListener("click",(()=>{hideOrderSuccessModal()})),document.addEventListener("click",(e=>{e.target.classList.contains("modal")&&hideAllModals()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&hideAllModals()})),loadCartData(),function(){const cartBadge=document.querySelector("#cart-count");cartBadge&&"none"===cartBadge.style.display&&setTimeout((()=>{cartData.total_count>0&&updateCartBadge(cartData.total_count)}),100)}()}async function loadCartData(){if(!isLoading)try{isLoading=!0,showLoadingState();const response=await fetch("/stock/get_cart_detail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:Number(document.querySelector("#user-id").textContent.trim())})});if(response.ok){const data=await response.json();cartData=data,function(){const tbody=document.getElementById("cart-items-tbody");if(0===cartData.items.length)return void(tbody.innerHTML=`\n                <tr>\n                    <td colspan="12" class="empty-cart">\n                        <div class="empty-cart-content">\n                            <i class="fa fa-shopping-cart"></i>\n                            <p>${texts[lang].noItems}</p>\n                        </div>\n                    </td>\n                </tr>\n            `);let html="";cartData.items.forEach(((item,index)=>{html+=`\n                <tr data-material="${item.material_number}">\n                    <td width="4%">${index+1}</td>\n                    <td>${item.product_name}</td>\n                    <td>${item.material_number}</td>\n                    <td>${item.specification}</td>\n                    <td>${item.status}</td>\n                    <td width="15%">${item.standard}</td>\n                    <td>${item.manufacturer}</td>\n                    <td>${item.heat_number}</td>\n                    <td>${item.stock_length}</td>\n                    <td>${item.stock_weight.toFixed(2)}</td>\n                    <td width="12%">${item.added_at}</td>\n                    <td>\n                        <button class="btn btn-sm btn-danger" \n                                onclick="showDeleteConfirmModal('${item.material_number}', '${item.product_name}', '${item.specification}')">\n                            <i class="fa fa-trash"></i>\n                            删除\n                        </button>\n                    </td>\n                </tr>\n            `})),tbody.innerHTML=html,fixTableHeaderAlignment()}(),document.getElementById("total-items").textContent=cartData.total_count||0,document.getElementById("total-length").textContent=`${cartData.total_length||0} mm`,document.getElementById("total-weight").textContent=`${(cartData.total_weight||0).toFixed(2)} kg`,updateCartBadge(cartData.total_count||0),updateCartBadge(cartData.total_count||0)}else console.error("Failed to load cart data:",response.status),notifier.show(texts[lang].serverError,"danger",4e3)}catch(error){console.error("Error loading cart data:",error),notifier.show(texts[lang].networkError,"danger",4e3)}finally{isLoading=!1}}function fixTableHeaderAlignment(){const table=document.querySelector(".table-cart table"),thead=table.querySelector("thead"),tbody=table.querySelector("tbody");if(!thead||!tbody)return;const scrollbarWidth=tbody.offsetWidth-tbody.clientWidth;thead.style.width=scrollbarWidth>0?`calc(100% - ${scrollbarWidth}px)`:"100%";new ResizeObserver((()=>{const newScrollbarWidth=tbody.offsetWidth-tbody.clientWidth;thead.style.width=newScrollbarWidth>0?`calc(100% - ${newScrollbarWidth}px)`:"100%"})).observe(tbody)}function hideDeleteConfirmModal(){document.getElementById("confirm-delete-modal").style.display="none",currentDeleteItem=null}function hideClearConfirmModal(){document.getElementById("confirm-clear-modal").style.display="none"}function hideOrderSuccessModal(){document.getElementById("order-success-modal").style.display="none"}function hideSubmitConfirmModal(){document.getElementById("confirm-submit-modal").style.display="none"}function hideAllModals(){hideDeleteConfirmModal(),hideClearConfirmModal(),hideSubmitConfirmModal(),hideOrderSuccessModal()}function updateCartBadge(count){const cartBadge=document.querySelector("#cart-count");cartBadge&&(count>0?(cartBadge.textContent=count,cartBadge.style.display="flex"):cartBadge.style.display="none")}function animateCartBadgeClear(){const cartBadge=document.querySelector("#cart-count");cartBadge&&(cartBadge.classList.add("cart-count-clear"),setTimeout((()=>{cartBadge.style.display="none",cartBadge.classList.remove("cart-count-clear")}),300))}function showLoadingState(){document.getElementById("cart-items-tbody").innerHTML=`\n            <tr>\n                <td colspan="12" class="loading-state">\n                    <div class="loading-content">\n                        <i class="fa fa-spinner fa-spin"></i>\n                        <p>${texts[lang].loading}</p>\n                    </div>\n                </td>\n            </tr>\n        `}window.showDeleteConfirmModal=function(materialNumber,productName,productSize){currentDeleteItem=materialNumber,document.getElementById("delete-item-info").innerHTML=`\n            <div class="item-details">\n                <strong>商品名称：</strong>${productName}<br>\n                <strong>规格型号：</strong>${productSize}<br>\n                <strong>物料号：</strong>${materialNumber}\n            </div>\n        `,document.getElementById("confirm-delete-modal").style.display="block"},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initPage):initPage(),window.addEventListener("resize",(()=>{setTimeout(fixTableHeaderAlignment,100)}))}();