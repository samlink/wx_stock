let page_buyin=function(){let document_table_fields,table_lines,show_names,edited,auto_data,document_name,edit_data,document_bz=document.querySelector("#document-bz").textContent.trim(),dh_div=document.querySelector("#dh");if(-1!=document_bz.indexOf("销售")?document_name="销售单据":-1!=document_bz.indexOf("采购")&&(document_name="采购单据"),"商品销售"==document_bz){document.querySelectorAll(".buy-buttons .buttons button").forEach((button=>{button.classList.add("ch-width")}))}function document_top_handle(html,has_date){"采购退货"==document_bz?html=(html=html.replace("到货","发货")).replace("入库完成</label>","处理完成</label>"):"销售退货"==document_bz&&(html=(html=html.replace("交货","收货")).replace("出库完成</label>","入库完成</label>")),document.querySelector(".has-auto")?document.querySelector(".has-auto").insertAdjacentHTML("afterend",html):document.querySelector(".fields-show").innerHTML=html;let date=document.querySelector("#日期");if(has_date||(date.value=(new Date).Format("yyyy-MM-dd")),laydate.render({elem:date,showBottom:!1}),document.querySelector("#文本字段2")){let da=document.querySelector("#文本字段2");laydate.render({elem:da,showBottom:!1})}if(document.querySelector("#文本字段3")){let da=document.querySelector("#文本字段3");laydate.render({elem:da,showBottom:!1})}let all_input=document.querySelectorAll(".fields-show input"),form=document.querySelector(".fields-show");set_key_move(all_input,form,all_input.length-1),service.set_sumit_shen(),document.querySelector("#sumit-shen").addEventListener("click",(function(){let shen_data={button:this,dh:dh_div.textContent,document_name:document_name,edited:edited||edit_table.input_table_outdata().edited};service.sumit_shen(shen_data)}))}function calculate(input_row){input_row.querySelector(".规格")&&input_row.querySelector(".规格").addEventListener("blur",(function(){calc_weight(input_row),calc_money(input_row),sum_money()})),input_row.querySelector(".price")&&(input_row.querySelector(".price").addEventListener("blur",(function(){calc_money(input_row),sum_money()})),input_row.querySelector(".mount").addEventListener("blur",(function(){calc_money(input_row),sum_money()}))),input_row.querySelector(".long")&&(input_row.querySelector(".long").addEventListener("blur",(function(){calc_weight(input_row),calc_money(input_row),sum_money()})),input_row.querySelector(".num").addEventListener("blur",(function(){calc_weight(input_row),calc_money(input_row),sum_money()})))}function calc_money(input_row){let price=input_row.querySelector(".price").value,mount=input_row.querySelector(".mount").value;mount||(mount=input_row.querySelector(".mount").textContent);let money="";price&&regReal.test(price)&&mount&&regReal.test(mount)&&(money="--"!=input_row.querySelector(".材质").textContent.trim()?(price*mount).toFixed(2):(price*input_row.querySelector(".num").value).toFixed(2)),input_row.querySelector(".money").textContent=money}function sum_money(){let all_input=document.querySelectorAll(".has-input"),sum=0,sum_n=0,sum_weight=0,sum_weight_s=0;for(let i=0;i<all_input.length;i++){let price=all_input[i].querySelector(".price").value,mount=all_input[i].querySelector(".mount").value,n="销售单据"==document_name?Number(all_input[i].querySelector(".num").value):0,weight_s="销售单据"==document_name?Number(all_input[i].querySelector(".weight").value):0;mount||(mount=all_input[i].querySelector(".mount").textContent),""!=all_input[i].querySelector("td:nth-child(2) .auto-input").value&&price&&regReal.test(price)&&mount&&regReal.test(mount)&&("--"!=all_input[i].querySelector(".材质").textContent.trim()?sum+=price*mount:sum+=price*all_input[i].querySelector(".num").value,sum_n+=n,sum_weight+=Number(mount),sum_weight_s+=weight_s)}document.querySelector("#sum-money").innerHTML="销售单据"==document_name?`数量：${sum_n}，  理论重量：${sum_weight.toFixed(1)} kg，  实际重量：${sum_weight_s.toFixed(1)} kg， 金额合计：${sum.toFixed(2)} 元`:`重量：${sum_weight.toFixed(1)} kg， 金额合计：${sum.toFixed(2)} 元`,document.querySelector("#应结金额")&&(document.querySelector("#应结金额").value=sum.toFixed(2))}function calc_weight(input_row){let data={long:input_row.querySelector(".long").value,num:input_row.querySelector(".num").value,name:input_row.querySelector(".auto-input").value,cz:input_row.querySelector(".材质").textContent.trim(),gg:input_row.querySelector(".规格").textContent.trim()};regInt.test(data.long)&&regInt.test(data.num)&&"--"!=input_row.querySelector(".材质").textContent.trim()?input_row.querySelector(".mount").value=service.calc_weight(data):input_row.querySelector(".mount").value=0}function fill_gg(){let field_values=document.querySelector(".inputting .auto-input").getAttribute("data").split(SPLITER),n=3,num="销售单据"==document_name?5:4;for(let i=2;i<2+num;i++){let val=field_values[i];if("普通输入"!=show_names[i].type&&"autocomplete"!=show_names[i].type||!show_names[i].editable?"普通输入"!=show_names[i].type||show_names[i].editable?"下拉列表"==show_names[i].type&&show_names[i].editable?document.querySelector(`.inputting td:nth-child(${n}) select`).value=val:"下拉列表"!=show_names[i].type||show_names[i].editable||(document.querySelector(`.inputting td:nth-child(${n})`).textContent=val):document.querySelector(`.inputting td:nth-child(${n})`).textContent=val:document.querySelector(`.inputting td:nth-child(${n}) input`).value=val,"销售单据"==document_name){document.querySelector(".inputting td:nth-child(15)").textContent=field_values[7],document.querySelector(".inputting td:nth-child(14)").textContent=field_values[0],calc_weight(document.querySelector(".table-items .inputting"))}else document.querySelector(".inputting td:nth-child(12)").textContent=field_values[0];n++}document.querySelector(".inputting .price").focus(),edit_table.appand_edit_row(),edited=!0}fetch("/fetch_inout_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(document_name)}).then((response=>response.json())).then((content=>{if(-1!=content){if(document_table_fields=content,"新单据"!=dh_div.textContent)fetch("/fetch_document",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:document_name,dh:dh_div.textContent})}).then((response=>response.json())).then((data=>{document_top_handle(service.build_inout_form(document_table_fields,data),!0);let values=data.split(SPLITER),len=values.length,customer=document.querySelector("#supplier-input");customer.value=values[len-3],customer.setAttribute("data",values[len-4]);let set_data={content:data,readonly_fun:set_readonly,focus_fun:()=>{setTimeout((()=>{document.querySelector(".table-items tbody .名称").focus()}),200)}};service.set_shens_owner(set_data)})),fetch("/fetch_other_documents",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(dh_div.textContent)}).then((response=>response.json())).then((data=>{let tr="";data.forEach((obj=>{tr+=`<tr><td>${obj}</td></tr>`})),document.querySelector(".table-history tbody").innerHTML=tr;let trs=document.querySelectorAll(".table-history tbody tr");for(let tr of trs)tr.addEventListener("click",(function(){let url,cate=tr.querySelector("td").textContent.split("　")[0];url=-1!=cate.indexOf("出库")?"/material_out/":-1!=cate.indexOf("发货")?"/transport/":-1!=cate.indexOf("开票")?"/kp/":"/material_in/",window.open(url+tr.querySelector("td").textContent.split("　")[1])}))}));else{document_top_handle(service.build_inout_form(content),!1),document.querySelector("#remember-button").textContent="审核",setTimeout((()=>{document.querySelector(".table-items tbody .名称").focus()}),200)}!function(){if("销售退货"==document_bz){document.querySelector(".table-note").style.display="block",document.querySelector(".table-history").style.marginLeft=0,document.querySelector(".table-history").style.borderBottomLeftRadius=0,document.querySelector(".table-history").style.borderBottomRightRadius=0;let ht=document.querySelector("#文本字段6");ht.addEventListener("blur",(function(){""!=ht.value&&fetch("/get_sale_dh",{method:"post",headers:{"Content-Type":"application/json"},body:ht.value.trim()}).then((response=>response.json())).then((data=>{document.querySelector(".table-note tbody").innerHTML=`<tr><td>${data}</td></tr>`;let tr=document.querySelector(".table-note tbody tr");tr.addEventListener("click",(function(){window.open("/sale/"+tr.querySelector("td").textContent.split("　")[1])}))}))}))}}()}})),document.querySelector("#supplier-input")&&tool_customer.customer_init(),fetch("/fetch_inout_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify("商品规格")}).then((response=>response.json())).then((content=>{show_names=[{name:"序号",width:40,class:"序号",type:"普通输入",editable:!1,is_save:!1,default:1},{name:"名称",width:80,class:"名称",type:"autocomplete",editable:!0,is_save:!0,save:"id",default:""},{name:"材质",width:100,class:"材质",type:"普通输入",editable:!1,is_save:!1,default:""}];for(let item of content){let edit="销售单据"!=document_name;show_names.push({name:item.show_name,width:18*item.show_width,type:item.ctr_type,class:item.show_name,editable:edit,is_save:!0,default:item.option_value})}"销售单据"==document_name?(show_names.push({name:"单价",width:50,class:"price",type:"普通输入",editable:!0,is_save:!0,default:""}),show_names.push({name:"长度",width:60,class:"long",type:"普通输入",editable:!0,is_save:!0,default:""}),show_names.push({name:"数量",width:50,class:"num",type:"普通输入",editable:!0,is_save:!0,default:""}),show_names.push({name:"理论重量",width:60,class:"mount",type:"普通输入",editable:!0,is_save:!0,default:""}),show_names.push({name:"实际重量",width:60,class:"weight",type:"普通输入",editable:!0,is_save:!0,default:""})):"采购单据"==document_name&&(show_names.push({name:"单价",width:60,class:"price",type:"普通输入",editable:!0,is_save:!0,default:""}),show_names.push({name:"长度",width:60,class:"长度",type:"普通输入",editable:!0,is_save:!0,default:""}),show_names.push({name:"重量",width:60,class:"mount",type:"普通输入",editable:!0,is_save:!0,default:""})),show_names.push({name:"金额",width:80,class:"money",type:"普通输入",editable:!1,is_save:!1,default:""}),show_names.push({name:"备注",width:100,class:"note",type:"普通输入",editable:!0,is_save:!0,default:"",css:'style="border-right:none"'}),show_names.push({name:"",width:0,class:"m_id",type:"普通输入",editable:!1,is_save:!0,css:'style="width:0%; border-left:none;border-right:none; color:white"'}),show_names.push({name:"",width:0,class:"m_num",type:"普通输入",editable:!1,is_save:!1,css:'style="width:0%; border-left:none; color:white"'}),show_names.forEach((item=>{"采购单据"!=document_name||"状态"!=item.name&&"执行标准"!=item.name||(item.type="autocomplete",item.no_button=!0,item.save="value")})),table_lines=Math.floor((document.querySelector("body").clientHeight-395)/33);let show_th=[{name:"名称",width:60},{name:"材质",width:80},{name:"规格",width:80},{name:"状态",width:100},{name:"执行标准",width:100},{name:"售价",width:60},{name:"库存长度",width:80},{name:"库存重量",width:80}];if(auto_data="销售单据"==document_name?[{n:2,cate:document_name,auto_url:"/buyin_auto",show_th:show_th,type:"table",cb:fill_gg}]:[{n:2,cate:document_name,auto_url:"/buyin_auto",show_th:show_th,type:"table",cb:fill_gg},{n:5,cate:"状态",auto_url:"/get_status_auto",type:"simple",width:230},{n:6,cate:"执行标准",auto_url:"/get_status_auto",type:"simple",width:300}],"新单据"==dh_div.textContent)edit_data={show_names:show_names,lines:table_lines,auto_data:auto_data,dh:dh_div.textContent,calc_func:calculate,del_func:sum_money},edit_table.build_blank_table(edit_data),edit_table.appand_edit_row();else{fetch("销售单据"==document_name?"/fetch_document_items_sales":"/fetch_document_items",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({cate:document_name,dh:dh_div.textContent})}).then((response=>response.json())).then((content=>{edit_data={show_names:show_names,rows:content,auto_data:auto_data,lines:table_lines,dh:dh_div.textContent,document:document_name,calc_func:calculate,change_func:sum_money},edit_table.build_items_table(edit_data),setTimeout((()=>{"审核"==document.querySelector("#remember-button").textContent.trim()&&edit_table.appand_edit_row()}),200)}))}}));let has_chose=new Map,choose_button=document.querySelector("#choose-button");function choose_it(){document.querySelector("#product-id").textContent.trim()&&document.querySelectorAll(".table-product tbody tr").forEach((row=>{let wu_num=row.querySelector("td:nth-child(2)").textContent.trim();if(""!=wu_num){let check=has_chose.has(wu_num)?"checked":"";row.querySelector("td:nth-child(1)").innerHTML=`<label class="check-radio fields-set">\n            <input type="checkbox" class="has-choosed" ${check}><span class="checkmark"></span></label>`,row.querySelector(".has-choosed").addEventListener("click",(function(){let wu_num=row.querySelector("td:nth-child(2)").textContent.trim();if(this.checked){let cols=row.querySelectorAll("td"),规格=cols[3].textContent,状态=cols[4].textContent,标准=cols[5].textContent,单价=cols[8].textContent,长度=cols[11].textContent,理重=cols[12].textContent,名称=row.querySelector(".名称").textContent,p_id=row.querySelector(".商品id").textContent,na=名称.split(" ");has_chose.set(wu_num,`${na[1]}${SPLITER}${na[0]}${SPLITER}${规格}${SPLITER}${状态}${SPLITER}${标准}${SPLITER}${单价}${SPLITER}${长度}${SPLITER}1${SPLITER}${理重}${SPLITER}0${SPLITER}${(单价*理重).toFixed(2)}${SPLITER}${wu_num}${SPLITER}${p_id}`)}else has_chose.delete(wu_num)}))}}))}function save(){let customer_id=document.querySelector("#supplier-input").getAttribute("data"),all_values=document.querySelectorAll(".document-value"),user_name=document.querySelector("#user-name").textContent.split("　")[1],save_str=`${document_bz}${SPLITER}${dh_div.textContent}${SPLITER}${customer_id}${SPLITER}${user_name}${SPLITER}`;save_str+=service.build_save_header(all_values,document_table_fields);let table_data=[],all_rows=document.querySelectorAll(".table-items .has-input");for(let row of all_rows)if(""!=row.querySelector("td:nth-child(2) input").value){let save_str="销售单据"==document_name?`${row.querySelector("td:nth-child(14)").textContent.trim()}${SPLITER}`:`${row.querySelector("td:nth-child(12)").textContent.trim()}${SPLITER}`;save_str+=service.build_save_items(2,row,show_names),table_data.push(save_str)}let data={rights:document_bz,document:save_str,remember:document.querySelector("#remember-button").textContent,items:table_data};fetch("/save_document",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{-1!=content?(dh_div.textContent=content,notifier.show("单据保存成功","success"),edited=!1,edit_table.input_table_outdata().edited=!1):notifier.show("权限不够，操作失败","danger")}))}function set_readonly(){let all_edit=document.querySelectorAll(".fields-show input");for(let edit of all_edit)("采购单据"!=document_name||"入库完成"!=edit.id&&"备注"!=edit.id)&&("销售单据"!=document_name||"是否欠款"!=edit.id&&"文本字段2"!=edit.id&&"出库完成"!=edit.id&&"发货完成"!=edit.id&&"文本字段5"!=edit.id&&"文本字段4"!=edit.id&&"备注"!=edit.id)&&(edit.disabled=!0);document.querySelector("#supplier-serach").disabled=!0,setTimeout((()=>{document.querySelectorAll(".table-items tbody input").forEach((input=>{input.classList.contains("备注")||input.classList.contains("note")||(input.disabled=!0)}))}),100),service.edit_button_disabled();let choose_button=document.querySelector("#choose-button");choose_button&&(choose_button.disabled=!0)}choose_button&&choose_button.addEventListener("click",(function(){service.sales_products("点选商品",choose_it)})),document.querySelector("#modal-sumit-button").addEventListener("click",(function(e){if("点选商品"==document.querySelector(".modal-title").textContent){e.stopImmediatePropagation();let content=[],rows=document.querySelectorAll(".table-items tbody tr");for(let[key,value]of has_chose){let values=value.split(SPLITER);for(let row of rows)if(""!=row.querySelector("td:nth-child(3)").textContent.trim()&&row.querySelector(".note").value.startsWith(values[11])){values[5]=row.querySelector(".price").value,values[9]=row.querySelector(".weight").value,values[10]=row.querySelector(".money").textContent,values[11]=row.querySelector(".note").value;break}value=values.join(SPLITER),content.push(value)}let edit_data={show_names:show_names,rows:content,auto_data:auto_data,lines:table_lines,document:document_name,calc_func:calculate,change_func:sum_money};document.querySelector(".table-items tbody").innerHTML="",edit_table.build_items_table(edit_data),setTimeout((()=>{"审核"==document.querySelector("#remember-button").textContent.trim()&&edit_table.appand_edit_row()}),200),close_modal(),document.querySelector(".table-items tbody .price").focus()}}),!1),document.querySelector("#save-button").addEventListener("click",(function(){if(!function(){if(null==document.querySelector("#supplier-input").getAttribute("data"))return notifier.show("客户或供应商不在库中","danger"),!1;if(document.querySelector("#文本字段6")&&""==document.querySelector("#文本字段6").value.trim())return notifier.show("合同编号不能为空","danger"),!1;let all_rows=document.querySelectorAll(".table-items .has-input");if(!service.header_error_check(document_table_fields,all_rows))return!1;for(let row of all_rows)if(""!=row.querySelector("td:nth-child(2) input").value){let mount=row.querySelector(".mount");if(row.querySelector(".price").value&&!regReal.test(row.querySelector(".price").value))return notifier.show("单价输入错误","danger"),!1;if(row.querySelector(".price").value||(row.querySelector(".price").value=0),mount.value&&!regReal.test(mount.value))return notifier.show("重量输入错误","danger"),!1;if(mount.value||(mount.value=0),row.querySelector(".long")){if(row.querySelector(".long").value&&!regReal.test(row.querySelector(".long").value))return notifier.show("长度输入错误","danger"),!1;if(row.querySelector(".long").value||(row.querySelector(".long").value=0),row.querySelector(".num").value&&!regReal.test(row.querySelector(".num").value))return notifier.show("数量输入错误","danger"),!1;if(row.querySelector(".num").value||(row.querySelector(".num").value=0),row.querySelector(".weight").value&&!regReal.test(row.querySelector(".weight").value))return notifier.show("实际重量输入错误","danger"),!1;""==row.querySelector(".weight").value.trim()&&(row.querySelector(".weight").value=0)}}return!0}())return!1;"销售单据"==document_name?service.check_ku(save):save()})),document.querySelector("#remember-button").addEventListener("click",(function(){let formal_data={button:this,dh:dh_div.textContent,document_name:document_name,edited:edited||edit_table.input_table_outdata().edited,readonly_fun:set_readonly};service.make_formal(formal_data)})),window.onbeforeunload=function(e){(edited||edit_table.input_table_outdata().edited)&&((e=window.event||e).returnValue="编辑未保存提醒")}}();