let page_documentquery=function(){let document_cate,table_fields,cate=document.querySelector("#category").textContent,limit=document.querySelector("#limit").textContent,get_height=getHeight()-168,row_num=Math.floor(get_height/30),sort="开单时间 DESC";"采购查询"==cate?document_cate="采购单据":"销售查询"==cate?document_cate="销售单据":"入库查询"==cate?document_cate="入库单据":"出库查询"==cate?document_cate="出库单据":"发货查询"==cate?(document_cate="发货单据",sort="日期 DESC, 开单时间 DESC"):"开票查询"==cate?document_cate="销售开票":"调入查询"==cate?document_cate="库存调入":"调出查询"==cate&&(document_cate="库存调出");let init_data={container:".table-documents",url:"/fetch_all_documents",post_data:{id:"",name:"",sort:sort,rec:row_num,cate:cate+" "+limit},edit:!1,blank_cells:20,row_fn:function(tr){let rec=tr.split(SPLITER),len=rec.length,border_left="";-1!=rec[2].indexOf("退")&&(border_left="has-border");let bk_color="";"否"==rec[len-2]&&(bk_color="not-confirm");"true"==rec[4]&&(bk_color="void");let row=`<tr class='${border_left} ${bk_color}'><td style="text-align: center;">${rec[0]}</td>\n        <td>${rec[1]}</td>\n        <td style="text-align: center;">${rec[2]}</td>\n        <td style="text-align: center;">${rec[3]}</td>`;-1==cate.indexOf("销售")&&-1==cate.indexOf("采购")&&(row=`<tr class='${border_left} ${bk_color}'><td style="text-align: center;">${rec[0]}</td>\n        <td title='${rec[1]}'>${rec[1]}</td>\n        <td style="text-align: center;">${rec[2]}</td>`);return service.build_row_from_string(rec,row,table_fields,5)}};function search_table(){let search=document.querySelector("#search-input").value;Object.assign(tool_table.table_data().post_data,{name:search,page:1}),tool_table.fetch_table(fei_restore)}function fei_restore(){let trs=document.querySelectorAll("tbody tr"),fei_button=document.querySelector("#fei-button");for(let i=0;i<trs.length;i++)trs[i].addEventListener("click",(function(){this.classList.contains("void")?(fei_button.textContent="恢复单据",fei_button.style.background="green"):(fei_button.textContent="作废单据",fei_button.style.background="#2574a9")}))}fetch("/fetch_show_fields",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(document_cate)}).then((response=>response.json())).then((content=>{if(-1!=content){table_fields=content;let custom_fields=[{name:"序号",field:"-",width:2},{name:"单号",field:"单号",width:7},{name:"类别",field:"documents.类别",width:4},{name:"销售查询"==cate?"客户":"供应商",field:"customers.名称",width:10}];-1==cate.indexOf("销售")&&-1==cate.indexOf("采购")&&(custom_fields=[{name:"序号",field:"-",width:2},{name:"单号",field:"单号",width:7},{name:"类别",field:"documents.类别",width:4}]);let table=document.querySelector(".table-documents"),data=service.build_table_header(table,custom_fields,table_fields,"","documents");table.querySelector("thead tr").innerHTML=data.th_row,init_data.header_names=data.header_names,tool_table.table_init(init_data),tool_table.fetch_table(fei_restore)}})),document.querySelector("#serach-button").addEventListener("click",(function(){search_table()})),document.querySelector("#edit-button").addEventListener("click",(function(){let chosed=document.querySelector("tbody .focus");if(chosed){let address,id=chosed.querySelector("td:nth-child(2)").textContent,cate=chosed.querySelector("td:nth-child(3)").textContent;"材料采购"==cate?address="/buy_in/":"采购退货"==cate?address="/buy_back/":"商品销售"==cate?address="/sale/":"销售退货"==cate?address="/saleback/":"采购入库"==cate?address="/material_in/":"销售出库"==cate?address="/material_out/":"运输发货"==cate?address="/transport/":"销售开票"==cate?address="/kp/":"调整入库"==cate?address="/stock_change_in/":"调整出库"==cate&&(address="/stock_change_out/"),window.open(address+id)}else notifier.show("请先选择单据","danger")}));let del_btn=document.querySelector("#del-button");del_btn&&del_btn.addEventListener("click",(function(){let chosed=document.querySelector("tbody .focus"),dh=chosed?chosed.querySelector("td:nth-child(2)").textContent:"",del={id:dh,rights:"删除单据",base:document.querySelector("#base").textContent};""!=dh?alert_confirm(`单据 ${dh} 删除后无法恢复，确认删除吗？`,{confirmCallBack:()=>{fetch("/documents_del",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(del)}).then((response=>response.json())).then((content=>{-1!=content?search_table():notifier.show("权限不够，操作失败","danger")}))}}):notifier.show("请先选择单据","danger")}));let fei_btn=document.querySelector("#fei-button");fei_btn&&fei_btn.addEventListener("click",(function(){let chosed=document.querySelector("tbody .focus"),dh=chosed?chosed.querySelector("td:nth-child(2)").textContent:"",base=document.querySelector("#base").textContent,action="作废单据"==this.textContent.trim()?"作废":"恢复",del={id:dh,rights:action,base:base};""!=dh?alert_confirm(`单据 ${dh} 确认${action}吗？`,{confirmCallBack:()=>{fetch("/documents_fei",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(del)}).then((response=>response.json())).then((content=>{-1!=content?search_table():notifier.show("权限不够，操作失败","danger")}))}}):notifier.show("请先选择单据","danger")}));let data_out=document.querySelector("#data-out");data_out&&data_out.addEventListener("click",(()=>{let dateTime=new Date,da=dateTime.setMonth(dateTime.getMonth()-3),da1=new Date(da).Format("yyyy-MM-dd"),da2=(new Date).Format("yyyy-MM-dd"),name=document.querySelector("#search-input").value,data=`${da1}${SPLITER}${da2}${SPLITER}${name}`;fetch("/trans_excel",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>response.json())).then((content=>{-1!=content?(download_file("/download/发货单表.xlsx"),notifier.show("成功导出至 Excel 文件","success")):notifier.show("权限不够，操作失败","danger")}))}))}();